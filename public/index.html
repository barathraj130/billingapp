<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing — JBS KNIT WEAR</title>

<style>
  /* ---------- Basic tokens ---------- */
  :root{
    --bg:#f3f5f7;
    --card:#fff;
    --muted:#7b8794;
    --accent:#1e90ff;
    --danger:#ff6b5c;
    --radius:12px;
    --gap:18px;
    --sidebar-w:260px;
    --max-w:1160px;
    --shadow: 0 10px 30px rgba(17,24,39,0.06);
    --mono: 'Helvetica Neue', Arial, sans-serif;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--mono);
    background:linear-gradient(180deg,#f5f7fa, var(--bg));
    color:#1f2933;
    -webkit-font-smoothing:antialiased;
  }
  .app{
    display:flex;
    min-height:100vh;
  }

  /* ---------- Sidebar ---------- */
  .sidebar{
    width:var(--sidebar-w);
    background:linear-gradient(180deg,#fff,#fbfdff);
    border-right:1px solid rgba(0,0,0,0.03);
    padding:28px 20px;
    box-sizing:border-box;
    position:relative;
    min-height:100vh;
  }
  .brand{
    font-weight:800;
    font-size:20px;
    margin-bottom:12px;
  }
  .sub{
    color:var(--muted);
    font-size:13px;
    margin-bottom:18px;
  }
  nav{margin-top:22px}
  .navlink{
    display:block;
    padding:12px 14px;
    margin-bottom:6px;
    border-radius:10px;
    color:#1f2933;
    text-decoration:none;
    font-weight:600;
  }
  .navlink small{display:block;color:var(--muted);font-weight:400;font-size:12px}
  .navlink.active{
    background:linear-gradient(90deg,#f0f8ff,#eaf4ff);
    box-shadow: 0 6px 18px rgba(17,24,39,0.03);
    border-left:4px solid var(--accent);
  }
  .sidebar .hint{margin-top:28px;color:var(--muted);font-size:13px}
  .side-btns{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}

  button.btn{
    border:0;padding:8px 12px;border-radius:8px;cursor:pointer;
    background:var(--accent);color:#fff;font-weight:700;
  }
  button.ghost{background:#fff;border:1px solid rgba(0,0,0,0.06);color:#333}

  /* ---------- Main area ---------- */
  .main{
    flex:1;padding:22px 36px;box-sizing:border-box;
  }
  .topbar{
    display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;
  }
  .title{font-weight:800;font-size:20px;display:flex;gap:12px;align-items:center}
  .controls{display:flex;gap:12px;align-items:center}
  .input{
    padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);background:#fff;
  }

  /* ---------- Page container ---------- */
  .page{
    max-width:var(--max-w);
    margin:0 auto;
  }
  .card{
    background:var(--card);padding:22px;border-radius:var(--radius);box-shadow:var(--shadow);
    margin-bottom:18px;
  }

  /* ---------- Dashboard layout ---------- */
  .h-grid{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}
  .stats{display:flex;gap:14px;flex-wrap:wrap}
  .stat{
    background:#fff;border-radius:12px;padding:14px 18px;min-width:160px;box-shadow:0 8px 20px rgba(17,24,39,0.03);
  }
  .stat h3{margin:0;font-size:12px;color:var(--muted)}
  .stat p{margin:8px 0 0;font-weight:800;font-size:20px}

  /* ---------- Table ---------- */
  .table{width:100%;border-collapse:collapse}
  .table th{font-weight:800;text-align:left;padding:14px;border-bottom:1px solid #eff2f4;color:#5b6b73}
  .table td{padding:12px;border-bottom:1px solid #f4f6f8}

  /* ---------- Create Invoice ---------- */
  .invoice-row{display:grid;grid-template-columns:40px 1fr 80px 80px 80px 120px;gap:12px;align-items:center;padding:12px;border-radius:10px;border:1px solid #eef2f6;margin-bottom:12px;background:#fff}
  .invoice-row input[type="text"], .invoice-row input[type="number"]{
    width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);
  }
  .row-num{color:var(--muted);font-weight:700;text-align:center}

  .products-head{display:grid;grid-template-columns:40px 1fr 80px 80px 80px 120px;gap:12px;padding:4px 6px;color:var(--muted);font-weight:700}
  .totals{display:flex;flex-direction:column;align-items:flex-end;gap:6px}

  /* ---------- Small screens ---------- */
  @media (max-width:900px){
    .sidebar{display:none}
    .h-grid{grid-template-columns:1fr}
    .page{padding:14px}
    .invoice-row{grid-template-columns:30px 1fr 70px 70px;grid-auto-rows:auto}
    .products-head{display:grid;grid-template-columns:30px 1fr 70px 70px}
    .invoice-row .discount, .invoice-row .amount{display:none}
  }

  /* ---------- Print page size ---------- */
  @media print{
    body{background:#fff}
    .sidebar,.topbar,.controls{display:none}
    .card{box-shadow:none;border-radius:0;padding:0}
  }

  /* --- Set print page to desired 20cm x 14cm portrait --- */
  @page {
    size: 20cm 14cm portrait;
    margin: 8mm;
  }

  /* ---------- Tiny helpers ---------- */
  .muted{color:var(--muted)}
  .right{display:flex;justify-content:flex-end;align-items:center}
  .btn-small{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:#fff}
  .danger{background:var(--danger);color:#fff;border:0}
  .ok{background:#22c55e;color:#fff;border:0}
  .control-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .select{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff}
  .small-muted{color:var(--muted);font-size:13px}

  /* printable invoice preview (hidden) */
  .print-area{display:none}
</style>
</head>
<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">JBS KNIT WEAR — <span style="font-weight:600;color:#334155">Billing</span></div>
    <div class="sub">Simple billing for retail</div>

    <nav id="nav">
      <a href="#" class="navlink active" data-view="dashboard">Dashboard <small>Quick totals & recent</small></a>
      <a href="#" class="navlink" data-view="transactions">Transactions <small>Income & expense add</small></a>
      <a href="#" class="navlink" data-view="create">Create Invoice <small>Add products & save</small></a>
      <a href="#" class="navlink" data-view="invoices">Invoices <small>Saved invoices list</small></a>
      <a href="#" class="navlink" data-view="printable">Printable template <small>View / print</small></a>
    </nav>

    <div class="hint">Tip: export a backup before major changes</div>
    <div class="side-btns">
      <button class="btn-small" id="exportBackupBtn">Export backup</button>
      <button class="btn-small" id="importBtn">Import</button>
      <button class="btn-small" id="openTrash">Trash <span id="trashCount">(0)</span></button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar page">
      <div class="title"> <button class="btn-small" id="menuToggle">☰</button> <span id="pageTitle">Billing — manage invoices & quick sales</span></div>
      <div class="controls">
        <div style="display:flex;gap:8px;align-items:center">
          <label class="muted" style="font-size:13px;margin-right:6px">Opening balance (today)</label>
          <input type="number" step="0.01" id="openingInput" class="input" style="width:120px" value="0">
          <button class="btn-small" id="setOpening">Set</button>
          <button class="btn-small" id="clearOpening">Clear</button>
          <button class="btn-small" id="eodExportBtn">EOD Export</button>
        </div>
      </div>
    </div>

    <div class="page">

      <!-- DASHBOARD -->
      <section id="view-dashboard" class="view">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div>
              <div style="font-weight:800;font-size:22px">Billing Dashboard <span class="muted" style="font-weight:500;font-size:13px;margin-left:12px">— manage invoices & quick sales</span></div>
              <div class="small-muted" style="margin-top:6px">Quick overview of today's totals and recent activity</div>
            </div>
            <div class="right">
              <div style="font-weight:800;color:#0ea5a2">Profit: <span id="profitDisplay">₹0.00</span></div>
            </div>
          </div>

          <div style="margin-top:18px" class="h-grid">
            <div>
              <div class="stats" style="margin-bottom:12px">
                <div class="stat">
                  <h3>Total Income</h3>
                  <p id="statIncome">₹0.00</p>
                </div>
                <div class="stat">
                  <h3>Total Expense</h3>
                  <p id="statExpense">₹0.00</p>
                </div>
                <div class="stat">
                  <h3>Cash Remaining</h3>
                  <p id="statCash">₹0.00</p>
                </div>
              </div>

              <div class="card">
                <div style="font-weight:800;margin-bottom:8px">Recent transactions</div>
                <table class="table">
                  <thead>
                    <tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th>Amount</th></tr>
                  </thead>
                  <tbody id="recentTx"> <tr><td colspan="5" class="muted">No recent transactions</td></tr> </tbody>
                </table>
              </div>
            </div>

            <aside class="card">
              <div style="font-weight:800">Quick invoice panel</div>
              <div class="small-muted" style="margin-top:6px">(also available in Create Invoice)</div>
              <div style="margin-top:12px">
                <input id="quickTotal" class="input" placeholder="Quick total" style="width:100%">
                <div style="margin-top:10px;text-align:right">
                  <button class="btn" id="quickAddBtn">Add</button>
                </div>
              </div>
            </aside>
          </div>
        </div>
      </section>

      <!-- TRANSACTIONS -->
      <section id="view-transactions" class="view" style="display:none">
        <div class="card">
          <div style="font-weight:800;font-size:22px">Transactions <small class="muted" style="font-weight:500">Quick add income & expense</small></div>
          <div class="control-row" style="margin-top:12px">
            <select id="txType" class="select">
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
            <input id="txCategory" class="input" placeholder="Category (sales / purchase / rent)">
            <input id="txAmount" type="number" class="input" placeholder="Amount" step="0.01">
            <input id="txDate" class="input" type="date" style="width:170px">
            <select id="txPay" class="select">
              <option>Cash</option><option>GPay</option><option>Other</option>
            </select>
            <button class="btn" id="addTx">Add</button>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <input id="filterFrom" type="date" class="input" style="width:150px">
            <input id="filterTo" type="date" class="input" style="width:150px">
            <select id="filterType" class="select"><option value="all">All</option><option value="income">Income</option><option value="expense">Expense</option></select>
            <button class="btn-small" id="filterBtn">Filter</button>
            <button class="btn-small" id="downloadTxCsv">Download CSV</button>
          </div>

          <div style="margin-top:14px">
            <table class="table">
              <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th>Amount</th><th>Actions</th></tr></thead>
              <tbody id="txTable"><tr><td colspan="6" class="muted">No transactions added</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CREATE INVOICE -->
      <section id="view-create" class="view" style="display:none">
        <div class="card">
          <div style="font-weight:800;font-size:22px">Create Invoice <small class="muted" style="font-weight:500;margin-left:8px">manage invoices & quick sales</small></div>

          <div class="control-row" style="margin-top:12px">
            <input id="invoiceId" class="input" style="width:200px" placeholder="Invoice id (auto)">
            <input id="invoiceDate" class="input" type="date" style="width:160px">
            <input id="invoiceCustomer" class="input" placeholder="Customer name" style="flex:1">
          </div>

          <div style="margin-top:8px">
            <label class="muted">Payment Method</label><br>
            <select id="invoicePay" class="select" style="margin-top:6px">
              <option>Cash</option>
              <option>GPay</option>
              <option>Other</option>
            </select>
          </div>

          <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Products</div>
            <div>
              <button class="btn" id="addProductBtn">+ Add</button>
              <button class="btn-small" id="clearProductsBtn">Clear</button>
              <button class="btn-small" id="recalcBtn">Recalc</button>
            </div>
          </div>

          <div style="margin-top:12px" class="products-head">
            <div>#</div><div>Product</div><div>Qty</div><div>Rate</div><div>Disc% </div><div class="right">Amount</div>
          </div>

          <div id="productsList" style="margin-top:10px">
            <!-- product rows get injected -->
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:18px">
            <div>
              <label class="muted">Tax %:</label>
              <input id="taxPct" type="number" class="input" style="width:70px;margin-left:8px" value="0">
            </div>

            <div class="totals">
              <div class="muted">Subtotal: <span id="subDisplay">₹0.00</span></div>
              <div class="muted">Tax: <span id="taxDisplay">₹0.00</span></div>
              <div style="font-weight:900;font-size:18px">Total <span id="totalDisplay" style="margin-left:8px">₹0.00</span></div>
            </div>
          </div>

          <div style="margin-top:18px;display:flex;gap:12px">
            <button class="btn" id="saveInvoice">Save</button>
            <button class="btn-small" id="printInvoice">Print</button>
            <button class="danger" id="resetInvoice">Reset</button>
          </div>
        </div>
      </section>

      <!-- INVOICES LIST -->
      <section id="view-invoices" class="view" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800;font-size:22px">Invoices <small class="muted" style="font-weight:500">— manage invoices & quick sales</small></div>
            <div>
              <input id="searchInvoice" class="input" placeholder="Search invoice / customer" style="width:320px">
              <button class="btn" id="exportAllCsv">Export CSV (all)</button>
              <button class="btn-small" id="exportCashBtn">Export Cash</button>
              <button class="btn-small" id="exportGpayBtn">Export GPay</button>
            </div>
          </div>

          <div style="margin-top:16px">
            <table class="table">
              <thead><tr><th>Invoice</th><th>Date</th><th>Customer</th><th>Pay</th><th>Total</th><th>Actions</th></tr></thead>
              <tbody id="invoicesTable"><tr><td colspan="6" class="muted">No invoices</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PRINTABLE -->
      <section id="view-printable" class="view" style="display:none">
        <div class="card">
          <div style="font-weight:800;font-size:22px">Printable template <small class="muted" style="font-weight:500">View / print invoice</small></div>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <select id="printSelect" class="input" style="flex:1"></select>
            <button class="btn" id="openPrintable">Open</button>
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<!-- Hidden printable area used to create print document -->
<template id="print-template">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;color:#111}
    .inv-head{display:flex;justify-content:space-between;align-items:flex-start}
    .biz{font-weight:800;font-size:18px}
    .bizsmall{font-size:12px;color:#444;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:6px;text-align:left}
    .right{text-align:right}
    .total{font-weight:800;text-align:right;margin-top:12px}
  </style>

  <div>
    <div class="inv-head">
      <div>
        <div class="biz">JBS KNIT WEAR</div>
        <div class="bizsmall" id="bizDetails"></div>
      </div>
      <div>
        <div id="invMeta" style="text-align:right"></div>
      </div>
    </div>

    <table>
      <thead>
        <tr><th>#</th><th>Product</th><th>Qty</th><th>Rate</th><th>Disc%</th><th>Amount</th></tr>
      </thead>
      <tbody id="invRows"></tbody>
    </table>

    <div class="total" id="invTotals"></div>
    <div style="margin-top:14px">Payment: <span id="invPayment"></span></div>
  </div>
</template>

<script>
/* ---------------------------
  Minimal billing app (single file)
  - localStorage based persistence
  - invoices, transactions, trash
  - print/export/import/backup
  - responsive layout
------------------------------*/

/* -------------------------
   Utilities
--------------------------*/
const LKEY = {
  invoices: 'billing:invoices',
  transactions: 'billing:transactions',
  trash: 'billing:trash',
  settings: 'billing:settings'
};
const money = v => '₹' + Number(v || 0).toFixed(2);
const nowDate = (d=new Date()) => {
  const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const day=('0'+d.getDate()).slice(-2);
  return `${y}-${m}-${day}`;
};
const uid = () => 'id-' + Math.random().toString(36).slice(2,9);

/* -------------------------
   Storage helpers
--------------------------*/
function load(key){ try { return JSON.parse(localStorage.getItem(key) || 'null') || null } catch(e){ return null } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function ensure(){
  if(!load(LKEY.settings)){
    save(LKEY.settings, {
      bizName: 'JBS KNIT WEAR',
      address: '3(2)/2B, Nesavalor Colony 2nd Street, P.N.Road, Tirupur',
      phone: '9791902205',
      gst: '33CKAPJ7513F1ZK'
    });
  }
  if(!load(LKEY.invoices)) save(LKEY.invoices, []);
  if(!load(LKEY.transactions)) save(LKEY.transactions, []);
  if(!load(LKEY.trash)) save(LKEY.trash, []);
}
ensure();

/* -------------------------
   DOM refs & navigation
--------------------------*/
const views = ['dashboard','transactions','create','invoices','printable'];
const navlinks = document.querySelectorAll('.navlink');
const pageTitle = document.getElementById('pageTitle');

function showView(name){
  views.forEach(v=>{
    const el = document.getElementById('view-'+v);
    if(!el) return;
    el.style.display = v===name ? 'block' : 'none';
  });
  navlinks.forEach(a=> a.classList.toggle('active', a.dataset.view === name));
  pageTitle.innerText = {
    dashboard: 'Billing — manage invoices & quick sales',
    transactions: 'Transactions — manage income & expense',
    create: 'Create — manage invoices & quick sales',
    invoices: 'Invoices — manage invoices & quick sales',
    printable: 'Printable — manage invoices & quick sales'
  }[name] || 'Billing';
}
navlinks.forEach(a=>{
  a.onclick = e => { e.preventDefault(); showView(a.dataset.view); renderAll(); window.scrollTo(0,0); }
});

/* -------------------------
   Dashboard rendering
--------------------------*/
const statIncome = document.getElementById('statIncome');
const statExpense = document.getElementById('statExpense');
const statCash = document.getElementById('statCash');
const profitDisplay = document.getElementById('profitDisplay');
const recentTx = document.getElementById('recentTx');

function computeStats(){
  const tx = load(LKEY.transactions) || [];
  const income = tx.filter(t=>t.type==='income').reduce((s,i)=>s+Number(i.amount||0),0);
  const expense = tx.filter(t=>t.type==='expense').reduce((s,i)=>s+Number(i.amount||0),0);
  const cashIn = tx.filter(t=>t.type==='income' && t.pay==='Cash').reduce((s,i)=>s+Number(i.amount||0),0);
  const cashOut = tx.filter(t=>t.type==='expense' && t.pay==='Cash').reduce((s,i)=>s+Number(i.amount||0),0);
  return {income,expense,cashRemaining: cashIn - cashOut, profit: income - expense, tx};
}
function renderDashboard(){
  const s = computeStats();
  statIncome.innerText = money(s.income);
  statExpense.innerText = money(s.expense);
  statCash.innerText = money(s.cashRemaining);
  profitDisplay.innerText = money(s.profit);

  const recent = s.tx.slice().sort((a,b)=> new Date(b.date) - new Date(a.date)).slice(0,6);
  if(!recent.length){
    recentTx.innerHTML = '<tr><td colspan="5" class="muted">No recent transactions</td></tr>';
  } else {
    recentTx.innerHTML = recent.map(r=>`<tr>
      <td>${r.date}</td><td class="muted">${r.type}</td><td>${r.category||'-'}</td><td>${r.pay||'-'}</td><td>${money(r.amount)}</td>
    </tr>`).join('');
  }
}

/* -------------------------
   Transactions UI
--------------------------*/
const txType = document.getElementById('txType');
const txCategory = document.getElementById('txCategory');
const txAmount = document.getElementById('txAmount');
const txDate = document.getElementById('txDate');
const txPay = document.getElementById('txPay');
const addTxBtn = document.getElementById('addTx');
const txTable = document.getElementById('txTable');
const filterFrom = document.getElementById('filterFrom');
const filterTo = document.getElementById('filterTo');
const filterType = document.getElementById('filterType');
const filterBtn = document.getElementById('filterBtn');
const downloadTxCsv = document.getElementById('downloadTxCsv');

txDate.value = nowDate();

function renderTxTable(list){
  if(!list.length){
    txTable.innerHTML='<tr><td colspan="6" class="muted">No transactions added</td></tr>';
    return;
  }
  txTable.innerHTML = list.map((t,idx)=>`<tr>
    <td>${t.date}</td><td>${t.type}</td><td>${t.category||'-'}</td><td>${t.pay||'-'}</td><td>${money(t.amount)}</td>
    <td><button class="btn-small" data-id="${t.id}" data-action="del">Del</button></td>
  </tr>`).join('');
}
txTable.addEventListener('click', (e)=>{
  if(e.target.dataset.action==='del'){
    const id = e.target.dataset.id;
    let txs = load(LKEY.transactions) || [];
    txs = txs.filter(t=>t.id!==id);
    save(LKEY.transactions, txs); renderAll();
  }
});

addTxBtn.addEventListener('click', ()=>{
  const type = txType.value, cat = txCategory.value || 'sales', amt = Number(txAmount.value||0);
  const date = txDate.value || nowDate(); const pay = txPay.value;
  if(!amt || amt<=0){ alert('Enter amount'); return; }
  const txs = load(LKEY.transactions) || [];
  const newTx = { id: uid(), date, type, category:cat, amount:amt, pay };
  txs.push(newTx); save(LKEY.transactions, txs);
  txAmount.value=''; txCategory.value=''; renderAll();
});

filterBtn.addEventListener('click', ()=>{
  let txs = load(LKEY.transactions) || [];
  const from = filterFrom.value, to = filterTo.value, typ = filterType.value;
  if(from) txs = txs.filter(t=>t.date >= from);
  if(to) txs = txs.filter(t=>t.date <= to);
  if(typ && typ!=='all') txs = txs.filter(t=>t.type===typ);
  renderTxTable(txs);
});

downloadTxCsv.addEventListener('click', ()=>{
  const txs = load(LKEY.transactions) || [];
  downloadCSV('transactions.csv', txs, ['id','date','type','category','pay','amount']);
});

/* -------------------------
   Invoices creation
--------------------------*/
const productsList = document.getElementById('productsList');
const addProductBtn = document.getElementById('addProductBtn');
const clearProductsBtn = document.getElementById('clearProductsBtn');
const recalcBtn = document.getElementById('recalcBtn');
const taxPct = document.getElementById('taxPct');
const subDisplay = document.getElementById('subDisplay');
const taxDisplay = document.getElementById('taxDisplay');
const totalDisplay = document.getElementById('totalDisplay');
const invoiceId = document.getElementById('invoiceId');
const invoiceDate = document.getElementById('invoiceDate');
const invoiceCustomer = document.getElementById('invoiceCustomer');
const invoicePay = document.getElementById('invoicePay');
const saveInvoiceBtn = document.getElementById('saveInvoice');
const printInvoiceBtn = document.getElementById('printInvoice');
const resetInvoiceBtn = document.getElementById('resetInvoice');

invoiceDate.value = nowDate();

function createEmptyProductRow(i, data = {}){
  const id = uid();
  const row = document.createElement('div');
  row.className = 'invoice-row';
  row.dataset.id = id;
  row.innerHTML = `
    <div class="row-num">${i}</div>
    <div><input type="text" class="prod-name" placeholder="Product name" value="${data.name||''}"></div>
    <div><input type="number" class="prod-qty" min="0" value="${data.qty||''}" ></div>
    <div><input type="number" class="prod-rate" min="0" value="${data.rate||''}" ></div>
    <div><input type="number" class="prod-disc" min="0" value="${data.disc||''}" ></div>
    <div class="right amountCell">${money(data.amount||0)} <button class="btn-small" data-action="delRow" style="margin-left:8px">x</button></div>
  `;
  // events
  row.querySelector('.prod-qty').addEventListener('input', recalcTotals);
  row.querySelector('.prod-rate').addEventListener('input', recalcTotals);
  row.querySelector('.prod-disc').addEventListener('input', recalcTotals);
  row.querySelector('[data-action="delRow"]').addEventListener('click', ()=>{
    row.remove(); refreshRowNumbers(); recalcTotals();
  });
  return row;
}

function refreshRowNumbers(){
  Array.from(productsList.children).forEach((r,i)=> r.querySelector('.row-num').innerText = i+1);
}

function recalcTotals(){
  let subtotal = 0;
  Array.from(productsList.children).forEach(row=>{
    const qty = Number(row.querySelector('.prod-qty').value || 0);
    const rate = Number(row.querySelector('.prod-rate').value || 0);
    const disc = Number(row.querySelector('.prod-disc').value || 0);
    let amt = qty * rate * (1 - disc/100);
    if(!isFinite(amt)) amt = 0;
    row.querySelector('.amountCell').firstChild.nodeValue = money(amt) + ' ';
    subtotal += amt;
  });
  const tax = (Number(taxPct.value||0)/100) * subtotal;
  subDisplay.innerText = money(subtotal);
  taxDisplay.innerText = money(tax);
  totalDisplay.innerText = money(subtotal + tax);
}

/* add initial 4 product rows */
function ensureDefaultRows(){
  if(productsList.children.length===0){
    for(let i=0;i<4;i++) productsList.appendChild(createEmptyProductRow(i+1));
  }
  refreshRowNumbers();
  recalcTotals();
}
ensureDefaultRows();

addProductBtn.addEventListener('click', ()=>{
  productsList.appendChild(createEmptyProductRow(productsList.children.length+1));
  refreshRowNumbers();
});
clearProductsBtn.addEventListener('click', ()=>{
  productsList.innerHTML='';
  ensureDefaultRows();
});
recalcBtn.addEventListener('click', recalcTotals);

/* Save invoice */
function invoiceFromUI(){
  recalcTotals();
  const rows = Array.from(productsList.children).map(row=>({
    name: row.querySelector('.prod-name').value || '',
    qty: Number(row.querySelector('.prod-qty').value||0),
    rate: Number(row.querySelector('.prod-rate').value||0),
    disc: Number(row.querySelector('.prod-disc').value||0),
    amount: Number(row.querySelector('.amountCell').firstChild.nodeValue.replace(/[^\d.-]/g,'')||0)
  }));
  const subtotal = Number(subDisplay.innerText.replace(/[^\d.-]/g,'')||0);
  const tax = Number(taxDisplay.innerText.replace(/[^\d.-]/g,'')||0);
  const total = Number(totalDisplay.innerText.replace(/[^\d.-]/g,'')||0);
  return {
    id: invoiceId.value || uid(),
    date: invoiceDate.value || nowDate(),
    customer: invoiceCustomer.value || '',
    pay: invoicePay.value,
    products: rows,
    subtotal, tax, total
  };
}

saveInvoiceBtn.addEventListener('click', ()=>{
  const inv = invoiceFromUI();
  if(inv.total <= 0){ if(!confirm('Total is 0 — save anyway?')) return; }
  const invoices = load(LKEY.invoices) || [];
  invoices.push(inv);
  save(LKEY.invoices, invoices);
  // also create a transaction record (income)
  const txs = load(LKEY.transactions) || [];
  txs.push({ id: uid(), date: inv.date, type: 'income', category: 'sales', amount: inv.total, pay: inv.pay, invoiceId: inv.id });
  save(LKEY.transactions, txs);

  alert('Invoice saved');
  renderAll();
});

printInvoiceBtn.addEventListener('click', ()=>{
  const inv = invoiceFromUI();
  openPrintableWindow(inv);
});

resetInvoiceBtn.addEventListener('click', ()=>{
  if(confirm('Reset invoice form?')) {
    invoiceId.value = uid();
    invoiceCustomer.value = '';
    invoiceDate.value = nowDate();
    invoicePay.value = 'Cash';
    productsList.innerHTML = '';
    ensureDefaultRows();
    taxPct.value = 0;
    recalcTotals();
  }
});

/* -------------------------
   Invoices list
--------------------------*/
const invoicesTable = document.getElementById('invoicesTable');
const searchInvoice = document.getElementById('searchInvoice');

function renderInvoices(){
  const invoices = load(LKEY.invoices) || [];
  if(!invoices.length){
    invoicesTable.innerHTML = '<tr><td colspan="6" class="muted">No invoices</td></tr>';
    return;
  }
  const q = (searchInvoice.value || '').toLowerCase();
  const list = invoices.filter(inv => !q || (inv.id + ' ' + (inv.customer||'')).toLowerCase().includes(q));
  invoicesTable.innerHTML = list.map(inv=>`<tr>
    <td>${inv.id}</td><td>${inv.date}</td><td>${inv.customer||'-'}</td><td>${inv.pay}</td><td>${money(inv.total)}</td>
    <td>
      <button class="btn-small" data-id="${inv.id}" data-action="open">Open</button>
      <button class="btn-small" data-id="${inv.id}" data-action="print">Print</button>
      <button class="btn-small" data-id="${inv.id}" data-action="del">Del</button>
    </td>
  </tr>`).join('');
}

invoicesTable.addEventListener('click', (e)=>{
  const id = e.target.dataset.id;
  const action = e.target.dataset.action;
  if(!id || !action) return;
  let invoices = load(LKEY.invoices) || [];
  const inv = invoices.find(i=>i.id===id);
  if(action==='open'){
    if(inv) openPrintableWindow(inv);
    else alert('Invoice not found');
  } else if(action==='print'){
    if(inv) openPrintableWindow(inv,true);
    else alert('Invoice not found');
  } else if(action==='del'){
    if(!confirm('Move invoice to trash?')) return;
    invoices = invoices.filter(i=>i.id!==id);
    const trash = load(LKEY.trash) || [];
    trash.push(inv);
    save(LKEY.trash, trash);
    save(LKEY.invoices, invoices);
    renderAll();
  }
});

/* -------------------------
   Printable / print window
--------------------------*/
function openPrintableWindow(inv, autoPrint=false){
  const tmpl = document.getElementById('print-template').content.cloneNode(true);
  tmpl.getElementById('bizDetails').innerHTML = `${load(LKEY.settings).address}<br>Phone: ${load(LKEY.settings).phone}<br>GSTIN: ${load(LKEY.settings).gst}`;
  tmpl.getElementById('invMeta').innerHTML = `Date: ${inv.date}<br>Invoice: ${inv.id}<br>Customer: ${inv.customer||'-'}`;
  tmpl.getElementById('invPayment').innerText = inv.pay || '-';
  const tbody = tmpl.getElementById('invRows');
  inv.products.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${p.name||'-'}</td><td>${p.qty}</td><td>${p.rate.toFixed(2)}</td><td>${p.disc}</td><td>${p.amount.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
  tmpl.getElementById('invTotals').innerText = `Total: ${money(inv.total)}`;
  // build a full HTML
  const w = window.open('about:blank','_blank','width=800,height=900');
  if(!w) { alert('Popup blocked — allow popups to print'); return; }
  w.document.write('<!doctype html><html><head><title>Invoice '+inv.id+'</title></head><body></body></html>');
  w.document.body.appendChild(tmpl);
  // Small style adjustments to match 20cm x14cm when printing
  const style = w.document.createElement('style');
  style.textContent = '@page { size: 20cm 14cm portrait; margin:8mm } body{font-family:Arial,Helvetica,sans-serif;font-size:12px}';
  w.document.head.appendChild(style);
  if(autoPrint){
    w.print();
  }
}

/* -------------------------
   CSV / backup helpers
--------------------------*/
function csvEscape(v){ if(v==null) return ''; return '"'+String(v).replace(/"/g,'""')+'"'; }
function downloadCSV(filename, items, keys){
  if(!items || !items.length){ alert('No data'); return; }
  const k = keys || Object.keys(items[0]);
  const lines = [k.join(',')];
  items.forEach(it=>{
    lines.push(k.map(kk=>csvEscape(it[kk]===undefined?'':it[kk])).join(','));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* Export buttons */
document.getElementById('exportBackupBtn')?.addEventListener('click', ()=>{
  const backup = {
    invoices: load(LKEY.invoices) || [],
    transactions: load(LKEY.transactions) || [],
    trash: load(LKEY.trash) || [],
    settings: load(LKEY.settings) || {}
  };
  downloadJSON('billing-backup-' + nowDate() + '.json', backup);
});
document.getElementById('importBtn')?.addEventListener('click', ()=>{
  const f = document.createElement('input'); f.type='file'; f.accept='application/json';
  f.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = ev => {
      try{
        const data = JSON.parse(ev.target.result);
        if(data.invoices) save(LKEY.invoices, data.invoices);
        if(data.transactions) save(LKEY.transactions, data.transactions);
        if(data.trash) save(LKEY.trash, data.trash);
        if(data.settings) save(LKEY.settings, data.settings);
        alert('Import complete');
        renderAll();
      } catch(err){ alert('Import failed: ' + err.message) }
    };
    r.readAsText(file);
  };
  f.click();
});

/* Export all/gpay/cash */
document.getElementById('exportAllCsv').addEventListener('click', ()=> {
  const invs = load(LKEY.invoices) || [];
  if(!invs.length) { alert('No invoices'); return; }
  // flatten invoice rows for csv
  const rows = [];
  invs.forEach(inv=>{
    inv.products.forEach(p=>{
      rows.push({ invoice:inv.id, date:inv.date, customer:inv.customer, pay:inv.pay, product:p.name, qty:p.qty, rate:p.rate, disc:p.disc, amount:p.amount });
    });
  });
  downloadCSV('invoices-all-'+nowDate()+'.csv', rows, ['invoice','date','customer','pay','product','qty','rate','disc','amount']);
});
document.getElementById('exportCashBtn').addEventListener('click', ()=> {
  const invs = (load(LKEY.invoices) || []).filter(i=>i.pay==='Cash');
  if(!invs.length) { alert('No cash invoices'); return; }
  const rows = []; invs.forEach(inv=> inv.products.forEach(p=> rows.push({invoice:inv.id,date:inv.date,customer:inv.customer,pay:inv.pay,product:p.name,qty:p.qty,rate:p.rate,amount:p.amount})));
  downloadCSV('invoices-cash-'+nowDate()+'.csv', rows, ['invoice','date','customer','pay','product','qty','rate','amount']);
});
document.getElementById('exportGpayBtn').addEventListener('click', ()=> {
  const invs = (load(LKEY.invoices) || []).filter(i=>i.pay==='GPay');
  if(!invs.length) { alert('No GPay invoices'); return; }
  const rows = []; invs.forEach(inv=> inv.products.forEach(p=> rows.push({invoice:inv.id,date:inv.date,customer:inv.customer,pay:inv.pay,product:p.name,qty:p.qty,rate:p.rate,amount:p.amount})));
  downloadCSV('invoices-gpay-'+nowDate()+'.csv', rows, ['invoice','date','customer','pay','product','qty','rate','amount']);
});

/* EOD Export (creates date-stamped CSVs, the browser downloads them) */
document.getElementById('eodExportBtn').addEventListener('click', ()=>{
  const dateTag = nowDate();
  // invoices
  const invs = load(LKEY.invoices) || [];
  const invrows = [];
  invs.forEach(inv=> inv.products.forEach(p=> invrows.push({invoice:inv.id,date:inv.date,customer:inv.customer,pay:inv.pay,product:p.name,qty:p.qty,rate:p.rate,amount:p.amount})));
  if(invrows.length) downloadCSV(`EOD_invoices_${dateTag}.csv`, invrows, ['invoice','date','customer','pay','product','qty','rate','amount']);
  // transactions
  const txs = load(LKEY.transactions) || [];
  if(txs.length) downloadCSV(`EOD_transactions_${dateTag}.csv`, txs, ['id','date','type','category','pay','amount']);
  alert('EOD Export downloaded (check your downloads folder)');
});

/* -------------------------
   Printable select + open
--------------------------*/
const printSelect = document.getElementById('printSelect');
const openPrintableBtn = document.getElementById('openPrintable');
openPrintableBtn.addEventListener('click', ()=>{
  const id = printSelect.value;
  const inv = (load(LKEY.invoices) || []).find(i=>i.id==id);
  if(inv) openPrintableWindow(inv, true);
  else alert('Invoice not found');
});

/* -------------------------
   Trash / recovery
--------------------------*/
document.getElementById('openTrash').addEventListener('click', ()=>{
  const trash = load(LKEY.trash) || [];
  if(!trash.length){ alert('Trash empty'); return; }
  if(!confirm(`There are ${trash.length} invoices in trash. Recover all to invoices?`)) return;
  const invs = load(LKEY.invoices) || [];
  save(LKEY.invoices, invs.concat(trash));
  save(LKEY.trash, []);
  renderAll();
});

/* -------------------------
   Quick invoice panel
--------------------------*/
document.getElementById('quickAddBtn').addEventListener('click', ()=>{
  const val = Number(document.getElementById('quickTotal').value||0);
  if(!val){ alert('Enter quick total'); return; }
  // create a quick income transaction
  const txs = load(LKEY.transactions) || [];
  txs.push({id:uid(), date: nowDate(), type:'income', category:'quick', amount: val, pay:'Cash' });
  save(LKEY.transactions, txs); renderAll();
});

/* -------------------------
   Opening balance & store settings
--------------------------*/
document.getElementById('setOpening').addEventListener('click', ()=>{
  const v = Number(document.getElementById('openingInput').value || 0);
  const s = load(LKEY.settings) || {};
  s.opening = v; save(LKEY.settings, s); alert('Opening set');
  renderAll();
});
document.getElementById('clearOpening').addEventListener('click', ()=>{
  const s = load(LKEY.settings) || {}; delete s.opening; save(LKEY.settings, s); renderAll();
});

/* -------------------------
   Print layout / render helpers
--------------------------*/
function renderPrintList(){
  const invs = load(LKEY.invoices) || [];
  const sel = printSelect;
  sel.innerHTML = '';
  invs.forEach(i=> {
    const opt = document.createElement('option'); opt.value = i.id; opt.textContent = `${i.id} — ${i.date}`;
    sel.appendChild(opt);
  });
}

/* -------------------------
   Misc helpers + render all
--------------------------*/
function refreshTrashCount(){
  const t = load(LKEY.trash) || [];
  document.getElementById('trashCount').innerText = `(${t.length})`;
}

function renderAll(){
  ensureDefaultRows(); // ensure product rows
  renderDashboard();
  renderTxTable(load(LKEY.transactions) || []);
  renderInvoices();
  renderPrintList();
  refreshTrashCount();
}

renderAll();

/* -------------------------
   Page interactions: initialize invoice id on load, etc.
--------------------------*/
if(!invoiceId.value) invoiceId.value = uid();

/* invoices table search listener */
searchInvoice.addEventListener('input', renderInvoices);

/* open printable direct from main invoices render - handled above */

/* -------------------------
   Buttons not referenced earlier (defensive)
--------------------------*/
document.getElementById('menuToggle').addEventListener('click', ()=>{
  const sb = document.querySelector('.sidebar');
  sb.style.display = sb.style.display === 'none' ? '' : 'none';
});

/* ensure data survives code edits
   We DO NOT clear or reset storage anywhere automatically.
   Only explicit Export/Import/Trash operations will change saved data.
*/

</script>
</body>
</html>
