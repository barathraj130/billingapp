<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing — JBS KNIT WEAR</title>
<style>
  :root{
    --bg:#f3f6f8; --card:#ffffff; --muted:#98a0a8; --accent:#1e73ff; --danger:#ff6b57;
    --radius:12px; --gap:20px; --sidebar-w:260px;
    --shadow: 0 8px 30px rgba(30,40,50,0.06);
    --mono: "Helvetica Neue", Arial, sans-serif;
  }
  html,body{height:100%;margin:0;font-family:var(--mono);background:var(--bg);color:#222}
  .app{display:flex;min-height:100vh}
  /* SIDEBAR */
  .sidebar{width:var(--sidebar-w);background:#fff;border-right:1px solid rgba(0,0,0,0.03);padding:28px 18px;box-shadow:none;position:relative}
  .brand{font-weight:800;font-size:20px;margin-bottom:22px}
  .brand small{font-weight:400;color:var(--muted);display:block;font-size:12px}
  .nav{display:flex;flex-direction:column;gap:10px}
  .nav a{display:block;padding:12px;border-radius:10px;color:#222;text-decoration:none;font-weight:600}
  .nav a small{display:block;font-weight:400;color:var(--muted)}
  .nav a.active{background:linear-gradient(90deg,#eaf2ff,#fff);box-shadow:0 6px 18px rgba(30,60,130,0.06);border-left:4px solid var(--accent)}
  .sidebar .foot{position:absolute;bottom:20px;left:18px;right:18px;font-size:13px;color:var(--muted)}
  .sidebar .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:#fff;border:1px solid #e6eef8;margin-right:8px;cursor:pointer}
  /* CONTENT AREA */
  .main{flex:1;padding:18px 28px;overflow:auto}
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .topbar .left{display:flex;align-items:center;gap:12px}
  .card{background:var(--card);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow);margin-bottom:var(--gap)}
  h1{margin:0 0 8px 0;font-size:28px}
  h2{margin:0 0 10px 0;font-size:20px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  .stat{padding:18px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 4px 20px rgba(20,40,80,0.03)}
  .muted{color:var(--muted);font-size:14px}
  .big{font-weight:800;font-size:20px;margin-top:8px}
  .right-controls{display:flex;gap:10px;align-items:center}
  input,select,textarea{font-size:14px;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:#fff}
  .input-inline{display:flex;gap:10px;align-items:center}
  .btn-primary{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
  .btn-ghost{background:#fff;border:1px solid #e6eef8;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn-danger{background:var(--danger);color:#fff;padding:8px 12px;border-radius:7px;border:none}
  /* Invoice form */
  .invoice-row{display:flex;gap:12px;align-items:center;padding:14px;border-radius:10px;border:1px solid #eef4fb;background:linear-gradient(180deg,#fff,#fbfdff)}
  .prod-left{width:48px;text-align:center;color:var(--muted);font-weight:700}
  .prod-mid{flex:1}
  .prod-right{display:flex;gap:10px;align-items:center}
  .note{font-size:13px;color:var(--muted)}
  /* invoice list table */
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;text-align:left;border-bottom:1px solid #f1f4f7}
  th{color:var(--muted);background:transparent;font-weight:700}
  .actions button{margin-right:8px}
  /* printable preview */
  .printable-select{display:flex;gap:8px;align-items:center}
  /* small screens */
  @media(max-width:900px){
    .sidebar{position:fixed;left:-320px;top:0;bottom:0;width:260px;z-index:90;transition:all .2s}
    .sidebar.open{left:0}
    .main{padding:12px}
    .grid{grid-template-columns:1fr}
    .topbar{flex-direction:column;align-items:flex-start;gap:8px}
  }
  /* compact form layout for invoice product fields */
  .product-fields{display:flex;gap:10px;align-items:center}
  .product-fields input{width:85px}
  .product-row{margin-bottom:12px}
  .right-summary{margin-left:auto;text-align:right}
  .small-muted{color:var(--muted);font-size:13px}
  .tag{display:inline-block;padding:6px 10px;border-radius:8px;background:#f6fbff;border:1px solid #e6f0ff}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar">
    <div class="brand">JBS KNIT WEAR — <small>Billing</small></div>
    <nav class="nav" id="nav">
      <a href="#dashboard" data-view="dashboard" class="active">Dashboard <small>Quick totals & recent</small></a>
      <a href="#transactions" data-view="transactions">Transactions <small>Income & expense add</small></a>
      <a href="#create" data-view="create">Create Invoice <small>Add products & save</small></a>
      <a href="#invoices" data-view="invoices">Invoices <small>Saved invoices list</small></a>
      <a href="#printable" data-view="printable">Printable template <small>View / print invoice</small></a>
    </nav>

    <div class="foot">
      <div style="margin-top:10px">
        <div style="margin-bottom:6px" class="note">Tip: export a backup before major changes</div>
        <button class="btn-ghost" id="exportBackupBtn">Export backup</button>
        <button class="btn-ghost" id="importBtn">Import</button>
      </div>
      <div style="margin-top:20px">
        <button class="btn-ghost" id="trashBtn">Trash (<span id="trashCount">0</span>)</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left">
        <button class="btn-ghost" id="menuToggle">☰</button>
        <div><strong id="pageTitle">Billing</strong> <span class="small-muted">— manage invoices & quick sales</span></div>
      </div>
      <div class="right-controls">
        <div class="small-muted">Opening balance (today)</div>
        <input id="openingInput" style="width:130px" placeholder="0.00" />
        <button class="btn-primary" id="setOpening">Set</button>
        <button class="btn-ghost" id="clearOpening">Clear</button>
        <button class="btn-ghost" id="eodExport">EOD Export</button>
      </div>
    </div>

    <!-- VIEWS -->
    <section id="view-dashboard" class="view">
      <div class="card">
        <h1>Billing Dashboard <span class="tag" id="profitTag"></span></h1>
        <div class="grid" style="margin-top:16px">
          <div class="stat">
            <div class="muted">Total Income</div>
            <div class="big" id="totalIncome">₹0.00</div>
          </div>
          <div class="stat">
            <div class="muted">Total Expense</div>
            <div class="big" id="totalExpense">₹0.00</div>
          </div>
          <div class="stat">
            <div class="muted">Cash Remaining</div>
            <div class="big" id="cashRemain">₹0.00</div>
          </div>
        </div>

        <div style="display:flex;gap:18px;margin-top:22px">
          <div style="flex:1">
            <h2>Recent transactions</h2>
            <div class="card">
              <table>
                <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th>Amount</th></tr></thead>
                <tbody id="recentTxTbody"><tr><td colspan="5" class="small-muted">No recent transactions</td></tr></tbody>
              </table>
            </div>
          </div>
          <div style="width:320px">
            <div class="card">
              <h3>Quick invoice panel</h3>
              <input id="quickTotal" placeholder="Quick total" style="width:100%;margin-bottom:8px"/>
              <div style="display:flex;gap:8px">
                <button class="btn-primary" id="quickAddBtn">Add</button>
                <button class="btn-ghost" id="quickToCreate">Open Create</button>
              </div>
              <div class="note" style="margin-top:12px">Use 'Create Invoice' to open the full editor for editing and printing.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-transactions" class="view" style="display:none">
      <div class="card">
        <h1>Transactions <small class="small-muted">Quick add income & expense</small></h1>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          <select id="txType">
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
          <input id="txCategory" placeholder="Category"/>
          <input id="txAmount" placeholder="Amount" style="width:120px"/>
          <input id="txDate" type="date"/>
          <select id="txPay"><option>Cash</option><option>GPay</option></select>
          <button class="btn-primary" id="txAddBtn">Add</button>
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="txFilterStart" type="date"/>
          <input id="txFilterEnd" type="date"/>
          <select id="txFilterType"><option value="all">All</option><option value="income">Income</option><option value="expense">Expense</option></select>
          <button class="btn-ghost" id="filterTxBtn">Filter</button>
          <button class="btn-primary" id="exportTxCsv">Download CSV</button>
        </div>

        <div style="margin-top:12px">
          <table>
            <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th>Amount</th><th>Actions</th></tr></thead>
            <tbody id="txTableBody"><tr><td colspan="6" class="small-muted">No transactions added</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-create" class="view" style="display:none">
      <div class="card">
        <h1>Create Invoice <small class="small-muted">manage invoices & quick sales</small></h1>

        <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
          <input id="invoiceId" style="width:90px" readonly placeholder="Auto"/>
          <input id="invoiceDate" type="date" />
          <input id="invoiceCustomer" placeholder="Customer name" style="flex:1"/>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Payment Method</div>
          <select id="invoicePay" style="width:200px">
            <option>Cash</option>
            <option>GPay</option>
          </select>
        </div>

        <div style="margin-top:14px;display:flex;gap:12px;align-items:center">
          <h2 style="margin:0">Products</h2>
          <div style="margin-left:auto">
            <button class="btn-primary" id="addProductBtn">+ Add</button>
            <button class="btn-ghost" id="clearProductsBtn">Clear</button>
            <button class="btn-ghost" id="recalcBtn">Recalc</button>
          </div>
        </div>

        <div id="productsList" style="margin-top:12px">
          <!-- product rows will be injected here -->
        </div>

        <div style="display:flex;align-items:center;gap:12px;margin-top:22px">
          <div class="right-summary" style="flex:1">
            <div class="small-muted">Subtotal:</div>
            <div class="big" id="subtotal">₹0.00</div>
            <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
              <div class="small-muted">Tax %:</div>
              <input id="taxPct" style="width:60px" value="0"/>
              <div style="margin-left:20px" class="small-muted">Total</div>
              <div class="big" id="totalSum">₹0.00</div>
            </div>
          </div>
        </div>

        <div style="margin-top:18px;display:flex;gap:12px">
          <button class="btn-primary" id="saveInvoiceBtn">Save</button>
          <button class="btn-ghost" id="printInvoiceBtn">Print</button>
          <button class="btn-danger" id="resetInvoiceBtn">Reset</button>
        </div>
      </div>
    </section>

    <section id="view-invoices" class="view" style="display:none">
      <div class="card">
        <h1>Invoices <small class="small-muted">— manage invoices & quick sales</small></h1>
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <input id="searchInvoice" placeholder="Search invoice / customer" style="flex:1"/>
          <button class="btn-primary" id="exportAllCsv">Export CSV (all)</button>
          <button class="btn-ghost" id="exportCash">Export Cash</button>
          <button class="btn-ghost" id="exportGpay">Export GPay</button>
        </div>

        <div style="margin-top:16px">
          <table>
            <thead><tr><th>Invoice</th><th>Date</th><th>Customer</th><th>Pay</th><th>Total</th><th>Actions</th></tr></thead>
            <tbody id="invoicesTbody"><tr><td colspan="6" class="small-muted">No invoices</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-printable" class="view" style="display:none">
      <div class="card">
        <h1>Printable template <small class="small-muted">View / print invoice</small></h1>
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <select id="printableSelect" style="flex:1"></select>
          <button class="btn-primary" id="openPrintableBtn">Open</button>
        </div>
        <div id="printPreview" style="margin-top:16px"></div>
      </div>
    </section>

  </main>
</div>

<script>
/* =========================
   Stable localStorage keys
   ========================= */
const KEY_INVOICES = 'billing_invoices_v1';
const KEY_TRANSACTIONS = 'billing_transactions_v1';
const KEY_TRASH = 'billing_trash_v1';
const KEY_SETTINGS = 'billing_settings_v1';

/* =========================
   Utility helpers
   ========================= */
const $ = (sel)=>document.querySelector(sel);
const el = (html)=>{ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; }
const money = (n)=>'₹'+Number(n||0).toFixed(2);
const uid = (len=8)=>('id-'+Math.random().toString(36).slice(2,len+2));
const todayISO = ()=>new Date().toISOString().slice(0,10);

/* =========================
   Data layer (localStorage)
   ========================= */
function load(key, fallback){ try { const raw = localStorage.getItem(key); return raw?JSON.parse(raw):fallback } catch(e){ return fallback } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

let invoices = load(KEY_INVOICES, []);
let transactions = load(KEY_TRANSACTIONS, []);
let trash = load(KEY_TRASH, []);
let settings = load(KEY_SETTINGS, {opening_today:0});

/* =========================
   View routing
   ========================= */
const views = ['dashboard','transactions','create','invoices','printable'];
function setView(name){
  views.forEach(v=>{
    const node = document.getElementById('view-'+v);
    if(!node) return;
    node.style.display = v===name?'block':'none';
  });
  document.querySelectorAll('.nav a').forEach(a=>a.classList.toggle('active', a.dataset.view===name));
  document.getElementById('pageTitle').innerText = name.charAt(0).toUpperCase() + name.slice(1);
  refreshAll();
}
document.querySelectorAll('.nav a').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    setView(a.dataset.view);
    if(window.innerWidth < 900) document.getElementById('sidebar').classList.remove('open');
  });
});

/* toggle sidebar */
$('#menuToggle').addEventListener('click', ()=>document.getElementById('sidebar').classList.toggle('open'));

/* open specific view by hash on load */
const hash = location.hash.replace('#','');
if(views.includes(hash)) setView(hash); else setView('dashboard');

/* =========================
   Rendering / UI helpers
   ========================= */

function refreshAll(){
  renderDashboard();
  renderRecentTransactions();
  renderInvoiceList();
  renderPrintableSelect();
  renderTrashCount();
  renderTransactionsTable();
  populateCreateForm();
}

/* Dashboard */
function computeTotals(){
  let income=0, expense=0, cash=Number(settings.opening_today || 0);
  transactions.forEach(t=>{
    const amt = Number(t.amount||0);
    if(t.type === 'income'){ income += amt; if(t.pay === 'Cash') cash += amt; }
    if(t.type === 'expense'){ expense += amt; if(t.pay === 'Cash') cash -= amt; }
  });
  return {income,expense,cash};
}
function renderDashboard(){
  const totals = computeTotals();
  $('#totalIncome').innerText = money(totals.income);
  $('#totalExpense').innerText = money(totals.expense);
  $('#cashRemain').innerText = money(totals.cash);
  $('#profitTag').innerText = ''; // reserved
}

/* Recent transactions small table on dashboard */
function renderRecentTransactions(){
  const tbody = $('#recentTxTbody');
  tbody.innerHTML = '';
  const recent = transactions.slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,8);
  if(!recent.length){
    tbody.innerHTML = '<tr><td colspan="5" class="small-muted">No recent transactions</td></tr>';
    return;
  }
  recent.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.type}</td><td>${r.category||'-'}</td><td>${r.pay||'-'}</td><td>${money(r.amount)}</td>`;
    tbody.appendChild(tr);
  });
}

/* Transactions view */
$('#txAddBtn').addEventListener('click', ()=>{
  const type = $('#txType').value;
  const cat = $('#txCategory').value || (type==='income'?'Sale':'General');
  const amount = Number($('#txAmount').value || 0);
  const date = $('#txDate').value || todayISO();
  const pay = $('#txPay').value || 'Cash';
  if(!amount){ alert('Enter amount'); return; }
  const tx = {id: uid(6), date, type, category:cat, amount, pay, createdAt:Date.now()};
  transactions.push(tx); save(KEY_TRANSACTIONS, transactions);
  // update totals and recent
  renderRecentTransactions(); renderDashboard(); renderTransactionsTable(); renderInvoiceList();
  $('#txAmount').value=''; $('#txCategory').value='';
});

/* Transactions table (filters) */
function renderTransactionsTable(filtered){
  const tb = $('#txTableBody');
  tb.innerHTML = '';
  let list = transactions.slice().sort((a,b)=>b.date.localeCompare(a.date));
  if(filtered) list = filtered;
  if(!list.length){ tb.innerHTML = '<tr><td colspan="6" class="small-muted">No transactions added</td></tr>'; return; }
  list.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.date}</td><td>${t.type}</td><td>${t.category}</td><td>${t.pay}</td><td>${money(t.amount)}</td>
      <td><button class="btn-ghost" data-id="${t.id}" data-act="del">Del</button></td>`;
    tb.appendChild(tr);
  });
}
$('#filterTxBtn').addEventListener('click', ()=>{
  const start = $('#txFilterStart').value;
  const end = $('#txFilterEnd').value;
  const type = $('#txFilterType').value;
  let filtered = transactions.slice();
  if(start) filtered = filtered.filter(t=>t.date >= start);
  if(end) filtered = filtered.filter(t=>t.date <= end);
  if(type && type!=='all') filtered = filtered.filter(t=>t.type===type);
  renderTransactionsTable(filtered);
});
$('#txTableBody').addEventListener('click', (e)=>{
  if(e.target.dataset.act === 'del'){ const id = e.target.dataset.id; transactions = transactions.filter(t=>t.id!==id); save(KEY_TRANSACTIONS, transactions); renderRecentTransactions(); renderTransactionsTable(); renderDashboard(); }
});

/* Export transactions CSV */
function downloadCSV(filename, rows){
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
$('#exportTxCsv').addEventListener('click', ()=>{
  const rows = [['date','type','category','pay','amount']];
  transactions.forEach(t=>rows.push([t.date,t.type,t.category,t.pay,t.amount]));
  downloadCSV('transactions.csv', rows);
});

/* =========================
   Create invoice logic
   ========================= */
const DEFAULT_PRODUCT_ROWS = 4;

function blankProductRow(idx){
  return {id: uid(4), desc:'', qty:'', rate:'', discPct:0, amount:0, position: idx};
}

/* Render products for current invoice */
function populateCreateForm(invoice){
  // invoice param optional (for open edit)
  const pid = $('#invoiceId'); const pdate = $('#invoiceDate'); const pcust = $('#invoiceCustomer'); const pay = $('#invoicePay');
  if(invoice){
    pid.value = invoice.id;
    pdate.value = invoice.date;
    pcust.value = invoice.customer;
    pay.value = invoice.pay || 'Cash';
  } else {
    pid.value = uid(6);
    pdate.value = todayISO();
    pcust.value = '';
    pay.value = 'Cash';
  }
  // product rows
  const rows = (invoice && invoice.items) ? invoice.items : Array.from({length:DEFAULT_PRODUCT_ROWS},(_,i)=>blankProductRow(i+1));
  renderProductRows(rows);
  recalcTotals();
}

function renderProductRows(rows){
  const wrap = $('#productsList'); wrap.innerHTML = '';
  rows.forEach((r, idx)=>{
    const row = el(`<div class="invoice-row product-row" data-row="${r.id}">
      <div class="prod-left">${idx+1}</div>
      <div class="prod-mid"><input class="prod-desc" placeholder="Product description" value="${r.desc||''}" style="width:100%"/></div>
      <div class="prod-right">
        <div class="product-fields">
          <input class="prod-qty" placeholder="Qty" value="${r.qty||''}" style="width:70px"/>
          <input class="prod-rate" placeholder="Rate" value="${r.rate||''}" style="width:90px"/>
          <input class="prod-disc" placeholder="Disc%" value="${r.discPct||0}" style="width:60px"/>
        </div>
        <div style="margin-left:12px"><strong class="prod-amount">${money(r.amount)}</strong></div>
        <div><button class="btn-ghost btn-remove" data-id="${r.id}">x</button></div>
      </div>
    </div>`);
    wrap.appendChild(row);
  });
}

/* add product */
$('#addProductBtn').addEventListener('click', ()=>{
  const wrap = $('#productsList');
  const newRow = blankProductRow(wrap.children.length+1);
  const rows = Array.from(wrap.querySelectorAll('.invoice-row')).map((node,i)=>({
    id: node.dataset.row,
    desc: node.querySelector('.prod-desc').value,
    qty: node.querySelector('.prod-qty').value,
    rate: node.querySelector('.prod-rate').value,
    discPct: node.querySelector('.prod-disc').value || 0,
  }));
  rows.push(newRow);
  renderProductRows(rows);
});

/* clear products */
$('#clearProductsBtn').addEventListener('click', ()=> renderProductRows(Array.from({length:DEFAULT_PRODUCT_ROWS}).map((_,i)=>blankProductRow(i+1))));

/* product field actions (delegation) */
$('#productsList').addEventListener('input', (e)=>{
  if(e.target.matches('.prod-qty,.prod-rate,.prod-disc,.prod-desc')){
    recalcTotals();
  }
});
$('#productsList').addEventListener('click', (e)=>{
  if(e.target.matches('.btn-remove')){
    const id = e.target.dataset.id;
    const nodes = Array.from(document.querySelectorAll('#productsList .invoice-row'));
    const rows = nodes.map(n=>({
      id:n.dataset.row,
      desc:n.querySelector('.prod-desc').value,
      qty:n.querySelector('.prod-qty').value,
      rate:n.querySelector('.prod-rate').value,
      discPct:n.querySelector('.prod-disc').value||0
    })).filter(r=>r.id !== id);
    renderProductRows(rows);
    recalcTotals();
  }
});

/* recalc totals */
function recalcTotals(){
  const nodes = Array.from(document.querySelectorAll('#productsList .invoice-row'));
  let subtotal = 0;
  nodes.forEach(node=>{
    const qty = Number(node.querySelector('.prod-qty').value || 0);
    const rate = Number(node.querySelector('.prod-rate').value || 0);
    const disc = Number(node.querySelector('.prod-disc').value || 0);
    let amount = qty * rate;
    if(disc) amount = amount * (1 - disc/100);
    subtotal += amount;
    node.querySelector('.prod-amount').innerText = money(amount);
  });
  document.getElementById('subtotal').innerText = money(subtotal);
  const taxPct = Number($('#taxPct').value || 0);
  const tax = subtotal * (taxPct/100);
  const total = subtotal + tax;
  $('#totalSum').innerText = money(total);
}

/* recalc button */
$('#recalcBtn').addEventListener('click', recalcTotals);
$('#taxPct').addEventListener('input', recalcTotals);

/* Save invoice */
$('#saveInvoiceBtn').addEventListener('click', ()=>{
  const id = $('#invoiceId').value || uid(6);
  const date = $('#invoiceDate').value || todayISO();
  const customer = $('#invoiceCustomer').value || '';
  const pay = $('#invoicePay').value || 'Cash';
  const prodNodes = Array.from(document.querySelectorAll('#productsList .invoice-row'));
  const items = prodNodes.map((node,idx)=>({
    id: node.dataset.row,
    desc: node.querySelector('.prod-desc').value,
    qty: Number(node.querySelector('.prod-qty').value || 0),
    rate: Number(node.querySelector('.prod-rate').value || 0),
    discPct: Number(node.querySelector('.prod-disc').value || 0),
    amount: Number(node.querySelector('.prod-amount').innerText.replace('₹','') || 0),
    pos: idx+1
  })).filter(i=>i.qty || i.rate || i.desc);
  const subtotal = Number(document.getElementById('subtotal').innerText.replace('₹','')||0);
  const taxPct = Number($('#taxPct').value||0);
  const tax = subtotal * (taxPct/100);
  const total = subtotal + tax;
  const inv = {id,date,customer,pay,items,subtotal,taxPct,tax,total,createdAt:Date.now()};
  invoices.push(inv);
  save(KEY_INVOICES, invoices);

  // Also create a transaction record (sales income)
  const tx = {id: uid(6), date, type:'income', category:'Sale', amount: total, pay, invoiceId:id, createdAt:Date.now()};
  transactions.push(tx);
  save(KEY_TRANSACTIONS, transactions);

  alert('Invoice saved');
  populateCreateForm(); // new blank id
  renderInvoiceList();
  renderRecentTransactions();
  renderDashboard();
  renderPrintableSelect();
});

/* Print invoice */
$('#printInvoiceBtn').addEventListener('click', ()=>{
  // create a transient printable invoice of current form
  const data = gatherInvoiceForm();
  if(!data) { alert('No items to print'); return; }
  openPrintableWindow(data);
});

/* gather current form values (used by print/save) */
function gatherInvoiceForm(){
  const id = $('#invoiceId').value || uid(6);
  const date = $('#invoiceDate').value || todayISO();
  const customer = $('#invoiceCustomer').value || '';
  const pay = $('#invoicePay').value || 'Cash';
  const prodNodes = Array.from(document.querySelectorAll('#productsList .invoice-row'));
  const items = prodNodes.map((node,idx)=>({
    id: node.dataset.row,
    desc: node.querySelector('.prod-desc').value,
    qty: Number(node.querySelector('.prod-qty').value || 0),
    rate: Number(node.querySelector('.prod-rate').value || 0),
    discPct: Number(node.querySelector('.prod-disc').value || 0),
    amount: Number(node.querySelector('.prod-amount').innerText.replace('₹','') || 0),
    pos: idx+1
  })).filter(i=>i.qty || i.rate || i.desc);
  if(!items.length) return null;
  const subtotal = Number(document.getElementById('subtotal').innerText.replace('₹','')||0);
  const taxPct = Number($('#taxPct').value||0);
  const tax = subtotal * (taxPct/100);
  const total = subtotal + tax;
  return {id,date,customer,pay,items,subtotal,taxPct,tax,total};
}

/* Reset invoice form */
$('#resetInvoiceBtn').addEventListener('click', ()=>{
  if(!confirm('Reset invoice form?')) return;
  populateCreateForm();
});

/* =========================
   Invoice List / Printable / Actions
   ========================= */

function renderInvoiceList(){
  const tbody = $('#invoicesTbody');
  tbody.innerHTML = '';
  if(!invoices.length){
    tbody.innerHTML = '<tr><td colspan="6" class="small-muted">No invoices</td></tr>'; return;
  }
  invoices.slice().reverse().forEach(inv=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${inv.id}</td><td>${inv.date}</td><td>${inv.customer||'-'}</td><td>${inv.pay||'-'}</td><td>${money(inv.total||0)}</td>
      <td class="actions">
        <button class="btn-ghost" data-act="open" data-id="${inv.id}">Open</button>
        <button class="btn-ghost" data-act="print" data-id="${inv.id}">Print</button>
        <button class="btn-danger" data-act="del" data-id="${inv.id}">Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* Clicks in invoice list */
$('#invoicesTbody').addEventListener('click', (e)=>{
  const btn = e.target;
  const act = btn.dataset.act;
  const id = btn.dataset.id;
  if(!act) return;
  const inv = invoices.find(x=>x.id===id);
  if(!inv && act!=='del') { alert('Invoice not found'); return; }
  if(act==='open'){
    // open in create editor for editing (we'll populate form but won't auto-delete original)
    setView('create'); populateCreateForm(inv);
  } else if(act==='print'){
    openPrintableWindow(inv);
  } else if(act==='del'){
    if(!confirm('Move invoice to trash?')) return;
    invoices = invoices.filter(i=>i.id!==id);
    save(KEY_INVOICES, invoices);
    trash.push(inv);
    save(KEY_TRASH, trash);
    // remove associated transaction(s)
    transactions = transactions.filter(t=>t.invoiceId !== id);
    save(KEY_TRANSACTIONS, transactions);
    renderInvoiceList(); renderPrintableSelect(); renderTrashCount(); renderTransactionsTable(); renderDashboard();
  }
});

/* printable dropdown */
function renderPrintableSelect(){
  const sel = $('#printableSelect');
  sel.innerHTML = '';
  const blankOpt = document.createElement('option');
  blankOpt.value = '';
  blankOpt.innerText = '-- select invoice --';
  sel.appendChild(blankOpt);
  invoices.forEach(inv=>{
    const opt = document.createElement('option');
    opt.value = inv.id;
    opt.innerText = `${inv.id} — ${inv.date} — ${inv.customer || ''}`;
    sel.appendChild(opt);
  });
}
$('#openPrintableBtn').addEventListener('click', ()=>{
  const id = $('#printableSelect').value;
  if(!id){ alert('Select an invoice'); return; }
  const inv = invoices.find(i=>i.id===id);
  if(!inv){ alert('Invoice not found'); return; }
  openPrintableWindow(inv);
});

/* Printable window generator */
function openPrintableWindow(inv){
  const win = window.open('about:blank','_blank','width=800,height=900');
  if(!win) { alert('Popup blocked - allow popups for printing'); return; }
  const doc = win.document;
  const html = generatePrintableHtml(inv);
  doc.open();
  doc.write(html);
  doc.close();
  // Wait a bit so resources render (not necessary here) then trigger print.
  setTimeout(()=>{ win.focus(); /* don't auto print to allow preview; we can call win.print() if desired */ }, 200);
}

/* Printable HTML (portrait A4 friendly) */
function generatePrintableHtml(inv){
  // Company data - user requested phone and gst
  const company = {
    name: 'JBS KNIT WEAR',
    addr: '3(2)/2B, Nesavalar Colony 2nd Street, P.N.Road, Tirupur',
    phone: '9791902205',
    gst: '33CKAPJ7513F1ZK'
  };
  // build rows
  const rowsHtml = (inv.items||[]).map((it,idx)=>`<tr>
    <td style="padding:6px;border:1px solid #ccc;text-align:center">${idx+1}</td>
    <td style="padding:6px;border:1px solid #ccc">${escapeHtml(it.desc||'')}</td>
    <td style="padding:6px;border:1px solid #ccc;text-align:center">${it.qty||0}</td>
    <td style="padding:6px;border:1px solid #ccc;text-align:right">${Number(it.rate||0).toFixed(2)}</td>
    <td style="padding:6px;border:1px solid #ccc;text-align:right">${Number(it.amount||0).toFixed(2)}</td>
  </tr>`).join('');
  const totalWords = numberToWords(Math.round(inv.total || 0));
  // create printable HTML
  return `
  <!doctype html>
  <html>
  <head>
    <meta charset="utf-8">
    <title>Invoice ${inv.id}</title>
    <style>
      @media print { @page { size: A4 portrait; margin:20mm } body{margin:0} }
      body{font-family: Arial, Helvetica, sans-serif;padding:20px;color:#111}
      .company{font-weight:800;font-size:20px}
      .small{font-size:12px;color:#333}
      table{width:100%;border-collapse:collapse;margin-top:12px}
      th,td{font-size:12px}
      .right{text-align:right}
      .tot{font-weight:800}
    </style>
  </head>
  <body>
    <div style="display:flex;justify-content:space-between">
      <div>
        <div class="company">${escapeHtml(company.name)}</div>
        <div class="small">${escapeHtml(company.addr)}</div>
        <div class="small">Phone: ${escapeHtml(company.phone)}</div>
        <div class="small">GSTIN: ${escapeHtml(company.gst)}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">Date: ${escapeHtml(inv.date)}</div>
        <div style="font-weight:700">Invoice: ${escapeHtml(inv.id)}</div>
        <div style="margin-top:20px">Customer: ${escapeHtml(inv.customer||'')}</div>
        <div>Payment: ${escapeHtml(inv.pay||'')}</div>
      </div>
    </div>

    <table style="margin-top:12px">
      <thead>
        <tr>
          <th style="padding:6px;border:1px solid #ccc;width:40px">#</th>
          <th style="padding:6px;border:1px solid #ccc">Product</th>
          <th style="padding:6px;border:1px solid #ccc;width:80px">Qty</th>
          <th style="padding:6px;border:1px solid #ccc;width:100px">Rate</th>
          <th style="padding:6px;border:1px solid #ccc;width:100px">Amount</th>
        </tr>
      </thead>
      <tbody>
        ${rowsHtml}
        ${inv.items.length < 4 ? Array.from({length: 4 - inv.items.length}).map(()=>`<tr><td style="padding:6px;border:1px solid #ccc"></td><td style="padding:6px;border:1px solid #ccc"></td><td style="padding:6px;border:1px solid #ccc"></td><td style="padding:6px;border:1px solid #ccc"></td><td style="padding:6px;border:1px solid #ccc"></td></tr>`).join('') : ''}
      </tbody>
    </table>

    <div style="margin-top:12px;text-align:right">
      <div>Subtotal: ${money(inv.subtotal)}</div>
      <div>Tax (${inv.taxPct||0}%): ${money(inv.tax||0)}</div>
      <div class="tot">Total: ${money(inv.total||0)}</div>
    </div>

    <div style="margin-top:18px">Rupees: ${escapeHtml(totalWords)}</div>

    <div style="margin-top:28px">Signature: ______________________</div>
  </body>
  </html>
  `;
}

/* helper to escape html */
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c]); }

/* number to words (simple, for print) */
function numberToWords(n){
  if(n===0) return 'zero';
  const a = ['','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
  const b = ['', '', 'twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
  function inWords(num){
    if(num<20) return a[num];
    if(num<100) return b[Math.floor(num/10)] + (num%10? ' ' + a[num%10]:'');
    if(num<1000) return a[Math.floor(num/100)] + ' hundred' + (num%100? ' ' + inWords(num%100):'');
    if(num<100000) return inWords(Math.floor(num/1000)) + ' thousand' + (num%1000? ' ' + inWords(num%1000):'');
    return num.toString();
  }
  return inWords(n);
}

/* =========================
   Exports & EOD
   ========================= */
$('#exportAllCsv').addEventListener('click', ()=>{
  const rows=[['Invoice','Date','Customer','Pay','Total','Items']];
  invoices.forEach(inv=> rows.push([inv.id,inv.date,inv.customer,inv.pay,inv.total,(inv.items||[]).map(it=>`${it.desc} x${it.qty} @${it.rate}`).join('; ')]));
  downloadCSV('invoices_all.csv', rows);
});
$('#exportCash').addEventListener('click', ()=>{
  const rows=[['Invoice','Date','Customer','Pay','Total','Items']];
  invoices.filter(i=>i.pay==='Cash').forEach(inv=> rows.push([inv.id,inv.date,inv.customer,inv.pay,inv.total,(inv.items||[]).map(it=>`${it.desc} x${it.qty}`).join('; ')]));
  downloadCSV('invoices_cash.csv', rows);
});
$('#exportGpay').addEventListener('click', ()=>{
  const rows=[['Invoice','Date','Customer','Pay','Total','Items']];
  invoices.filter(i=>i.pay==='GPay').forEach(inv=> rows.push([inv.id,inv.date,inv.customer,inv.pay,inv.total,(inv.items||[]).map(it=>`${it.desc} x${it.qty}`).join('; ')]));
  downloadCSV('invoices_gpay.csv', rows);
});

/* EOD export button - today's invoices */
$('#eodExport').addEventListener('click', ()=>{
  const today = todayISO();
  const rows=[['Invoice','Date','Customer','Pay','Total']];
  const todays = invoices.filter(i=>i.date===today);
  if(!todays.length) { alert('No invoices for today'); return; }
  todays.forEach(inv=> rows.push([inv.id,inv.date,inv.customer,inv.pay,inv.total]));
  downloadCSV(`eod_${today}.csv`, rows);
});

/* Export/Import backup */
$('#exportBackupBtn').addEventListener('click', ()=>{
  const backup = {invoices,transactions,trash,settings, exportedAt: new Date().toISOString()};
  const blob = new Blob([JSON.stringify(backup, null, 2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='backup_billing.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
$('#importBtn').addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(reader.result);
        if(Array.isArray(obj.invoices)) invoices = obj.invoices;
        if(Array.isArray(obj.transactions)) transactions = obj.transactions;
        if(Array.isArray(obj.trash)) trash = obj.trash;
        if(obj.settings) settings = obj.settings;
        save(KEY_INVOICES, invoices); save(KEY_TRANSACTIONS, transactions); save(KEY_TRASH, trash); save(KEY_SETTINGS, settings);
        alert('Import successful');
        refreshAll();
      } catch(err){ alert('Import failed: '+err.message); }
    };
    reader.readAsText(file);
  };
  input.click();
});

/* Trash button */
$('#trashBtn').addEventListener('click', ()=>{
  if(!trash.length) { alert('Trash empty'); return; }
  if(confirm('Permanently delete trash? This cannot be undone.')){ trash = []; save(KEY_TRASH, trash); renderTrashCount(); alert('Trash cleared'); }
});
function renderTrashCount(){ $('#trashCount').innerText = trash.length; }

/* Printable list refresh done in renderPrintableSelect */

/* Printable template open from invoice list has been provided */

/* =========================
   Transactions created when invoice saved -> done above
   Dashboard refresh after saving also done above
   ========================= */

/* =========================
   Initial render & wiring
   ========================= */
function init(){
  // set opening value if present
  $('#openingInput').value = settings.opening_today || 0;
  $('#setOpening').addEventListener('click', ()=>{
    const v = Number($('#openingInput').value || 0);
    settings.opening_today = v; save(KEY_SETTINGS, settings); renderDashboard();
  });
  $('#clearOpening').addEventListener('click', ()=>{
    settings.opening_today = 0; save(KEY_SETTINGS, settings); $('#openingInput').value = ''; renderDashboard();
  });

  // quick add panel
  $('#quickAddBtn').addEventListener('click', ()=>{
    const amt = Number($('#quickTotal').value || 0);
    if(!amt){ alert('Enter amount'); return; }
    const tx = {id: uid(5), date: todayISO(), type:'income', category: 'Quick', amount: amt, pay:'Cash', createdAt:Date.now()};
    transactions.push(tx); save(KEY_TRANSACTIONS, transactions); renderRecentTransactions(); renderDashboard(); $('#quickTotal').value='';
  });
  $('#quickToCreate').addEventListener('click', ()=>{ setView('create'); });

  // search invoices
  $('#searchInvoice').addEventListener('input', (e)=> {
    const q = e.target.value.toLowerCase().trim();
    const tbody = $('#invoicesTbody'); tbody.innerHTML='';
    const list = invoices.filter(inv => (!q) || inv.id.toLowerCase().includes(q) || (inv.customer||'').toLowerCase().includes(q));
    if(!list.length) { tbody.innerHTML = '<tr><td colspan="6" class="small-muted">No invoices</td></tr>'; return; }
    list.forEach(inv=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${inv.id}</td><td>${inv.date}</td><td>${inv.customer||'-'}</td><td>${inv.pay||'-'}</td><td>${money(inv.total||0)}</td>
        <td class="actions">
          <button class="btn-ghost" data-act="open" data-id="${inv.id}">Open</button>
          <button class="btn-ghost" data-act="print" data-id="${inv.id}">Print</button>
          <button class="btn-danger" data-act="del" data-id="${inv.id}">Del</button>
        </td>`;
      tbody.appendChild(tr);
    });
  });

  // printable select init
  renderPrintableSelect();

  // render create form blank
  populateCreateForm();

  // initial render
  refreshAll();
}
init();

/* JSON -> CSV downloader for invoices and transactions used above */

</script>
</body>
</html>
