<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing — JBS KNIT WEAR</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg:#f3f6f8; --card:#fff; --muted:#6b7280; --accent:#0a66ff;
    --radius:12px; --sidebar-w:260px; --gap:22px;
    font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#111}
  a{color:inherit}
  /* layout */
  .app{min-height:100vh;display:flex;align-items:stretch}
  .sidebar{
    width:var(--sidebar-w);background:linear-gradient(#ffffff, #fbfdff);
    box-shadow: 0 0 0 1px rgba(15,23,42,0.02), 0 6px 22px rgba(15,23,42,0.04);
    padding:24px 18px;box-sizing:border-box;
    position:relative;
  }
  .brand{font-weight:800;font-size:20px;margin:4px 0 8px}
  .brand-sub{font-size:12px;color:var(--muted);display:block;margin-bottom:16px}
  .nav{margin-top:18px}
  .nav button{display:block;width:100%;text-align:left;padding:12px 12px;border-radius:9px;border:0;background:transparent;color:#0b1220;font-weight:600;margin-bottom:6px;cursor:pointer}
  .nav button small{display:block;font-weight:400;color:var(--muted);font-size:12px;margin-top:3px}
  .nav button.active{background:linear-gradient(90deg,#ecf5ff,#fff);box-shadow:inset 0 0 0 3px rgba(10,102,255,0.06);border-left:4px solid var(--accent);padding-left:10px}
  .tip{font-size:12px;color:var(--muted);margin-top:14px}
  /* top bar for mobile toggle */
  .topbar{display:none;align-items:center;justify-content:space-between;padding:12px 18px;background:transparent}
  .topbar .menu-btn{width:36px;height:36px;border-radius:8px;border:0;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.06);cursor:pointer}
  /* content */
  .main{flex:1;padding:28px 32px;box-sizing:border-box}
  .header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .opening{display:flex;gap:8px;align-items:center}
  .opening input{padding:10px 12px;border-radius:8px;border:1px solid #e6edf3;background:#fff}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  /* cards */
  .panel{background:var(--card);padding:22px;border-radius:var(--radius);box-shadow:0 8px 30px rgba(15,23,42,0.06)}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:22px}
  .dashboard-cards{display:flex;gap:12px;flex-wrap:wrap}
  .stat{flex:1;min-width:160px;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(15,23,42,0.03)}
  .stat .label{color:var(--muted);font-size:13px}
  .stat .value{font-size:20px;font-weight:800;margin-top:6px}
  .section-title{font-size:22px;font-weight:800;margin-bottom:12px}
  /* invoice create */
  .form-row{display:flex;gap:10px;align-items:center}
  .input, .select, .date{padding:10px 12px;border-radius:8px;border:1px solid #e6edf3;background:#fff;min-height:40px;box-sizing:border-box}
  .products .row{display:flex;align-items:center;gap:14px;padding:14px;border-radius:10px;border:1px solid #eef3f7;margin-bottom:10px;background:#fff}
  .products .sno{width:36px;text-align:center;color:var(--muted)}
  .products .desc{flex:1}
  .products .qty,.products .rate,.products .disc,.products .amount{width:90px;text-align:center}
  .products .amount{font-weight:700}
  .small{font-size:13px;color:var(--muted)}
  .actions{display:flex;gap:10px;align-items:center;margin-top:8px}
  .btn-outline{background:#fff;border:1px solid #e6edf3;padding:8px 12px;border-radius:8px;cursor:pointer}
  /* invoice totals */
  .totals{display:flex;flex-direction:column;align-items:flex-end;gap:8px;margin-top:18px}
  .totals .line{display:flex;gap:14px;align-items:center}
  .totals .label{color:var(--muted)}
  .totals .value{font-weight:800}
  /* transactions table */
  table{width:100%;border-collapse:collapse;background:transparent}
  th,td{padding:12px;border-bottom:1px solid #f1f5f8;text-align:left}
  th{font-weight:700;color:#374151;background:#fff}
  .right{text-align:right}
  /* invoice list */
  .invoice-card{padding:12px;border-radius:10px;border:1px solid #eef3f7;background:#fff;margin-bottom:10px}
  /* responsive */
  @media (max-width:1000px){
    .grid{grid-template-columns:1fr}
    .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-120%);transition:transform .28s ease;z-index:40}
    .sidebar.open{transform:translateX(0)}
    .topbar{display:flex}
    .main{padding:12px}
  }
  @media (max-width:520px){
    .sidebar{width:220px}
    .products .qty,.products .rate,.products .disc,.products .amount{width:60px}
    .grid{gap:10px}
  }

  /* print invoice portrait 14cm x 20cm */
  @media print {
    @page { size: 14cm 20cm; margin: 10mm; }
    body *{visibility:hidden}
    .print-area, .print-area *{visibility:visible}
    .print-area{position:fixed;left:0;top:0;width:100%}
  }

  /* small helpers */
  .muted{color:var(--muted)}
  .float-right{float:right}
  .mb{margin-bottom:12px}
</style>
</head>
<body>
<div class="app">
  <div class="sidebar" id="sidebar">
    <div class="brand">JBS KNIT WEAR — <span style="font-weight:700">Billing</span></div>
    <span class="brand-sub">Simple billing for retail</span>
    <nav class="nav" id="nav">
      <button data-view="dashboard" class="active">Dashboard <small>Quick totals & recent</small></button>
      <button data-view="transactions">Transactions <small>Income & expense add</small></button>
      <button data-view="create">Create Invoice <small>Add products & save</small></button>
      <button data-view="invoices">Invoices <small>Saved invoices</small></button>
      <button data-view="printable">Printable template <small>View / print invoice</small></button>
    </nav>
    <div class="tip">Tip: Save then Print from the invoice view.</div>
  </div>

  <div class="main">
    <div class="topbar">
      <button class="menu-btn" id="menuToggle">☰</button>
      <div></div>
      <div class="opening">
        <label class="small muted">Opening balance (today)</label>
        <input id="openingInput" placeholder="0.00" style="width:120px">
        <button class="btn" id="setOpening">Set</button>
        <button class="btn" id="clearOpening" style="background:#fff;color:#111;border:1px solid #e6edf3">Clear</button>
      </div>
    </div>

    <!-- Header for desktop -->
    <div class="header-row">
      <div style="display:flex;align-items:center;gap:18px">
        <h2 style="margin:0">Billing <span style="color:var(--muted);font-weight:400;margin-left:10px">— manage invoices & quick sales</span></h2>
      </div>
      <div class="opening" style="gap:12px">
        <label class="small muted">Opening balance (today)</label>
        <input id="openingInputDesktop" placeholder="0.00" style="width:140px">
        <button class="btn" id="setOpeningDesktop">Set</button>
        <button class="btn" id="clearOpeningDesktop" style="background:#fff;color:#111;border:1px solid #e6edf3">Clear</button>
      </div>
    </div>

    <!-- Views container -->
    <div id="views" style="display:block">
      <!-- DASHBOARD -->
      <div id="view-dashboard" class="view">
        <div class="grid">
          <div>
            <div class="panel">
              <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <div>
                  <div class="section-title">Billing Dashboard</div>
                  <div class="small muted">Quick overview of today's totals and recent activity</div>
                </div>
                <div style="font-weight:800;color:#0472ff">Profit: <span id="profitDisplay">₹0.00</span></div>
              </div>
              <div class="dashboard-cards" style="margin-top:18px">
                <div class="stat"><div class="label">Total Income</div><div class="value" id="totalIncome">₹0.00</div></div>
                <div class="stat"><div class="label">Total Expense</div><div class="value" id="totalExpense">₹0.00</div></div>
                <div class="stat"><div class="label">Profit</div><div class="value" id="profitSmall">₹0.00</div></div>
              </div>

              <div style="margin-top:22px">
                <div class="section-title">Recent transactions</div>
                <div style="display:flex;justify-content:flex-end">
                  <button id="exportAllTransactions" class="btn-outline">Download CSV</button>
                  <button id="exportCashSalesTop" class="btn" style="background:#16a34a;margin-left:8px">Export Cash Sales</button>
                  <button id="exportGPaySalesTop" class="btn" style="background:#059669;margin-left:8px">Export GPay Sales</button>
                </div>
                <div style="margin-top:12px" class="panel">
                  <table>
                    <thead>
                      <tr><th>Date</th><th>Type</th><th>Category</th><th class="right">Amount</th></tr>
                    </thead>
                    <tbody id="recentTransBody">
                      <tr><td colspan="4" class="muted">No recent transactions</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

            </div>
          </div>

          <div>
            <div class="panel">
              <div class="section-title">Quick invoice panel <span class="small muted" style="font-weight:400"> (also in Create Invoice)</span></div>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="quickTotal" class="input" placeholder="Quick total" style="flex:1">
                <button id="quickAddBtn" class="btn" style="padding:8px 12px">Add</button>
              </div>
              <div style="margin-top:12px" class="small muted">Use the left menu to open the full Create Invoice screen for editing and printing.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- TRANSACTIONS -->
      <div id="view-transactions" class="view" style="display:none">
        <div class="panel">
          <div class="section-title">Transactions <span class="small muted">Quick add income & expense</span></div>

          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px">
            <select id="txnType" class="select input" style="width:120px">
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
            <input id="txnCategory" class="input" placeholder="Category" style="width:180px">
            <input id="txnAmount" class="input" placeholder="Amount" style="width:120px">
            <input type="date" id="txnDate" class="date">
            <select id="txnPay" class="select input" style="width:140px">
              <option>Cash</option>
              <option>GPay</option>
              <option>Other</option>
            </select>
            <button id="txnAddBtn" class="btn">Add</button>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input type="date" id="filterFrom" class="date" style="width:150px">
            <input type="date" id="filterTo" class="date" style="width:150px">
            <select id="filterType" class="input" style="width:120px">
              <option value="all">All</option>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
            <select id="filterPay" class="input" style="width:120px">
              <option value="all">All pay</option><option value="Cash">Cash</option><option value="GPay">GPay</option>
            </select>
            <button id="txnFilterBtn" class="btn-outline">Filter</button>
            <button id="txnClearFilterBtn" class="btn-outline">Clear</button>
            <div style="flex:1"></div>
            <button id="exportTxCSV" class="btn" style="background:#16a34a">Download CSV</button>
            <button id="exportCashFromTx" class="btn" style="background:#0b74ff;margin-left:6px">Export Cash Sales</button>
            <button id="exportGPayFromTx" class="btn" style="background:#059669;margin-left:6px">Export GPay Sales</button>
          </div>

          <div style="margin-top:12px">
            <table>
              <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th class="right">Amount</th></tr></thead>
              <tbody id="txnTableBody"><tr><td colspan="5" class="muted">No transactions added</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CREATE INVOICE -->
      <div id="view-create" class="view" style="display:none">
        <div class="panel">
          <div class="section-title">Create Invoice</div>

          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <input id="invNo" class="input" placeholder="Invoice no (auto)" style="width:260px">
            <input id="invDate" type="date" class="date" style="width:160px">
            <input id="invCustomer" class="input" placeholder="Customer name" style="flex:1">
          </div>

          <div style="margin-top:10px">
            <label class="small muted">Payment Method</label>
            <select id="invPayment" class="input" style="width:200px;margin-top:6px">
              <option>Cash</option><option>GPay</option><option>Other</option>
            </select>
          </div>

          <div style="margin-top:14px">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div class="small muted">Products</div>
              <div class="actions">
                <button id="addProd" class="btn-outline">+ Add</button>
                <button id="clearProd" class="btn-outline">Clear</button>
                <button id="recalc" class="btn-outline">Recalc</button>
              </div>
            </div>

            <div class="products" id="prodList" style="margin-top:12px">
              <!-- product rows inserted here -->
            </div>

            <div class="totals">
              <div class="line"><div class="label">Subtotal:</div><div class="value" id="invSubtotal">₹0.00</div></div>
              <div class="line"><div class="label">Tax %:</div><input id="invTax" class="input" style="width:80px" value="0"></div>
              <div class="line"><div class="label" style="font-size:18px">Total:</div><div class="value" id="invTotal" style="font-size:18px">₹0.00</div></div>
            </div>

            <div style="margin-top:16px;display:flex;gap:10px">
              <button id="saveInvoice" class="btn">Save</button>
              <button id="printInvoice" class="btn-outline">Print</button>
              <button id="resetInvoice" class="btn-outline" style="background:#fff;border:1px solid #ff9b87">Reset</button>
            </div>
          </div>
        </div>
      </div>

      <!-- INVOICE LIST -->
      <div id="view-invoices" class="view" style="display:none">
        <div class="panel">
          <div class="section-title">Invoices</div>
          <div id="invoiceList" style="margin-top:12px">
            <!-- saved invoices -->
          </div>
        </div>
      </div>

      <!-- PRINTABLE TEMPLATE (preview) -->
      <div id="view-printable" class="view" style="display:none">
        <div class="panel">
          <div class="section-title">Printable Template</div>
          <div style="margin-top:12px">
            <select id="printInvoiceSelect" class="input" style="width:260px"></select>
            <button id="openPrintable" class="btn" style="margin-left:8px">Open</button>
            <button id="downloadPDF" class="btn-outline" style="margin-left:8px">Print (Browser)</button>
          </div>
          <div style="margin-top:18px">
            <div id="printPreview" style="border:1px solid #e7eef6;padding:12px;background:#fff"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- PRINT AREA TEMPLATE (hidden) -->
<template id="invoicePrintTpl">
  <div class="print-area" style="font-family:Arial,Helvetica,sans-serif;color:#111;padding:12px">
    <div style="text-align:center;font-weight:800;font-size:20px">JBS KNIT WEAR</div>
    <div style="text-align:center;font-size:12px;margin-top:4px">3(2)/2B, Nesavalar Colony 2nd Street, P.N.Road, Tirupur - 641602</div>
    <div style="text-align:center;font-weight:700;margin-top:6px">GSTIN: 33CKAPJ7513F1ZK</div>
    <hr style="margin:10px 0">
    <div style="display:flex;justify-content:space-between">
      <div>
        <div>Date: <span id="p_date"></span></div>
        <div>Invoice ID: <span id="p_inv"></span></div>
        <div>Customer: <span id="p_cust"></span></div>
        <div>Phone: <span id="p_phone"></span></div>
        <div>Payment: <span id="p_pay"></span></div>
      </div>
    </div>
    <table style="width:100%;border-collapse:collapse;margin-top:12px;font-size:13px">
      <thead><tr><th style="border:1px solid #999;padding:6px">#</th><th style="border:1px solid #999;padding:6px">Product</th><th style="border:1px solid #999;padding:6px">Qty</th><th style="border:1px solid #999;padding:6px">Rate</th><th style="border:1px solid #999;padding:6px">Amount</th></tr></thead>
      <tbody id="p_rows"></tbody>
    </table>
    <div style="text-align:right;font-weight:700;margin-top:12px">Total: ₹<span id="p_total"></span></div>
    <div style="margin-top:18px;font-size:12px">For JBS KNIT WEAR</div>
  </div>
</template>

<script>
/* ---------------------
  Simple client-side state using localStorage
   - invoices: [ {id,date,customer,payment,rows:[{desc,qty,rate,amount}],total} ]
   - transactions: [ {id,date,type,category,pay,amount} ]
----------------------*/
const STORAGE = {
  invoices: 'billing_invoices_v1',
  transactions: 'billing_transactions_v1',
  opening_today: 'billing_opening_today_v1'
};

let STATE = {
  invoices: JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]'),
  transactions: JSON.parse(localStorage.getItem(STORAGE.transactions) || '[]')
};

/* utils */
function saveState(){
  localStorage.setItem(STORAGE.invoices, JSON.stringify(STATE.invoices));
  localStorage.setItem(STORAGE.transactions, JSON.stringify(STATE.transactions));
}
function uid(prefix='id'){ return prefix + Date.now() + Math.floor(Math.random()*999); }
function money(v){ return '₹' + Number(v||0).toFixed(2); }
function fmtDate(d){
  if(!d) return '';
  const dt = new Date(d);
  if (isNaN(dt)) return d;
  return dt.toLocaleDateString();
}

/* sidebar nav */
const navButtons = document.querySelectorAll('#nav button');
function showView(name){
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  const el = document.getElementById('view-'+name);
  if(el) el.style.display='block';
  navButtons.forEach(b=>b.classList.toggle('active', b.getAttribute('data-view')===name));
  // scroll small screens to top of main area
  if(window.innerWidth < 1000) window.scrollTo({top:0,behavior:'smooth'});
}
navButtons.forEach(btn=>{
  btn.addEventListener('click', ()=> showView(btn.dataset.view));
});

/* mobile sidebar toggle */
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
if(menuToggle){
  menuToggle.addEventListener('click', ()=> sidebar.classList.toggle('open'));
}
window.addEventListener('resize', ()=> { if(window.innerWidth >= 1000) sidebar.classList.remove('open'); });

/* Opening balance controls */
function setOpening(val){
  localStorage.setItem(STORAGE.opening_today, String(val));
  alert('Opening balance set: ₹' + Number(val||0).toFixed(2));
  renderDashboard();
}
document.getElementById('setOpening').addEventListener('click', ()=> setOpening(document.getElementById('openingInput').value));
document.getElementById('setOpeningDesktop').addEventListener('click', ()=> setOpening(document.getElementById('openingInputDesktop').value));
document.getElementById('clearOpening').addEventListener('click', ()=> { localStorage.removeItem(STORAGE.opening_today); alert('Opening cleared'); renderDashboard(); });
document.getElementById('clearOpeningDesktop').addEventListener('click', ()=> { localStorage.removeItem(STORAGE.opening_today); alert('Opening cleared'); renderDashboard(); });

/* Dashboard render */
function renderDashboard(){
  // totals from transactions (income/expense) + invoices (sales)
  let income=0, expense=0;
  STATE.transactions.forEach(t => {
    const a = Number(t.amount||0);
    if(String(t.type).toLowerCase()==='income') income += a;
    else expense += a;
  });
  // invoices: treat as income
  STATE.invoices.forEach(inv => income += Number(inv.total||0));
  document.getElementById('totalIncome').innerText = money(income);
  document.getElementById('totalExpense').innerText = money(expense);
  document.getElementById('profitSmall').innerText = money(income - expense);
  document.getElementById('profitDisplay').innerText = money(income - expense);

  // recent transactions list (last 6)
  const recent = STATE.transactions.slice().reverse().slice(0,6);
  const tbody = document.getElementById('recentTransBody');
  tbody.innerHTML = '';
  if(!recent.length){ tbody.innerHTML = '<tr><td colspan="4" class="muted">No recent transactions</td></tr>'; return; }
  recent.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmtDate(r.date)}</td><td>${r.type}</td><td>${r.category||''}</td><td class="right">${money(r.amount)}</td>`;
    tbody.appendChild(tr);
  });
}
renderDashboard();

/* Transactions logic */
const txnTableBody = document.getElementById('txnTableBody');
function renderTransactions(filter={}){
  let rows = STATE.transactions.slice().reverse();
  if(filter.type && filter.type!=='all') rows = rows.filter(r=>r.type===filter.type);
  if(filter.pay && filter.pay!=='all') rows = rows.filter(r=>r.pay===filter.pay);
  if(filter.from) rows = rows.filter(r=> new Date(r.date) >= new Date(filter.from));
  if(filter.to) rows = rows.filter(r=> new Date(r.date) <= new Date(filter.to));
  txnTableBody.innerHTML = '';
  if(!rows.length){ txnTableBody.innerHTML = '<tr><td colspan="5" class="muted">No transactions added</td></tr>'; return; }
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmtDate(r.date)}</td><td>${r.type}</td><td>${r.category}</td><td>${r.pay}</td><td class="right">${money(r.amount)}</td>`;
    txnTableBody.appendChild(tr);
  });
}
renderTransactions({});

/* add transaction */
document.getElementById('txnAddBtn').addEventListener('click', ()=>{
  const type = document.getElementById('txnType').value;
  const category = document.getElementById('txnCategory').value || (type==='income'?'sales':'expense');
  const amount = Number(document.getElementById('txnAmount').value || 0);
  const date = document.getElementById('txnDate').value || new Date().toISOString();
  const pay = document.getElementById('txnPay').value || 'Cash';
  if(!amount){ alert('Enter valid amount'); return; }
  const rec = { id: uid('tx'), date, type, category, pay, amount };
  STATE.transactions.push(rec);
  saveState();
  renderTransactions({});
  renderDashboard();
  alert('Transaction added');
});

/* transaction filter buttons */
document.getElementById('txnFilterBtn').addEventListener('click', ()=>{
  renderTransactions({
    from: document.getElementById('filterFrom').value,
    to: document.getElementById('filterTo').value,
    type: document.getElementById('filterType').value,
    pay: document.getElementById('filterPay').value
  });
});
document.getElementById('txnClearFilterBtn').addEventListener('click', ()=> {
  document.getElementById('filterFrom').value='';
  document.getElementById('filterTo').value='';
  document.getElementById('filterType').value='all';
  document.getElementById('filterPay').value='all';
  renderTransactions({});
});

/* CSV helpers */
function csvEscape(v){
  if(v===null||v===undefined) return '';
  v = String(v);
  if(v.includes(',')||v.includes('"')||v.includes('\n')) v = `"${v.replace(/"/g,'""')}"`;
  return v;
}
function downloadCSV(filename, csv){
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* Exports */
/* Export all transactions CSV */
document.getElementById('exportAllTransactions').addEventListener('click', ()=> {
  const header = ['id','date','type','category','pay','amount'].join(',');
  const rows = STATE.transactions.map(t => [csvEscape(t.id), csvEscape(t.date), csvEscape(t.type), csvEscape(t.category), csvEscape(t.pay), Number(t.amount).toFixed(2)].join(','));
  const csv = header + '\n' + rows.join('\n');
  downloadCSV('transactions_all.csv', csv);
});

/* export invoices by payment method */
function exportInvoicesByPayment(method){
  const header = ['invoiceId','date','customer','payment','line','product','qty','rate','amount','invoiceTotal'].join(',');
  const rows = [];
  STATE.invoices.forEach(inv=>{
    if(String(inv.payment).toLowerCase() === String(method).toLowerCase()){
      (inv.rows || []).forEach((r, idx)=>{
        rows.push([ csvEscape(inv.id), csvEscape(inv.date), csvEscape(inv.customer), csvEscape(inv.payment),
                    idx+1, csvEscape(r.desc), Number(r.qty||0), Number(r.rate||0).toFixed(2), Number(r.amount||0).toFixed(2), Number(inv.total||0).toFixed(2)
                  ].join(','));
      });
    }
  });
  if(!rows.length){ alert('No invoices found for ' + method); return; }
  downloadCSV('invoices_'+method+'.csv', header + '\n' + rows.join('\n'));
}

/* export transactions incomes by pay */
function exportTransactionIncomesByPayment(method){
  const header = ['id','date','type','category','pay','amount'].join(',');
  const rows = STATE.transactions.filter(t=> String(t.type).toLowerCase()==='income' && String(t.pay).toLowerCase() === String(method).toLowerCase())
                .map(t => [csvEscape(t.id), csvEscape(t.date), csvEscape(t.type), csvEscape(t.category), csvEscape(t.pay), Number(t.amount).toFixed(2)].join(','));
  if(!rows.length){ console.warn('No transaction incomes for ' + method); }
  downloadCSV('transactions_incomes_'+method+'.csv', header + '\n' + rows.join('\n'));
}

/* combined export (invoices + transaction incomes) */
function exportSalesForPayment(method){
  exportInvoicesByPayment(method);
  exportTransactionIncomesByPayment(method);
}
document.getElementById('exportCashSalesTop').addEventListener('click', ()=> exportSalesForPayment('Cash'));
document.getElementById('exportGPaySalesTop').addEventListener('click', ()=> exportSalesForPayment('GPay'));
document.getElementById('exportCashFromTx').addEventListener('click', ()=> exportTransactionIncomesByPayment('Cash'));
document.getElementById('exportGPayFromTx').addEventListener('click', ()=> exportTransactionIncomesByPayment('GPay'));
document.getElementById('exportTxCSV').addEventListener('click', ()=> {
  document.getElementById('exportAllTransactions').click();
});

/* --------- Create Invoice logic ---------- */
const prodList = document.getElementById('prodList');
function newProductRow(data){
  const id = uid('row');
  const row = document.createElement('div');
  row.className = 'row';
  row.dataset.id = id;
  row.innerHTML = `
    <div class="sno">${data?.sno||''}</div>
    <div class="desc"><input class="input" placeholder="Product description" style="width:100%" value="${data?.desc||''}"></div>
    <div class="qty"><input type="number" min="0" class="input" value="${data?.qty||0}" style="width:80px;text-align:center"></div>
    <div class="rate"><input type="number" min="0" class="input" value="${data?.rate||0}" style="width:100px;text-align:center"></div>
    <div class="disc"><input type="number" min="0" class="input" value="${data?.disc||0}" style="width:70px;text-align:center"></div>
    <div class="amount">${money(0)}</div>
    <div style="width:24px;text-align:center"><button class="btn-outline removeRow">x</button></div>
  `;
  // event listeners
  row.querySelectorAll('.input').forEach(inp=>{
    inp.addEventListener('input', ()=> recalcRow(row));
  });
  row.querySelector('.removeRow').addEventListener('click', ()=> {
    row.remove(); recalcTotals(); updateRowNumbers();
  });
  prodList.appendChild(row);
  updateRowNumbers();
  return row;
}
function updateRowNumbers(){
  Array.from(prodList.querySelectorAll('.row')).forEach((r,i)=> r.querySelector('.sno').innerText = i+1);
}
function addProduct(data){
  newProductRow(data);
  recalcTotals();
}
document.getElementById('addProd').addEventListener('click', ()=> addProduct({desc:'',qty:0,rate:0,disc:0}));
document.getElementById('clearProd').addEventListener('click', ()=> { prodList.innerHTML=''; recalcTotals(); });
document.getElementById('recalc').addEventListener('click', ()=> recalcTotals());

function recalcRow(row){
  const qty = Number(row.querySelector('.qty input').value || 0);
  const rate = Number(row.querySelector('.rate input').value || 0);
  const disc = Number(row.querySelector('.disc input').value || 0);
  let amt = qty * rate;
  if(disc) amt = amt - (amt * Number(disc)/100);
  row.querySelector('.amount').innerText = money(amt);
  recalcTotals();
}

function recalcTotals(){
  const taxPct = Number(document.getElementById('invTax').value || 0);
  let subtotal = Array.from(prodList.querySelectorAll('.row')).reduce((s,row)=>{
    const amtText = row.querySelector('.amount').innerText.replace(/[^0-9.-]+/g,"");
    return s + Number(amtText || 0);
  },0);
  const tax = subtotal * (taxPct/100);
  const total = subtotal + tax;
  document.getElementById('invSubtotal').innerText = money(subtotal);
  document.getElementById('invTotal').innerText = money(total);
}

/* Save Invoice */
document.getElementById('saveInvoice').addEventListener('click', ()=>{
  const invNo = document.getElementById('invNo').value || ('INV-' + (STATE.invoices.length+1));
  const date = document.getElementById('invDate').value || new Date().toISOString();
  const customer = document.getElementById('invCustomer').value || '';
  const payment = document.getElementById('invPayment').value||'Cash';
  const rows = Array.from(prodList.querySelectorAll('.row')).map(r=>{
    const desc = r.querySelector('.desc input').value || '';
    const qty = Number(r.querySelector('.qty input').value || 0);
    const rate = Number(r.querySelector('.rate input').value || 0);
    const disc = Number(r.querySelector('.disc input').value || 0);
    const amount = Number(r.querySelector('.amount').innerText.replace(/[^0-9.-]+/g,""))||0;
    return {desc, qty, rate, disc, amount};
  });
  const subtotal = rows.reduce((s,r)=>s + Number(r.amount||0), 0);
  const tax = Number(document.getElementById('invTax').value || 0);
  const total = subtotal + (subtotal * tax/100);
  const invoice = { id: invNo, date, customer, payment, rows, subtotal, tax, total };
  STATE.invoices.push(invoice);
  saveState();
  alert('Invoice saved: ' + invNo);
  renderInvoicesList();
  recalcTotals();
  renderDashboard();
});

/* Print invoice: builds a printable window sized to 14x20cm portrait */
document.getElementById('printInvoice').addEventListener('click', ()=> {
  const invoiceData = {
    id: document.getElementById('invNo').value || ('INV-' + (STATE.invoices.length+1)),
    date: document.getElementById('invDate').value || new Date().toISOString(),
    customer: document.getElementById('invCustomer').value || '',
    payment: document.getElementById('invPayment').value || 'Cash',
    phone: '', rows: Array.from(prodList.querySelectorAll('.row')).map(r=>{
      return {desc: r.querySelector('.desc input').value || '', qty: Number(r.querySelector('.qty input').value || 0), rate: Number(r.querySelector('.rate input').value || 0), amount: Number(r.querySelector('.amount').innerText.replace(/[^0-9.-]+/g,""))||0};
    }),
    total: Number(document.getElementById('invTotal').innerText.replace(/[^0-9.-]+/g,""))||0
  };
  openPrintWindow(invoiceData);
});

/* open printable window (portrait 14cm x 20cm) */
function openPrintWindow(inv){
  const tpl = document.getElementById('invoicePrintTpl').content.cloneNode(true);
  tpl.getElementById('p_date').innerText = fmtDate(inv.date);
  tpl.getElementById('p_inv').innerText = inv.id;
  tpl.getElementById('p_cust').innerText = inv.customer;
  tpl.getElementById('p_phone').innerText = inv.phone || '';
  tpl.getElementById('p_pay').innerText = inv.payment;
  const tbody = tpl.querySelector('#p_rows');
  inv.rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="border:1px solid #999;padding:6px">${i+1}</td><td style="border:1px solid #999;padding:6px">${r.desc}</td><td style="border:1px solid #999;padding:6px;text-align:center">${r.qty}</td><td style="border:1px solid #999;padding:6px;text-align:right">${Number(r.rate).toFixed(2)}</td><td style="border:1px solid #999;padding:6px;text-align:right">${Number(r.amount).toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
  tpl.getElementById('p_total').innerText = Number(inv.total||0).toFixed(2);

  const w = window.open('', '_blank', 'width=800,height=1100');
  w.document.write('<!doctype html><html><head><title>Invoice</title>');
  w.document.write('<meta name="viewport" content="width=device-width,initial-scale=1">');
  w.document.write('<style>@page{size:14cm 20cm;margin:10mm}body{font-family:Arial;}</style>');
  w.document.write('</head><body>');
  w.document.body.appendChild(tpl);
  w.document.write('</body></html>');
  w.document.close();
  // wait then print
  setTimeout(()=> { w.focus(); w.print(); }, 500);
}

/* Invoice list */
function renderInvoicesList(){
  const wrap = document.getElementById('invoiceList');
  wrap.innerHTML = '';
  if(!STATE.invoices.length) { wrap.innerHTML = '<div class="muted">No saved invoices</div>'; return;}
  STATE.invoices.slice().reverse().forEach(inv=>{
    const div = document.createElement('div');
    div.className = 'invoice-card';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${inv.id}</strong> <div class="muted" style="font-size:12px">${fmtDate(inv.date)} &nbsp; ${inv.customer || ''}</div></div><div style="text-align:right"><div style="font-weight:800">${money(inv.total)}</div><div class="muted" style="font-size:12px">${inv.payment}</div></div></div>
      <div style="margin-top:8px;display:flex;gap:8px"><button class="btn-outline viewInv">View</button><button class="btn" style="background:#0b74ff;color:#fff" data-id="${inv.id}">Print</button></div>`;
    wrap.appendChild(div);
    div.querySelector('.viewInv').addEventListener('click', ()=>{
      // open printable preview
      const preview = document.getElementById('printPreview');
      preview.innerHTML = '<em>loading...</em>';
      setTimeout(()=> {
        preview.innerHTML = `<div style="font-weight:700">${inv.id} - ${fmtDate(inv.date)}</div><div>${inv.customer||''} - ${inv.payment}</div><table style="width:100%;border-collapse:collapse;margin-top:8px"><thead><tr><th>#</th><th>Product</th><th>Qty</th><th>Rate</th><th>Amount</th></tr></thead><tbody>${(inv.rows||[]).map((r,i)=>`<tr><td>${i+1}</td><td>${r.desc}</td><td>${r.qty}</td><td>${Number(r.rate).toFixed(2)}</td><td>${Number(r.amount).toFixed(2)}</td></tr>`).join('')}</tbody></table><div style="text-align:right;margin-top:8px;font-weight:700">Total: ${money(inv.total)}</div>`;
      },200);
      showView('printable');
      document.getElementById('printInvoiceSelect').value = inv.id;
    });
    div.querySelector('button.btn').addEventListener('click', ()=>{
      openPrintWindow(inv);
    });
  });
}
renderInvoicesList();

/* populate print select */
function populatePrintSelect(){
  const sel = document.getElementById('printInvoiceSelect');
  sel.innerHTML = '<option value="">Select invoice</option>';
  STATE.invoices.forEach(inv => {
    const opt = document.createElement('option'); opt.value = inv.id; opt.text = inv.id + ' — ' + (inv.customer||inv.date);
    sel.appendChild(opt);
  });
}
populatePrintSelect();

document.getElementById('openPrintable').addEventListener('click', ()=>{
  const id = document.getElementById('printInvoiceSelect').value;
  if(!id){ alert('Select invoice'); return; }
  const inv = STATE.invoices.find(i=>i.id===id);
  if(!inv) { alert('Invoice not found'); return; }
  openPrintWindow(inv);
});
document.getElementById('downloadPDF').addEventListener('click', ()=> window.print());

/* Invoice init: create 4 empty rows by default */
function initCreateInvoice(){
  prodList.innerHTML='';
  for(let i=0;i<4;i++) addProduct({desc:'Product description', qty:0, rate:0, disc:0});
  document.getElementById('invDate').value = new Date().toISOString().slice(0,10);
  document.getElementById('invNo').value = 'INV-' + (STATE.invoices.length + 1);
  recalcTotals();
}
initCreateInvoice();

/* quick add total button */
document.getElementById('quickAddBtn').addEventListener('click', ()=>{
  const t = Number(document.getElementById('quickTotal').value || 0);
  if(!t){ alert('Enter amount'); return; }
  const rec = { id: uid('tx'), date: new Date().toISOString(), type:'income', category:'quick', pay:'Cash', amount: t };
  STATE.transactions.push(rec); saveState(); renderTransactions({}); renderDashboard(); alert('Added quick total to transactions');
});

/* Invoice reset */
document.getElementById('resetInvoice').addEventListener('click', ()=> {
  if(confirm('Reset invoice form?')) initCreateInvoice();
});

/* Export buttons on create view (also available earlier) */
document.getElementById('exportCashFromTx').addEventListener('click', ()=> exportTransactionIncomesByPayment('Cash'));
document.getElementById('exportGPayFromTx').addEventListener('click', ()=> exportTransactionIncomesByPayment('GPay'));

/* On page load - wire nav default to dashboard */
showView('dashboard');

/* Render initial transaction table */
renderTransactions({});

/* Ensure invoice list and print select are kept up-to-date when invoices changed */
window.addEventListener('storage', ()=> {
  STATE.invoices = JSON.parse(localStorage.getItem(STORAGE.invoices) || '[]');
  STATE.transactions = JSON.parse(localStorage.getItem(STORAGE.transactions) || '[]');
  renderInvoicesList();
  populatePrintSelect();
  renderDashboard();
});

/* Expose export cash/gpay for top buttons also */
document.getElementById('exportCashSalesTop').addEventListener('click', ()=> exportSalesForPayment('Cash'));
document.getElementById('exportGPaySalesTop').addEventListener('click', ()=> exportSalesForPayment('GPay'));

/* small UX: if user opens create invoice on small screens, close sidebar */
document.querySelectorAll('#nav button').forEach(b=>{
  b.addEventListener('click', ()=>{
    if(window.innerWidth < 1000) sidebar.classList.remove('open');
  });
});

/* render once more */
renderInvoicesList();
populatePrintSelect();
renderDashboard();
</script>
</body>
</html>
