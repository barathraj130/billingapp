<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing — JBS KNIT WEAR</title>
<style>
  :root{
    --bg:#f4f6f8; --card:#ffffff; --muted:#7b8590; --accent:#1777ff;
    --radius:12px; --shadow:0 10px 30px rgba(26,32,47,0.06);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#111;min-height:100vh}
  a{color:var(--accent);text-decoration:none}

  /* APP LAYOUT */
  .app{display:flex;min-height:100vh}
  .sidebar{
    width:260px; background:linear-gradient(180deg,#fff,#fbfdff);
    padding:20px 18px; flex-shrink:0; box-shadow:1px 0 0 rgba(0,0,0,0.03);
    height:100vh; overflow:auto; /* critical: allow scrolling so no clipping */
  }
  .logo{font-weight:800;font-size:18px;margin-bottom:12px}
  .nav{display:flex;flex-direction:column;gap:8px}
  .nav a{display:block;padding:10px 12px;border-radius:8px;color:#222}
  .nav a .sub{display:block;color:var(--muted);font-size:12px;margin-top:4px}
  .nav a.active{box-shadow:inset 4px 0 0 var(--accent);background:rgba(23,119,255,0.06)}

  .content{flex:1;padding:20px;min-height:100vh}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  .top-left{display:flex;gap:8px;align-items:center}
  .menu-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}
  .opening{display:flex;gap:8px;align-items:center}

  .panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:18px}
  .h1{font-size:24px;font-weight:800;margin:0 0 8px}
  .h2{font-size:18px;font-weight:700;margin:0 0 8px}
  .muted{color:var(--muted)}

  .grid-2{display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
  .stat{background:#fff;border-radius:10px;padding:12px;box-shadow:0 8px 18px rgba(0,0,0,0.03)}
  .table{width:100%;border-collapse:collapse}
  .table th{background:#fbfdff;padding:12px;text-align:left;border-bottom:1px solid rgba(0,0,0,0.06);font-weight:700}
  .table td{padding:12px;border-bottom:1px solid rgba(0,0,0,0.04)}

  /* products row layout */
  .product-row{display:grid;grid-template-columns:40px 1fr 80px 80px 60px 90px 30px;gap:10px;align-items:center;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04)}
  .product-row input{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}

  .right{text-align:right}
  .center{display:flex;align-items:center;gap:8px}

  /* responsive tweaks */
  @media (max-width:1000px){
    .grid-2{grid-template-columns:1fr}
    .sidebar{position:fixed;left:-320px;top:0;z-index:80;height:100vh;transition:left .22s}
    .sidebar.open{left:0}
    .content{padding:12px}
  }

  /* print invoice page size 20cm x 14cm portrait */
  @page{size:20cm 14cm;margin:10mm}
  @media print{
    .sidebar,.menu-btn,.topbar,.no-print{display:none}
  }
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div class="logo">JBS KNIT WEAR — <span style="font-weight:600">Billing</span></div>

    <nav class="nav" id="mainNav">
      <a href="#" data-view="dashboard" class="nav-link active">Dashboard <span class="sub">Quick totals & recent</span></a>
      <a href="#" data-view="transactions" class="nav-link">Transactions <span class="sub">Income & expense add</span></a>
      <a href="#" data-view="create" class="nav-link">Create Invoice <span class="sub">Add products & save</span></a>
      <a href="#" data-view="invoices" class="nav-link">Invoices <span class="sub">Saved invoices</span></a>
      <a href="#" data-view="printable" class="nav-link">Printable template <span class="sub">View / print invoice</span></a>
    </nav>

    <div style="margin-top:18px;color:var(--muted);font-size:13px">Tip: Save then Print from the invoice view.</div>
  </aside>

  <!-- Main content -->
  <main class="content">
    <div class="topbar">
      <div class="top-left">
        <button id="menuToggle" class="menu-btn no-print" title="Toggle menu">☰</button>
        <div style="font-weight:700">Billing</div>
      </div>

      <div class="opening">
        <label class="muted">Opening balance (today)</label>
        <input id="openingInput" type="number" style="width:120px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
        <button id="setOpening" class="menu-btn" title="Set">Set</button>
        <button id="clearOpening" class="menu-btn" title="Clear">Clear</button>
      </div>
    </div>

    <!-- Views -->
    <div id="viewsContainer">

      <!-- Dashboard -->
      <section id="view-dashboard" class="panel" data-view>
        <div style="display:flex;justify-content:space-between;gap:16px;align-items:flex-start">
          <div style="flex:1">
            <h1 class="h1">Billing Dashboard</h1>
            <div class="muted">Quick overview of today's totals and recent activity</div>
            <div style="height:12px"></div>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <div class="stat"><div class="muted">Total Income</div><div id="incomeDisplay" style="font-weight:800;margin-top:6px">₹0.00</div></div>
              <div class="stat"><div class="muted">Total Expense</div><div id="expenseDisplay" style="font-weight:800;margin-top:6px">₹0.00</div></div>
              <div class="stat"><div class="muted">Profit</div><div id="profitDisplay" style="font-weight:800;margin-top:6px">₹0.00</div></div>
            </div>
          </div>

          <div style="width:340px">
            <div class="panel">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <h2 class="h2" style="margin:0">Recent transactions</h2>
                <button id="exportTransCSV" style="background:#18a94b;color:#fff;border:none;padding:8px 10px;border-radius:8px">Export CSV</button>
              </div>
              <table class="table" style="margin-top:12px">
                <thead><tr><th>Date</th><th>Type</th><th>Category</th><th class="right">Amount</th></tr></thead>
                <tbody id="recentBody"><tr><td colspan="4" class="muted">No recent transactions</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Transactions -->
      <section id="view-transactions" class="panel" data-view style="display:none">
        <h1 class="h1">Transactions</h1>
        <div class="muted">Quick add income & expense</div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:14px">
          <select id="transType" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
            <option value="income">Income</option><option value="expense">Expense</option>
          </select>
          <input id="transCategory" placeholder="Category" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);min-width:180px">
          <input id="transAmount" type="number" placeholder="Amount" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);width:120px">
          <input id="transDate" type="date" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
          <select id="transPay" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
            <option>Cash</option><option>GPay</option><option>Card</option><option>Bank</option>
          </select>
          <button id="addTrans" style="padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff;border:none">Add</button>
        </div>

        <div style="margin-top:14px;display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;gap:8px;align-items:center">
            <input id="filterFrom" type="date" style="padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
            <input id="filterTo" type="date" style="padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
            <select id="filterType" style="padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
              <option value="">All</option><option value="income">Income</option><option value="expense">Expense</option>
            </select>
            <button id="applyFilter" class="menu-btn">Filter</button>
            <button id="clearFilter" class="menu-btn">Clear</button>
          </div>
          <div><button id="expCSV" style="background:#18a94b;color:#fff;border:none;padding:8px 10px;border-radius:8px">Download CSV</button></div>
        </div>

        <div style="margin-top:12px">
          <table class="table">
            <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th class="right">Amount</th><th></th></tr></thead>
            <tbody id="transBody"><tr><td colspan="6" class="muted">No transactions added</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- Create Invoice -->
      <section id="view-create" class="panel" data-view style="display:none">
        <h1 class="h1">Create Invoice</h1>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
          <input id="invNo" placeholder="Invoice no (auto)" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);min-width:160px">
          <input id="invDate" type="date" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);min-width:160px">
          <input id="invCustomer" placeholder="Customer name" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
          <select id="invPayMode" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);min-width:140px">
            <option>Cash</option><option>GPay</option><option>Card</option><option>Bank</option>
          </select>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="h2">Products</div>
          <div style="display:flex;gap:8px">
            <button id="addProd" class="menu-btn">+ Add</button>
            <button id="clearProds" class="menu-btn">Clear</button>
            <button id="recalc" class="menu-btn">Recalc</button>
          </div>
        </div>

        <div id="productsList" style="display:flex;flex-direction:column;gap:10px">
          <!-- product rows will be injected here -->
        </div>

        <div style="display:flex;justify-content:flex-end;gap:18px;margin-top:12px;align-items:center">
          <div style="text-align:right"><div class="muted">Subtotal</div><div id="subtotal" style="font-weight:800">₹0.00</div></div>
          <div style="text-align:right"><div class="muted">Tax %</div><input id="taxPct" type="number" value="0" style="width:70px;padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"><div id="taxAmount" style="font-weight:800;margin-top:6px">₹0.00</div></div>
          <div style="text-align:right"><div class="muted">Total</div><div id="grandTotal" style="font-weight:900;font-size:18px">₹0.00</div></div>
        </div>

        <div style="margin-top:16px;display:flex;gap:10px">
          <button id="saveInvoice" class="menu-btn" style="background:var(--accent);color:#fff;border:none">Save</button>
          <button id="openPrintable" class="menu-btn">Open Printable</button>
          <button id="resetInvoice" class="menu-btn">Reset</button>
        </div>
      </section>

      <!-- Invoices list -->
      <section id="view-invoices" class="panel" data-view style="display:none">
        <h1 class="h1">Saved Invoices</h1>
        <table class="table" style="margin-top:12px">
          <thead><tr><th>ID</th><th>Date</th><th>Customer</th><th>Payment</th><th class="right">Total</th><th></th></tr></thead>
          <tbody id="invoicesBody"><tr><td colspan="6" class="muted">No saved invoices</td></tr></tbody>
        </table>
      </section>

      <!-- Printable -->
      <section id="view-printable" class="panel" data-view style="display:none">
        <h1 class="h1">Printable template</h1>
        <div style="margin-top:8px">
          <select id="selectPrint" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);min-width:320px"></select>
          <button id="viewPrintBtn" class="menu-btn">Open</button>
        </div>
      </section>

    </div>
  </main>
</div>

<!-- printable template -->
<template id="printTemplate">
  <div style="font-family:Arial,Helvetica,sans-serif;font-size:13px;padding:6mm">
    <div style="font-weight:800;font-size:18px">JBS KNIT WEAR</div>
    <div style="margin-top:6px">3(2)/2B, Nesavalar Colony 2nd Street, P.N.Road, Tirupur - 641 602</div>
    <div style="margin-top:6px">Ph: 97919 02205</div>
    <div style="margin-top:6px">GSTIN: 33CKAPJ7513F1ZK</div>
    <hr style="margin:10px 0;border:none;border-top:1px solid #ddd">
    <div>Date: <span id="piDate"></span> &nbsp; Invoice ID: <span id="piId"></span></div>
    <div>Customer: <span id="piCustomer"></span></div>
    <div>Payment: <span id="piPayment"></span></div>
    <table style="width:100%;border-collapse:collapse;margin-top:8px">
      <thead><tr style="background:#f6f6f6"><th style="padding:6px;border:1px solid #ddd">#</th><th style="padding:6px;border:1px solid #ddd">Product</th><th style="padding:6px;border:1px solid #ddd">Qty</th><th style="padding:6px;border:1px solid #ddd">Rate</th><th style="padding:6px;border:1px solid #ddd">Amount</th></tr></thead>
      <tbody id="piRows"></tbody>
    </table>
    <div style="text-align:right;margin-top:10px;font-weight:800">Total: ₹<span id="piTotal"></span></div>
  </div>
</template>

<script>
/* Simple client-side app to show/hide views and keep sidebar visible.
   Also includes core invoice/transaction logic (localStorage). */

const $ = id => document.getElementById(id);
const el = sel => document.querySelector(sel);
const money = v => '₹' + Number(v||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
const STORAGE = {INVOICES:'billing_invoices_v1', TRANS:'billing_transactions_v1', OPEN:'billing_opening_v1'};
let STATE = {invoices:[], transactions:[], opening:0};

/* --- Sidebar nav --- */
const navLinks = document.querySelectorAll('.nav-link');
function setActiveView(view){
  // hide all views
  document.querySelectorAll('[data-view]').forEach(s=>s.style.display='none');
  const elView = document.getElementById('view-' + view);
  if(elView) elView.style.display = 'block';
  navLinks.forEach(a=>a.classList.toggle('active', a.dataset.view===view));
  // on small screens hide sidebar
  if(window.innerWidth < 1000) document.getElementById('sidebar').classList.remove('open');
}
navLinks.forEach(a=>{
  a.addEventListener('click', (ev)=>{
    ev.preventDefault();
    setActiveView(a.dataset.view);
  });
});

/* menu toggle for small screens */
const menuToggle = $('menuToggle');
menuToggle.addEventListener('click', ()=> {
  const sb = $('sidebar');
  sb.classList.toggle('open');
});

/* --- loading/saving --- */
function loadAll(){
  try{ STATE.transactions = JSON.parse(localStorage.getItem(STORAGE.TRANS) || '[]'); }catch(e){STATE.transactions=[];}
  try{ STATE.invoices = JSON.parse(localStorage.getItem(STORAGE.INVOICES) || '[]'); }catch(e){STATE.invoices=[];}
  STATE.opening = Number(localStorage.getItem(STORAGE.OPEN) || 0);
  $('openingInput').value = STATE.opening || '';
}
function saveTrans(){ localStorage.setItem(STORAGE.TRANS, JSON.stringify(STATE.transactions)); }
function saveInv(){ localStorage.setItem(STORAGE.INVOICES, JSON.stringify(STATE.invoices)); }

/* --- Dashboard recent and totals --- */
function updateDashboard(){
  const inc = STATE.transactions.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const exp = STATE.transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  $('incomeDisplay').textContent = money(inc);
  $('expenseDisplay').textContent = money(exp);
  $('profitDisplay').textContent = money(inc - exp);
  renderRecent();
}
function renderRecent(){
  const body = $('recentBody');
  const rows = STATE.transactions.slice().sort((a,b)=>b.id-a.id).slice(0,6);
  if(!rows.length){ body.innerHTML = '<tr><td colspan="4" class="muted">No recent transactions</td></tr>'; return; }
  body.innerHTML = rows.map(r=>`<tr><td>${r.date}</td><td style="font-weight:700;color:${r.type==='income'?'green':'#d9534f'}">${r.type}</td><td>${r.category}</td><td class="right">${money(r.amount)}</td></tr>`).join('');
}

/* --- Transactions view handlers --- */
$('addTrans').addEventListener('click', ()=>{
  const type = $('transType').value;
  const cat = $('transCategory').value.trim();
  const amt = Number($('transAmount').value || 0);
  const date = $('transDate').value || new Date().toISOString().slice(0,10);
  const pay = $('transPay').value;
  if(!cat || amt <= 0){ alert('Enter category and amount'); return; }
  STATE.transactions.push({id:Date.now(), type, category:cat, amount: amt, date, pay});
  saveTrans(); renderTransactions(); updateDashboard();
  $('transCategory').value=''; $('transAmount').value=''; $('transDate').value='';
});
function renderTransactions(){
  const tbody = $('transBody');
  const data = STATE.transactions.slice().sort((a,b)=>b.id-a.id);
  if(!data.length){ tbody.innerHTML = '<tr><td colspan="6" class="muted">No transactions added</td></tr>'; return; }
  tbody.innerHTML = data.map(t=>`<tr>
    <td>${t.date}</td>
    <td style="font-weight:700;color:${t.type==='income'?'green':'#d9534f'}">${t.type}</td>
    <td>${t.category}</td>
    <td>${t.pay}</td>
    <td class="right">${money(t.amount)}</td>
    <td><button onclick="deleteTransaction(${t.id})" style="padding:6px;border-radius:6px">Delete</button></td>
  </tr>`).join('');
}
window.deleteTransaction = function(id){
  if(!confirm('Delete transaction?')) return;
  STATE.transactions = STATE.transactions.filter(t=>t.id!==id); saveTrans(); renderTransactions(); updateDashboard();
}
$('applyFilter').addEventListener('click', ()=> {
  // simple re-render; current UI uses all rows (you can expand)
  renderTransactions();
});
$('clearFilter').addEventListener('click', ()=>{
  $('filterFrom').value=''; $('filterTo').value=''; $('filterType').value='';
  renderTransactions();
});
$('expCSV').addEventListener('click', ()=> {
  if(!STATE.transactions.length) return alert('No transactions');
  const rows = STATE.transactions.map(t=>`${t.date},"${t.type}","${t.category}","${t.pay}",${t.amount}`).join('\n');
  const csv = 'date,type,category,pay,amount\n' + rows;
  const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='transactions.csv'; a.click(); URL.revokeObjectURL(url);
});
$('exportTransCSV').addEventListener('click', ()=> $('expCSV').click());

/* --- Invoice: product rows, calc, save, printable --- */
function ensureRows(){
  const cont = $('productsList');
  if(cont.children.length) return;
  for(let i=1;i<=4;i++) cont.appendChild(makeRow(i));
  attachProdEvents();
}
function makeRow(index,desc=''){
  const div = document.createElement('div');
  div.className = 'product-row';
  div.innerHTML = `
    <div style="text-align:center;font-weight:700">${index}</div>
    <div><input class="prod-desc" placeholder="Product description" value="${desc}"></div>
    <div><input class="prod-qty" type="number" min="0" value="0"></div>
    <div><input class="prod-rate" type="number" min="0" value="0"></div>
    <div><input class="prod-disc" type="number" min="0" value="0"></div>
    <div class="right" style="font-weight:700">₹0.00</div>
    <div class="center"><button class="del-prod" title="Remove">x</button></div>
  `;
  return div;
}
function attachProdEvents(){
  const cont = $('productsList');
  cont.querySelectorAll('.prod-qty, .prod-rate, .prod-disc').forEach(inp => inp.addEventListener('input', recalcInvoice));
  cont.querySelectorAll('.del-prod').forEach(btn => btn.addEventListener('click', e=>{ e.target.closest('.product-row').remove(); renumber(); recalcInvoice(); }));
}
function renumber(){ const cont = $('productsList'); let i=1; cont.querySelectorAll('.product-row').forEach(r=>r.querySelector('div').textContent = i++); }
$('addProd').addEventListener('click', ()=>{ $('productsList').appendChild(makeRow($('productsList').children.length+1)); attachProdEvents(); renumber(); });
$('clearProds').addEventListener('click', ()=>{ if(!confirm('Clear all product rows?')) return; $('productsList').innerHTML=''; for(let i=1;i<=4;i++) $('productsList').appendChild(makeRow(i)); attachProdEvents(); recalcInvoice(); });
function recalcInvoice(){
  const rows = Array.from($('productsList').querySelectorAll('.product-row'));
  let subtotal = 0;
  rows.forEach(r=>{
    const qty = Number(r.querySelector('.prod-qty').value || 0);
    const rate = Number(r.querySelector('.prod-rate').value || 0);
    const disc = Number(r.querySelector('.prod-disc').value || 0);
    const amount = Math.max(0, qty * rate * (1 - disc/100));
    subtotal += amount;
    r.querySelector('div.right').textContent = money(amount);
  });
  $('subtotal').textContent = money(subtotal);
  const tax = Number($('taxPct').value || 0);
  const taxAmt = subtotal * tax / 100;
  $('taxAmount').textContent = money(taxAmt);
  $('grandTotal').textContent = money(subtotal + taxAmt);
}
$('recalc').addEventListener('click', recalcInvoice);
$('taxPct').addEventListener('input', recalcInvoice);

/* save invoice */
$('saveInvoice').addEventListener('click', ()=>{
  const inv = {
    id: $('invNo').value || 'INV' + Date.now(),
    date: $('invDate').value || (new Date()).toISOString().slice(0,10),
    customer: $('invCustomer').value || '',
    payment: $('invPayMode') ? $('invPayMode').value : $('invPayMode'),
    rows: Array.from($('productsList').querySelectorAll('.product-row')).map((r,idx)=>({
      desc: r.querySelector('.prod-desc').value||'',
      qty: Number(r.querySelector('.prod-qty').value||0),
      rate: Number(r.querySelector('.prod-rate').value||0),
      disc: Number(r.querySelector('.prod-disc').value||0),
      amount: Number(r.querySelector('div.right').textContent.replace(/[^\d\.\-]/g,'')||0)
    })),
    total: Number($('grandTotal').textContent.replace(/[^\d\.\-]/g,'')||0)
  };
  STATE.invoices.push(inv); saveInv(); alert('Saved invoice ' + inv.id); renderInvoices();
});
function renderInvoices(){
  const body = $('invoicesBody'); if(!STATE.invoices.length){ body.innerHTML = '<tr><td colspan="6" class="muted">No saved invoices</td></tr>'; return; }
  body.innerHTML = STATE.invoices.slice().reverse().map(inv => `<tr>
    <td>${inv.id}</td><td>${inv.date}</td><td>${inv.customer}</td><td>${inv.payment}</td><td class="right">${money(inv.total)}</td>
    <td><button onclick="openPrintableInvoice('${inv.id}')" class="menu-btn">Open</button></td>
  </tr>`).join('');
}
function renderPrintableSelect(){
  const sel = $('selectPrint'); sel.innerHTML = STATE.invoices.map(i => `<option value="${i.id}">${i.id} — ${i.date} — ${i.customer} — ${money(i.total)}</option>`).join('');
}
window.openPrintableInvoice = function(id){
  const inv = STATE.invoices.find(i=>i.id===id);
  if(!inv) return alert('Invoice not found');
  const tpl = document.getElementById('printTemplate').content.cloneNode(true);
  tpl.getElementById('piDate').textContent = inv.date;
  tpl.getElementById('piId').textContent = inv.id;
  tpl.getElementById('piCustomer').textContent = inv.customer;
  tpl.getElementById('piPayment').textContent = inv.payment;
  const rowsEl = tpl.getElementById('piRows');
  inv.rows.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="padding:6px;border:1px solid #ddd">${idx+1}</td><td style="padding:6px;border:1px solid #ddd">${r.desc}</td><td style="padding:6px;border:1px solid #ddd">${r.qty}</td><td style="padding:6px;border:1px solid #ddd">${Number(r.rate).toFixed(2)}</td><td style="padding:6px;border:1px solid #ddd">${Number(r.amount).toFixed(2)}</td>`;
    rowsEl.appendChild(tr);
  });
  tpl.getElementById('piTotal').textContent = Number(inv.total).toFixed(2);
  const newWin = window.open('','_blank','width=700,height=600');
  newWin.document.write('<html><head><title>Invoice '+inv.id+'</title>');
  newWin.document.write('<style>@page{size:20cm 14cm;margin:10mm}body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:6mm}</style>');
  newWin.document.write('</head><body>');
  newWin.document.write(new XMLSerializer().serializeToString(tpl));
  newWin.document.write('</body></html>');
  newWin.document.close();
}

/* initial */
(function boot(){
  loadAll(); ensureRows(); renderTransactions(); updateDashboard(); renderInvoices(); renderPrintableSelect();
  setActiveView('dashboard');
  // ensure sidebar visible on big screens
  if(window.innerWidth >= 1000) document.getElementById('sidebar').classList.remove('open');
})();

/* open create view helper to ensure rows exist and recalc */
document.querySelectorAll('[data-view]').forEach(v=>{
  const id = v.id.replace('view-','');
  if(id === 'create'){
    // attach nav click to prepare
    document.querySelectorAll('[data-view="create"]').forEach(a=>a.addEventListener('click', ()=>{
      ensureRows(); recalcInvoice();
    }));
  }
});

/* small helpers for debugging */
window.STATE = STATE;
</script>
</body>
</html>
