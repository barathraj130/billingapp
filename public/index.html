<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JBS Knit Wear — Billing</title>

  <style>
  :root{
    --bg:#f5f7fb;
    --sidebar:#fff;
    --card:#ffffff;
    --muted:#7b8794;
    --accent:#1976ff;
    --accent-2:#0b72e6;
    --danger:#ff6b4a;
    --radius:12px;
    --shadow: 0 10px 30px rgba(20,30,50,0.06);
    --container-max:1200px;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{background:var(--bg);color:#111;}

/* Top header */
.header{
  height:68px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 18px;
  background:transparent;
  position:sticky;
  top:0;
  z-index:60;
}

/* App title left */
.brand{display:flex;align-items:center;gap:12px}
.brand .title{font-weight:800;font-size:18px;letter-spacing:0.2px}
.small-note{color:var(--muted);font-size:12px}

/* hamburger for mobile */
.hamburger{display:none;border:0;background:transparent;font-size:20px;cursor:pointer}

/* Wrapper with left sidebar and main content */
.wrapper{display:flex;min-height:calc(100vh - 68px);}

/* Sidebar */
.sidebar{
  width:240px;
  background:var(--sidebar);
  padding:28px 18px;
  box-shadow: 0 2px 8px rgba(20,30,50,0.03);
  border-right:1px solid rgba(16,24,40,0.03);
  box-sizing:border-box;
  position:sticky;
  top:68px;
  height: calc(100vh - 68px);
  overflow:auto;
  transition:transform .18s ease;
  z-index:40;
}
.sidebar.hidden{transform:translateX(-120%);}
.logo{font-weight:800;margin-bottom:18px}
.nav{display:flex;flex-direction:column;gap:8px}
.nav a{display:block;padding:12px 12px;border-radius:8px;color:#111;text-decoration:none;font-weight:700}
.nav a small{display:block;color:var(--muted);font-weight:500;font-size:12px;margin-top:4px}
.nav a.active{background:linear-gradient(90deg,#ffffff,#fbfdff);box-shadow: 0 6px 18px rgba(20,30,50,0.04);border-left:4px solid var(--accent);padding-left:12px}

/* Layout container (content + right panel) */
.container{
  display:grid;
  width:100%;
  max-width:var(--container-max);
  margin:20px auto;
  grid-template-columns: 1fr 440px;
  column-gap:28px;
  align-items:start;
  padding:0 18px;
  box-sizing:border-box;
}

/* main content column */
.content{min-width:0;padding-bottom:40px}

/* right panel (invoice card area) */
.panel{min-width:0;display:block}

/* Card style */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:20px;
  box-shadow:var(--shadow);
  border:1px solid rgba(16,24,40,0.03);
  box-sizing:border-box;
}

/* typography */
.h1{font-size:28px;font-weight:800;margin-bottom:6px}
.h2{font-size:15px;color:var(--muted);margin-bottom:14px}

/* Stats row */
.stat-row{display:flex;gap:18px;flex-wrap:wrap;margin-top:8px}
.stat{flex:1;min-width:190px;background:#fff;border-radius:10px;padding:18px;box-shadow:0 8px 20px rgba(20,30,50,0.03)}
.stat .label{color:var(--muted);font-size:13px}
.stat .value{font-weight:800;font-size:20px;margin-top:8px}

/* table */
.table{margin-top:12px;border-radius:10px;overflow:hidden;background:#fff;padding:8px;border:1px solid rgba(16,24,40,0.03)}
.table .thead{display:flex;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(16,24,40,0.03)}
.table .thead div{flex:1;font-weight:700}
.table .row{display:flex;gap:10px;padding:12px}

/* Create Invoice layout */
.invoice-card .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.input{background:#fff;border:1px solid #e6eef9;padding:10px;border-radius:8px;min-height:38px;box-sizing:border-box}
.input.small{width:100px}
.input.medium{width:200px}
.input.full{width:100%}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#fff;padding:9px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid #e7eef8;color:#111}
.btn.warn{background:var(--danger);}

/* Products list */
.items{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.item{
  display:grid;
  gap:10px;
  align-items:center;
  grid-template-columns:
    48px              /* sno */
    minmax(160px, 1fr)/* product */
    80px              /* qty */
    90px              /* rate */
    64px              /* disc% */
    88px              /* amount */
    36px;             /* remove */
  background:#fff;border:1px solid #eef3f8;border-radius:10px;padding:8px;
}
.item .sno{font-weight:700;color:var(--muted);padding-left:8px}
.item input, .item select{
  width:100%;height:36px;padding:6px 8px;border-radius:6px;border:1px solid #e8eef6;box-sizing:border-box;
  background:transparent;
}

/* totals */
.totals{display:flex;flex-direction:column;gap:8px;align-items:flex-end;margin-top:12px}
.totals .line{display:flex;gap:12px;align-items:center}
.totals .label{color:var(--muted);min-width:120px;text-align:right}
.totals .value{font-weight:800;font-size:18px;min-width:80px;text-align:right}

/* small screens */
@media (max-width:980px){
  .container{grid-template-columns: 1fr; padding-bottom:80px}
  .sidebar{position:fixed;left:0;top:68px;height:calc(100vh - 68px);width:260px;z-index:60}
  .panel{order:2;margin-top:14px}
  .content{order:1}
  .item{
    grid-template-columns:
      48px minmax(140px, 1fr);
  }
  .item > .qty,
  .item > .rate,
  .item > .disc,
  .item > .amt,
  .item > .remove {
    grid-column: 1 / -1;
    display:flex;
    gap:8px;
  }
  .hamburger{display:block}
  .header{padding:0 12px}
}

/* tiny phones */
@media (max-width:480px){
  .brand .title{font-size:16px}
  .nav a{padding:10px 8px}
  .card{padding:12px}
  .item input{height:34px}
}
  </style>
</head>
<body>
  <div class="header">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="hamburger" id="hamburger" aria-label="Toggle menu">☰</button>
      <div class="brand">
        <div class="title">JBS KNIT WEAR — Billing</div>
        <div class="small-note">Simple billing for retail</div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:12px">
      <div style="color:var(--muted);font-size:13px">Opening balance (today)</div>
      <input id="openingInput" class="input small" type="number" step="0.01" value="0.00" />
      <button id="setOpeningBtn" class="btn">Set</button>
      <button id="clearOpeningBtn" class="btn ghost">Clear</button>
    </div>
  </div>

  <div class="wrapper">
    <aside class="sidebar" id="sidebar">
      <div class="logo">JBS KNIT WEAR — <small style="font-weight:600">Billing</small></div>

      <nav class="nav" aria-label="Main menu">
        <a href="#dashboard" data-view="dashboard" class="active">Dashboard <small>Quick totals & recent</small></a>
        <a href="#transactions" data-view="transactions">Transactions <small>Income & expense quick add</small></a>
        <a href="#create" data-view="create">Create Invoice <small>Add products & save</small></a>
        <a href="#invoices" data-view="invoices">Invoices <small>Saved invoices list</small></a>
        <a href="#printable" data-view="printable">Printable template <small>View / print invoice</small></a>
      </nav>

      <div style="margin-top:18px;color:var(--muted);font-size:13px">
        Tip: Use Save then Print from the invoice view.
      </div>
    </aside>

    <main class="container">
      <!-- left content column with views -->
      <section class="content">
        <!-- Dashboard view -->
        <div class="card" id="view-dashboard">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div>
              <div class="h1">Billing Dashboard</div>
              <div class="h2">Quick overview of today's totals and recent activity</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700;color:var(--accent);">Profit: ₹<span id="profitVal">0.00</span></div>
            </div>
          </div>

          <div style="margin-top:12px" class="stat-row">
            <div class="stat">
              <div class="label">Total Income</div>
              <div class="value">₹<span id="totalIncome">0.00</span></div>
            </div>
            <div class="stat">
              <div class="label">Total Expense</div>
              <div class="value">₹<span id="totalExpense">0.00</span></div>
            </div>
            <div class="stat">
              <div class="label">Profit</div>
              <div class="value">₹<span id="totalProfit">0.00</span></div>
            </div>
          </div>

          <div class="table" style="margin-top:14px">
            <div class="thead">
              <div style="flex:1">Date</div>
              <div style="flex:1">Type</div>
              <div style="flex:1">Category</div>
              <div style="flex:1;text-align:right">Amount</div>
            </div>
            <div id="recentList"></div>
          </div>
        </div>

        <!-- Transactions view -->
        <div class="card" id="view-transactions" style="display:none;margin-top:18px">
          <div class="h1">Quick Transactions</div>
          <div class="h2">Add income or expenses quickly</div>
          <form id="transForm" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <select id="transType" class="input small">
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
            <input id="transCategory" class="input medium" placeholder="Category" />
            <input id="transAmount" class="input small" type="number" step="0.01" placeholder="Amount" />
            <button id="addTransBtn" class="btn">Add</button>
          </form>
        </div>

        <!-- Invoices list view -->
        <div class="card" id="view-invoices" style="display:none;margin-top:18px">
          <div class="h1">Saved Invoices</div>
          <div class="h2">View previously saved invoices</div>
          <div id="invoicesList" style="margin-top:8px">No saved invoices loaded.</div>
        </div>

        <!-- Printable preview view -->
        <div class="card" id="view-printable" style="display:none;margin-top:18px">
          <div class="h1">Printable Template</div>
          <div class="h2">Open a printable invoice by id</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="printId" class="input medium" placeholder="Invoice id" />
            <button id="openPrintableBtn" class="btn">Open printable</button>
          </div>
        </div>
      </section>

      <!-- right panel - invoice card (always visible) -->
      <aside class="panel">
        <div class="card invoice-card" id="invoiceCard">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div style="font-weight:800;font-size:18px">Create Invoice</div>
            <div style="color:var(--muted);font-size:13px">Tip: enter product, qty & rate — amounts auto</div>
          </div>

          <!-- top inputs -->
          <div class="row" style="margin-bottom:8px">
            <input id="invoiceNo" class="input medium" placeholder="Invoice no (auto)" readonly />
            <input id="invoiceDate" class="input medium" type="date" />
          </div>
          <div style="margin-bottom:12px">
            <input id="customerName" class="input full" placeholder="Customer name" />
          </div>

          <!-- products header -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
            <div style="font-weight:700;color:var(--muted)">Products</div>
            <div class="controls">
              <button id="addProductBtn" class="btn">+ Add</button>
              <button id="clearProductsBtn" class="btn ghost">Clear</button>
              <button id="recalcBtn" class="btn ghost">Recalc</button>
            </div>
          </div>

          <!-- items list -->
          <div class="items" id="itemsContainer"></div>

          <!-- totals -->
          <div class="totals">
            <div class="line">
              <div class="label">Subtotal:</div>
              <div class="value">₹<span id="subtotal">0.00</span></div>
            </div>
            <div class="line">
              <div style="display:flex;gap:8px;align-items:center">
                <div class="label">Tax %:</div>
                <input id="taxPct" class="input small" type="number" min="0" value="0" />
              </div>
              <div class="value">₹<span id="taxVal">0.00</span></div>
            </div>
            <div class="line" style="font-size:18px">
              <div class="label" style="font-weight:800">Total</div>
              <div class="value">₹<span id="totalVal">0.00</span></div>
            </div>

            <div style="display:flex;gap:10px;margin-top:10px">
              <button id="saveInvBtn" class="btn">Save</button>
              <button id="printInvBtn" class="btn ghost">Print</button>
              <button id="resetFormBtn" class="btn warn">Reset</button>
            </div>
          </div>

        </div>
      </aside>
    </main>
  </div>

  <script>
  /* ---------- Utilities ---------- */
  const $ = id => document.getElementById(id);
  const format = v => Number(v||0).toFixed(2);

  /* ---------- View router / sidebar ---------- */
  const views = ['dashboard','transactions','create','invoices','printable'];
  function showView(name){
    views.forEach(v=>{
      const el = $('view-' + v);
      if(el) el.style.display = (v === name ? '' : 'none');
    });
    // active link
    document.querySelectorAll('.nav a').forEach(a=>{
      a.classList.toggle('active', a.dataset.view === name);
    });
    // scroll to top of content area to keep UX consistent
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // initialize nav links
  document.querySelectorAll('.nav a').forEach(a=>{
    a.addEventListener('click', function(e){
      e.preventDefault();
      const view = this.dataset.view || 'dashboard';
      showView(view);
      // on small screens close sidebar
      if(window.innerWidth <= 980){
        $('#sidebar').classList.add('hidden');
      }
    });
  });

  // hamburger toggle
  $('#hamburger').addEventListener('click', ()=>{
    $('#sidebar').classList.toggle('hidden');
  });

  // hide sidebar on click outside on mobile
  document.addEventListener('click', (ev)=>{
    if(window.innerWidth <= 980){
      const sidebar = $('#sidebar');
      if(!sidebar.contains(ev.target) && !$('#hamburger').contains(ev.target)) {
        sidebar.classList.add('hidden');
      }
    }
  });

  /* ---------- Invoice rows & calculations ---------- */
  let items = [];

  function makeRow(i, data={}){
    const row = document.createElement('div');
    row.className = 'item';
    row.dataset.index = i;
    row.innerHTML = `
      <div class="sno">${i+1}</div>
      <div><input class="prod" placeholder="Product" value="${data.product||''}" /></div>
      <div class="qty"><input type="number" min="0" step="1" class="qtyI" value="${data.qty||''}" placeholder="Qty" /></div>
      <div class="rate"><input type="number" min="0" step="0.01" class="rateI" value="${data.rate||''}" placeholder="Rate" /></div>
      <div class="disc"><input type="number" min="0" step="0.01" class="discI" value="${data.disc||0}" placeholder="Disc%" /></div>
      <div class="amt"><input readonly class="amtI input" value="${format(data.amount||0)}" /></div>
      <div class="remove"><button class="btn ghost removeBtn">x</button></div>
    `;
    // handlers
    row.querySelector('.qtyI').addEventListener('input', recalcAll);
    row.querySelector('.rateI').addEventListener('input', recalcAll);
    row.querySelector('.discI').addEventListener('input', recalcAll);
    row.querySelector('.prod').addEventListener('change', ()=>{});
    row.querySelector('.removeBtn').addEventListener('click', ()=>{
      const idx = Number(row.dataset.index);
      items.splice(idx,1);
      renderItems();
    });
    return row;
  }

  function renderItems(){
    const container = $('itemsContainer');
    container.innerHTML = '';
    items.forEach((it,i)=>container.appendChild(makeRow(i,it)));
    recalcAll();
  }

  function addProduct(data){
    items.push(data||{product:'',qty:'',rate:'',disc:0,amount:0});
    renderItems();
    setTimeout(()=>{
      const last = document.querySelector('#itemsContainer .item:last-child .prod');
      if(last) last.focus();
    },50);
  }

  function clearProductsToDefault(){
    items = [];
    for(let i=0;i<4;i++) items.push({product:'',qty:'',rate:'',disc:0,amount:0});
    renderItems();
  }

  function recalcAll(){
    const container = $('itemsContainer');
    const rows = container.querySelectorAll('.item');
    let subtotal = 0;
    rows.forEach((row, idx)=>{
      const qty = Number(row.querySelector('.qtyI').value || 0);
      const rate = Number(row.querySelector('.rateI').value || 0);
      const disc = Number(row.querySelector('.discI').value || 0);
      let amount = qty * rate;
      if(disc) amount = amount * (1 - (disc/100));
      subtotal += amount;
      row.querySelector('.amtI').value = format(amount);
      items[idx] = {
        product: row.querySelector('.prod').value||'',
        qty, rate, disc, amount
      };
    });
    $('subtotal').innerText = format(subtotal);
    const taxPct = Number($('taxPct').value || 0);
    const taxVal = subtotal * (taxPct/100);
    $('taxVal').innerText = format(taxVal);
    const total = subtotal + taxVal;
    $('totalVal').innerText = format(total);

    // update small dashboard numbers so user sees immediate effect
    $('totalIncome').innerText = format(total);
    $('totalExpense').innerText = format(0);
    $('totalProfit').innerText = format(total);
    $('profitVal').innerText = format(total);
  }

  /* ---------- Save / print / reset ---------- */
  async function saveInvoice(){
    recalcAll();
    const payload = {
      invoice_no: $('invoiceNo').value || null,
      date: $('invoiceDate').value|| new Date().toISOString().slice(0,10),
      customer: $('customerName').value||'',
      items: items.map(it=>({product:it.product, qty:it.qty, rate:it.rate, disc:it.disc, amount:it.amount})),
      subtotal: Number($('subtotal').innerText||0),
      tax_pct: Number($('taxPct').value||0),
      tax_amount: Number($('taxVal').innerText||0),
      total: Number($('totalVal').innerText||0)
    };

    try{
      const res = await fetch('/invoices', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const text = await res.text();
        alert('Save failed: ' + (res.statusText||text));
        return;
      }
      const data = await res.json();
      $('invoiceNo').value = data.invoice_no || data.id || '';
      alert('Saved invoice id ' + (data.id || data.invoice_no || 'OK'));
      // optionally refresh invoices list (best-effort)
      loadInvoices();
    }catch(e){
      alert('Save error: ' + e.message);
    }
  }

  function printInvoice(){
    const id = $('invoiceNo').value;
    if(!id){
      alert('Save invoice first or enter invoice id.');
      return;
    }
    window.open('/invoice-template.html?id=' + encodeURIComponent(id), '_blank');
  }

  function resetForm(){
    const ask = prompt("Type RESET to confirm permanent wipe of form data:");
    if(ask !== 'RESET'){
      alert('Reset cancelled (confirmation not matched).');
      return;
    }
    $('customerName').value = '';
    $('taxPct').value = 0;
    $('invoiceNo').value = '';
    $('invoiceDate').value = new Date().toISOString().slice(0,10);
    clearProductsToDefault();
    recalcAll();
    alert('Form reset.');
  }

  /* ---------- Quick transactions ---------- */
  function addTransaction(){
    const type = $('transType').value;
    const category = $('transCategory').value || 'misc';
    const amount = Number($('transAmount').value||0);
    if(!amount){ alert('Enter an amount'); return; }
    // create a local transaction entry (in real app save to DB)
    const list = $('recentList');
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `<div style="flex:1">${new Date().toISOString().slice(0,10)}</div><div style="flex:1">${type}</div><div style="flex:1">${category}</div><div style="flex:1;text-align:right">₹${format(amount)}</div>`;
    list.prepend(row);
    // update dashboard numbers
    let inc = Number($('totalIncome').innerText||0);
    let exp = Number($('totalExpense').innerText||0);
    if(type==='income') inc += amount; else exp += amount;
    $('totalIncome').innerText = format(inc);
    $('totalExpense').innerText = format(exp);
    $('totalProfit').innerText = format(inc - exp);
    $('transAmount').value = '';
    $('transCategory').value = '';
  }

  /* ---------- Invoices list (simple) ---------- */
  async function loadInvoices(){
    // best-effort: try to fetch invoices; if server doesn't provide endpoint gracefully show placeholder
    try{
      const res = await fetch('/invoices');
      if(!res.ok){
        $('invoicesList').innerText = 'No saved invoices (server returned ' + res.status + ')';
        return;
      }
      const data = await res.json();
      if(!Array.isArray(data) || data.length === 0){
        $('invoicesList').innerText = 'No invoices found.';
        return;
      }
      const ul = document.createElement('div');
      ul.style.display = 'flex';
      ul.style.flexDirection = 'column';
      ul.style.gap = '8px';
      data.forEach(inv=>{
        const item = document.createElement('div');
        item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center';
        item.style.padding='8px'; item.style.border='1px solid #eef3f8'; item.style.borderRadius='8px';
        item.innerHTML = `<div><b>${inv.invoice_no||inv.id}</b> — ${inv.customer||''} <small style="color:${'#7b8794'}">(${inv.date||''})</small></div>
                          <div style="display:flex;gap:8px">
                            <button class="btn ghost" onclick="window.open('/invoice-template.html?id=${encodeURIComponent(inv.id||inv.invoice_no)}','_blank')">Open</button>
                          </div>`;
        ul.appendChild(item);
      });
      $('invoicesList').innerHTML = '';
      $('invoicesList').appendChild(ul);
    }catch(e){
      $('invoicesList').innerText = 'Could not load invoices: ' + e.message;
    }
  }

  /* ---------- Printable open ---------- */
  $('openPrintableBtn').addEventListener('click', ()=>{
    const id = $('printId').value;
    if(!id) { alert('Enter invoice id'); return; }
    window.open('/invoice-template.html?id=' + encodeURIComponent(id), '_blank');
  });

  /* ---------- Opening balance ---------- */
  function setOpening(){
    const val = Number($('openingInput').value||0);
    localStorage.setItem('opening_balance_today', String(val));
    alert('Opening set: ₹' + format(val));
    $('profitVal').innerText = format(val);
  }
  function clearOpening(){
    localStorage.removeItem('opening_balance_today');
    $('openingInput').value = '0.00';
    $('profitVal').innerText = '0.00';
    alert('Opening cleared');
  }

  /* ---------- Init ---------- */
  function init(){
    // invoice defaults
    $('invoiceDate').value = new Date().toISOString().slice(0,10);
    clearProductsToDefault();

    // button bindings
    $('addProductBtn').addEventListener('click', ()=>addProduct());
    $('clearProductsBtn').addEventListener('click', ()=>clearProductsToDefault());
    $('recalcBtn').addEventListener('click', recalcAll);
    $('saveInvBtn').addEventListener('click', saveInvoice);
    $('printInvBtn').addEventListener('click', printInvoice);
    $('resetFormBtn').addEventListener('click', resetForm);
    $('setOpeningBtn').addEventListener('click', setOpening);
    $('clearOpeningBtn').addEventListener('click', clearOpening);
    $('addTransBtn').addEventListener('click', (e)=>{ e.preventDefault(); addTransaction(); });

    // sidebar initial state for mobile
    if(window.innerWidth <= 980) $('#sidebar').classList.add('hidden');

    // load invoices if endpoint present (non-fatal)
    loadInvoices();
  }

  window.addEventListener('DOMContentLoaded', init);
  window.addEventListener('resize', ()=>{
    if(window.innerWidth > 980) $('#sidebar').classList.remove('hidden');
  });

  </script>
</body>
</html>
