<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing — JBS KNIT WEAR</title>
<style>
  /* --------- Basic reset / tokens ---------- */
  :root{
    --bg:#f4f6f8; --card:#fff; --muted:#8b98a5; --accent:#1f7bf6;
    --radius:14px; --shadow: 0 8px 24px rgba(22,34,44,0.06);
    --panel-w:380px; --sidebar-w:260px;
    --max-width:1160px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:var(--bg); color:#1a2b3a; -webkit-font-smoothing:antialiased;}
  a{color:inherit;text-decoration:none}

  /* --------- Layout -------- */
  .app{display:flex;min-height:100vh;}
  .sidebar{
    width:var(--sidebar-w); background:linear-gradient(180deg,#fff,#fbfdff);
    padding:26px 20px; border-right:1px solid rgba(10,20,30,0.03);
  }
  .brand{font-weight:800;font-size:20px;margin-bottom:18px}
  .small{font-size:12px;color:var(--muted);display:block;margin-top:6px}
  .nav{margin-top:14px}
  .nav button{display:block;width:100%;text-align:left;padding:14px;border-radius:10px;border:none;background:transparent;color:#223;}
  .nav button.active{background:#f3f8ff;border-left:4px solid var(--accent)}
  .sidebar .helper{margin-top:26px;font-size:13px;color:var(--muted)}
  .sidebar .controls{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}
  .sidebar .controls button{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff}

  .main{flex:1;padding:18px;display:flex;flex-direction:column;gap:18px}
  .topbar{display:flex;justify-content:space-between;align-items:center;}
  .content{max-width:var(--max-width);margin:0 auto;width:100%}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}

  h1{margin:0;font-size:28px}
  .muted{color:var(--muted);font-size:14px}

  /* --------- dashboard cards --------- */
  .grid{display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:start}
  .stats{display:flex;gap:14px}
  .stat{background:#fff;padding:14px;border-radius:12px;flex:1;box-shadow:0 6px 18px rgba(20,30,50,0.03)}
  .stat .num{font-weight:800;font-size:20px;margin-top:8px}
  .recent-table{margin-top:12px;border-radius:12px;overflow:hidden}

  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:12px 16px;text-align:left;border-bottom:1px solid #f0f3f6}
  th{background:#fafafa;color:#6b7a86}

  /* --------- invoice form ---------- */
  .invoice-form .row{display:flex;gap:14px;align-items:center;margin-bottom:14px}
  .invoice-form input[type="text"], .invoice-form input[type="date"], .invoice-form input[type="number"], .invoice-form select{padding:10px 12px;border-radius:8px;border:1px solid #e6ecf1;background:#fff;min-width:0}
  .invoice-form .products{margin-top:12px}
  .product-row{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;background:#fff;border:1px solid #eef3f6;margin-bottom:10px}
  .product-row .idx{width:36px;text-align:center;color:#8b98a5}
  .product-row input[type="text"]{flex:1}
  .product-row .qty,.product-row .rate,.product-row .disc{width:86px}
  .product-row .amount{width:110px;text-align:right;font-weight:700}
  .actions{display:flex;gap:8px;margin-top:18px}
  .btn{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  .btn.white{background:#fff;border:1px solid #e2e8ef;color:#223}
  .btn.warn{background:#ff6f4d}
  .right-col{display:flex;flex-direction:column;align-items:flex-end;gap:6px}

  /* --------- controls -------- */
  .controls-row{display:flex;gap:10px;align-items:center}
  .search{padding:10px 12px;border-radius:10px;border:1px solid #e6ecf1;background:#fff;min-width:320px}

  /* --------- responsive -------- */
  @media (max-width:980px){
    .grid{grid-template-columns:1fr}
    .sidebar{display:none}
    .main{padding:14px}
    .content{padding:0 6px}
    .product-row{flex-wrap:wrap}
    .product-row .amount{width:100%}
  }

  /* -------- small tweaks for print template ---------- */
  @media print{
    body{background:#fff}
    .sidebar,.topbar{display:none}
    .card{box-shadow:none;border-radius:0;padding:12px}
  }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">JBS KNIT WEAR — <span style="font-weight:600">Billing</span>
      <div class="small">Simple billing for retail</div>
    </div>

    <nav class="nav" id="mainNav">
      <button data-view="dashboard" class="active">Dashboard <div class="small">Quick totals & recent</div></button>
      <button data-view="transactions">Transactions <div class="small">Income & expense add</div></button>
      <button data-view="create">Create Invoice <div class="small">Add products & save</div></button>
      <button data-view="invoices">Invoices <div class="small">Saved invoices list</div></button>
      <button data-view="printable">Printable template <div class="small">View / print invoice</div></button>
    </nav>

    <div class="helper">
      Tip: export a backup before major changes
      <div class="controls">
        <button id="exportBackupBtn">Export backup</button>
        <button id="importBackupBtn">Import</button>
        <button id="openTrashBtn">Trash (<span id="trashCount">0</span>)</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:10px">
        <button id="menuToggle" style="padding:8px;border-radius:8px;border:1px solid #e6ecf1;background:#fff">☰</button>
        <div class="muted">Billing — <span class="small">manage invoices & quick sales</span></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="muted">Opening balance (today)</div>
        <input id="openingInput" type="number" min="0" step="0.01" style="padding:10px;border-radius:8px;border:1px solid #e6ecf1" value="0">
        <button class="btn white" id="setOpening">Set</button>
        <button class="btn white" id="clearOpening">Clear</button>
        <button class="btn white" id="eodExportBtn">EOD Export</button>
      </div>
    </div>

    <div class="content" id="content">

      <!-- Dashboard -->
      <section id="view-dashboard" class="card" style="display:block">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <h1>Billing Dashboard</h1>
            <div class="muted">Quick overview of today's totals and recent activity</div>
          </div>
          <div class="right-col">
            <div style="color:var(--accent);font-weight:800">Profit: <span id="profitDisplay">₹0.00</span></div>
          </div>
        </div>

        <div style="margin-top:16px" class="grid">
          <div>
            <div class="card stats">
              <div class="stat">
                <div class="muted">Total Income</div>
                <div class="num" id="totalIncome">₹0.00</div>
              </div>
              <div class="stat">
                <div class="muted">Total Expense</div>
                <div class="num" id="totalExpense">₹0.00</div>
              </div>
              <div class="stat">
                <div class="muted">Cash Remaining</div>
                <div class="num" id="cashRemain">₹0.00</div>
              </div>
            </div>

            <div class="card recent-table" style="margin-top:16px">
              <div style="font-weight:700;margin-bottom:10px">Recent transactions</div>
              <table>
                <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th>Amount</th></tr></thead>
                <tbody id="recentTransactions">
                  <tr><td colspan="5" style="color:var(--muted)">No recent transactions</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <aside>
            <div class="card">
              <div style="font-weight:700">Quick invoice panel</div>
              <div class="muted" style="margin-bottom:8px">(also available in Create Invoice)</div>
              <input id="quickTotal" class="search" placeholder="Quick total">
              <div style="margin-top:8px"><button class="btn" id="quickAddBtn">Add</button></div>
              <div class="small" style="margin-top:12px;color:var(--muted)">Use 'Create Invoice' to open the full editor for editing and printing.</div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Transactions -->
      <section id="view-transactions" class="card" style="display:none">
        <h1>Transactions <span class="muted">Quick add income & expense</span></h1>

        <div style="margin-top:12px" class="card">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <select id="txType">
              <option value="income">Income</option><option value="expense">Expense</option>
            </select>
            <input id="txCategory" placeholder="Category" type="text">
            <input id="txAmount" placeholder="Amount" type="number" step="0.01">
            <input id="txDate" type="date">
            <select id="txPay">
              <option>Cash</option><option>GPay</option>
            </select>
            <button class="btn" id="addTxBtn">Add</button>
          </div>

          <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
            <input id="filterFrom" type="date">
            <input id="filterTo" type="date">
            <select id="filterType"><option value="all">All</option><option value="income">Income</option><option value="expense">Expense</option></select>
            <button class="btn white" id="filterTxBtn">Filter</button>
            <button class="btn" id="downloadTxCsv">Download CSV</button>
          </div>

          <div style="margin-top:14px">
            <table>
              <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th>Amount</th><th>Actions</th></tr></thead>
              <tbody id="txTableBody"><tr><td colspan="6" style="color:var(--muted)">No transactions added</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Create Invoice -->
      <section id="view-create" class="card invoice-form" style="display:none">
        <h1>Create Invoice <span class="muted">manage invoices & quick sales</span></h1>

        <div style="margin-top:12px" class="row">
          <input id="invoiceId" type="text" readonly style="min-width:160px">
          <input id="invoiceDate" type="date">
          <input id="invoiceCustomer" type="text" placeholder="Customer name">
        </div>

        <div class="row">
          <div style="min-width:160px">
            <div class="muted">Payment Method</div>
            <select id="invoicePayment">
              <option>Cash</option><option>GPay</option><option>Other</option>
            </select>
          </div>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button class="btn" id="addProductBtn">+ Add</button>
            <button class="btn white" id="clearProductsBtn">Clear</button>
            <button class="btn white" id="recalcBtn">Recalc</button>
          </div>
        </div>

        <div class="products" id="productsContainer">
          <!-- product rows inserted here -->
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <div class="muted">Tax %:</div>
            <input id="taxPct" type="number" value="0" style="width:86px">
          </div>
          <div style="text-align:right">
            <div class="muted">Subtotal:</div>
            <div style="font-weight:800;font-size:18px">₹<span id="subtotal">0.00</span></div>
            <div style="margin-top:6px;font-weight:800;font-size:18px">Total ₹<span id="total">0.00</span></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="saveInvoiceBtn">Save</button>
          <button class="btn white" id="printInvoiceBtn">Print</button>
          <button class="btn warn" id="resetInvoiceBtn">Reset</button>
        </div>
      </section>

      <!-- Invoices -->
      <section id="view-invoices" class="card" style="display:none">
        <h1>Invoices <span class="muted">manage invoices & quick sales</span></h1>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
          <input id="searchInvoice" class="search" placeholder="Search invoice / customer">
          <button class="btn" id="exportAllCsv">Export CSV (all)</button>
          <button class="btn white" id="exportCashCsv">Export Cash</button>
          <button class="btn white" id="exportGpayCsv">Export GPay</button>
        </div>

        <div>
          <table>
            <thead><tr><th>Invoice</th><th>Date</th><th>Customer</th><th>Pay</th><th>Total</th><th>Actions</th></tr></thead>
            <tbody id="invoiceListBody"><tr><td colspan="6" style="color:var(--muted)">No invoices</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- Printable -->
      <section id="view-printable" class="card" style="display:none">
        <h1>Printable template <span class="muted">View / print invoice</span></h1>
        <div style="margin-top:14px;display:flex;gap:12px;align-items:center">
          <select id="printSelect" style="flex:1"></select>
          <button class="btn" id="openPrintableBtn">Open</button>
        </div>
      </section>

    </div>
  </main>
</div>

<script>
/* =================== Utilities =================== */
const $$ = sel => document.querySelector(sel);
const $All = sel => Array.from(document.querySelectorAll(sel));
const money = v => Number(v||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});

/* ================= Storage keys =================== */
const KEY_INVOICES = 'invoices_v1';
const KEY_TRANSACTIONS = 'transactions_v1';
const KEY_TRASH = 'trash_v1';
const KEY_EOD = 'eod_exports_v1';

/* ================ App state =================== */
let invoices = JSON.parse(localStorage.getItem(KEY_INVOICES) || '[]');
let transactions = JSON.parse(localStorage.getItem(KEY_TRANSACTIONS) || '[]');
let trash = JSON.parse(localStorage.getItem(KEY_TRASH) || '[]');
let eodExports = JSON.parse(localStorage.getItem(KEY_EOD) || '[]');

/* ============== Simple helpers ================= */
function saveAll(){
  localStorage.setItem(KEY_INVOICES, JSON.stringify(invoices));
  localStorage.setItem(KEY_TRANSACTIONS, JSON.stringify(transactions));
  localStorage.setItem(KEY_TRASH, JSON.stringify(trash));
  localStorage.setItem(KEY_EOD, JSON.stringify(eodExports));
}
function uid(prefix='id'){return prefix+'-'+Math.random().toString(36).slice(2,9)}
function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }
function download(filename, text){
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(text);
  a.download = filename; document.body.appendChild(a); a.click(); a.remove();
}
function csvFromArray(rows){
  return rows.map(r => r.map(c => {
    if(c === null || c === undefined) return '';
    const s = String(c).replace(/"/g,'""');
    return (s.search(/("|,|\n)/g) >= 0) ? `"${s}"` : s;
  }).join(',')).join('\n');
}

/* ============== UI: switch views ================= */
const views = ['dashboard','transactions','create','invoices','printable'];
const navButtons = document.querySelectorAll('.nav button');
navButtons.forEach(btn=>{
  btn.addEventListener('click', e=>{
    navButtons.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const view = btn.dataset.view;
    views.forEach(v=>document.getElementById('view-'+v).style.display='none');
    document.getElementById('view-'+view).style.display='block';
    if(view==='create') initCreateForm();
    if(view==='invoices') renderInvoices();
    if(view==='transactions') renderTransactions();
    if(view==='printable') populatePrintSelect();
  });
});

/* ========== Opening balance / EOD ========= */
document.getElementById('setOpening').addEventListener('click', ()=>{
  const v = Number(document.getElementById('openingInput').value || 0);
  localStorage.setItem('opening_today', String(v));
  alert('Opening balance set: ₹'+money(v));
  renderDashboard();
});
document.getElementById('clearOpening').addEventListener('click', ()=>{
  localStorage.removeItem('opening_today');
  alert('Opening cleared');
  renderDashboard();
});

/* ============= Initialize create invoice form ========== */
const productTemplate = (idx, prod = {desc:'Product description', qty:'', rate:'', disc:'0', amount:0})=>{
  return `
    <div class="product-row" data-idx="${idx}">
      <div class="idx">${idx}</div>
      <input class="desc" type="text" placeholder="Product description" value="${(prod.desc||'').replace(/"/g,'&quot;')}">
      <input class="qty" type="number" placeholder="Qty" min="0" value="${prod.qty||''}">
      <input class="rate" type="number" placeholder="Rate" min="0" value="${prod.rate||''}">
      <input class="disc" type="number" placeholder="Disc%" min="0" value="${prod.disc||0}">
      <div class="amount">₹<span class="amt">${money(prod.amount||0)}</span></div>
      <button class="removeItem" title="Remove" style="margin-left:8px">x</button>
    </div>`;
};

function initCreateForm(){
  // set id and date if empty
  const idEl = document.getElementById('invoiceId');
  if(!idEl.value) idEl.value = uid('');
  const dateEl = document.getElementById('invoiceDate');
  if(!dateEl.value) dateEl.value = todayISO();
  // populate default 4 rows
  if(!document.getElementById('productsContainer').innerHTML.trim()){
    const container = document.getElementById('productsContainer');
    container.innerHTML = '';
    for(let i=1;i<=4;i++){
      container.insertAdjacentHTML('beforeend', productTemplate(i));
    }
    attachProductEvents();
    recalcInvoiceTotals();
  }
}

document.getElementById('addProductBtn').addEventListener('click', ()=>{
  const container = document.getElementById('productsContainer');
  const idx = container.children.length + 1;
  container.insertAdjacentHTML('beforeend', productTemplate(idx));
  attachProductEvents();
});

document.getElementById('clearProductsBtn').addEventListener('click', ()=>{
  if(!confirm('Clear all product lines?')) return;
  document.getElementById('productsContainer').innerHTML='';
  for(let i=1;i<=4;i++) document.getElementById('productsContainer').insertAdjacentHTML('beforeend', productTemplate(i));
  attachProductEvents(); recalcInvoiceTotals();
});

function attachProductEvents(){
  document.querySelectorAll('.product-row .qty, .product-row .rate, .product-row .disc, .product-row .desc').forEach(el=>{
    el.oninput = ()=> { recalcInvoiceTotals(); };
  });
  document.querySelectorAll('.product-row .removeItem').forEach(btn=>{
    btn.onclick = (e)=>{
      const row = btn.closest('.product-row');
      row.remove();
      // reindex
      Array.from(document.querySelectorAll('.product-row')).forEach((r,i)=> r.querySelector('.idx').textContent = i+1);
      recalcInvoiceTotals();
    };
  });
}

function recalcInvoiceTotals(){
  const rows = Array.from(document.querySelectorAll('.product-row'));
  let subtotal = 0;
  rows.forEach(r=>{
    const qty = Number(r.querySelector('.qty').value||0);
    const rate = Number(r.querySelector('.rate').value||0);
    const disc = Number(r.querySelector('.disc').value||0);
    let amt = qty * rate;
    if(disc) amt = amt * (1 - disc/100);
    r.querySelector('.amt').textContent = money(amt);
    subtotal += amt;
  });
  document.getElementById('subtotal').textContent = money(subtotal);
  const taxPct = Number(document.getElementById('taxPct').value||0);
  const tax = subtotal * (taxPct/100);
  const tot = subtotal + tax;
  document.getElementById('total').textContent = money(tot);
}

document.getElementById('recalcBtn').addEventListener('click', recalcInvoiceTotals);
document.getElementById('taxPct').addEventListener('input', recalcInvoiceTotals);

/* ============== Save / print invoice ============= */
document.getElementById('saveInvoiceBtn').addEventListener('click', ()=>{
  const inv = readInvoiceForm();
  if(!inv || inv.items.length === 0) { alert('Add at least one product'); return; }
  invoices.push(inv);
  // add transaction record
  transactions.push({
    id: uid('tx'),
    date: inv.date,
    type: 'income',
    category: 'sales',
    pay: inv.payment,
    amount: Number(inv.total),
    invoiceId: inv.id
  });
  saveAll();
  alert('Invoice saved');
  renderInvoices();
  renderTransactions();
  renderDashboard();
});

function readInvoiceForm(){
  const id = document.getElementById('invoiceId').value || uid();
  const date = document.getElementById('invoiceDate').value || todayISO();
  const customer = document.getElementById('invoiceCustomer').value || '';
  const payment = document.getElementById('invoicePayment').value || 'Cash';
  const items = Array.from(document.querySelectorAll('.product-row')).map(r=>{
    const desc = r.querySelector('.desc').value || '';
    const qty = Number(r.querySelector('.qty').value||0);
    const rate = Number(r.querySelector('.rate').value||0);
    const disc = Number(r.querySelector('.disc').value||0);
    const amount = qty * rate * (1 - disc/100);
    return {desc, qty, rate, disc, amount};
  }).filter(i=>i.qty>0 || i.rate>0 || i.desc.trim());
  const subtotal = Number(document.getElementById('subtotal').textContent.replace(/,/g,''))||0;
  const taxPct = Number(document.getElementById('taxPct').value||0);
  const total = subtotal + subtotal*(taxPct/100);
  return { id, date, customer, payment, items, subtotal, taxPct, total };
}

/* ============== Print invoice ================ */
document.getElementById('printInvoiceBtn').addEventListener('click', ()=>{
  const inv = readInvoiceForm();
  if(!inv) return alert('No invoice to print');
  // open printable
  openPrintableWindow(inv);
});

function openPrintableWindow(inv){
  const company = {
    name: 'JBS KNIT WEAR',
    address: '3(2)/2B, Nesavalor Colony 2nd Street, P.N.Road, Tirupur',
    phone: '9791902205',
    gst: '33CKAPJ7513F1ZK'
  };
  // build HTML
  let rowsHtml = '';
  for(let i=0;i<Math.max(4, inv.items.length); i++){
    const it = inv.items[i] || {desc:'', qty:'', rate:'', amount:0};
    rowsHtml += `<tr><td style="width:40px;text-align:center">${i+1}</td>
      <td>${it.desc}</td>
      <td style="text-align:center;width:60px">${it.qty||''}</td>
      <td style="text-align:right;width:90px">${it.rate?Number(it.rate).toFixed(2):''}</td>
      <td style="text-align:right;width:110px">${it.amount?Number(it.amount).toFixed(2):'0.00'}</td></tr>`;
  }
  const totalStr = Number(inv.total).toFixed(2);
  const html = `
  <html><head><title>Invoice ${inv.id}</title>
  <style>
    body{font-family: Arial, Helvetica, sans-serif; padding:18px; font-size:13px}
    .top{display:flex;justify-content:space-between;align-items:flex-start}
    .company{font-weight:800;font-size:18px}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{border:1px solid #ccc;padding:6px}
    th{background:#f7f7f7}
    .right{text-align:right}
    .small{font-size:12px;color:#666}
    @media print{ body {margin:0} }
  </style>
  </head><body>
    <div class="top">
      <div>
        <div class="company">${company.name}</div>
        <div class="small">${company.address}</div>
        <div class="small">Phone: ${company.phone}</div>
        <div class="small">GSTIN: ${company.gst}</div>
      </div>
      <div style="text-align:right">
        <div>Date: ${inv.date}</div>
        <div>Invoice: ${inv.id}</div>
        <div>Customer: ${inv.customer}</div>
        <div>Payment: ${inv.payment}</div>
      </div>
    </div>
    <table>
      <thead><tr><th>#</th><th>Product</th><th>Qty</th><th>Rate</th><th>Amount</th></tr></thead>
      <tbody>${rowsHtml}</tbody>
    </table>
    <div style="margin-top:12px;text-align:right;font-weight:700">Total: ₹${totalStr}</div>
    <div style="margin-top:22px">Rupees: ${numToWords(Math.round(inv.total || 0))}</div>
    <div style="margin-top:22px">Payment: ${inv.payment}</div>
  </body></html>
  `;
  const w = window.open('about:blank','_blank');
  w.document.write(html);
  w.document.close();
  // allow user to print manually; can call w.print() if you want auto print
}

/* ================ numToWords (simple) =============== */
function numToWords(n){
  // simple english converter for numbers up to lakhs; good enough for UI
  const a = ['','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
  const b = ['', '', 'twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
  function inWords(num){
    if(num<20) return a[num];
    if(num<100) return b[Math.floor(num/10)] + (num%10? ' '+a[num%10] : '');
    if(num<1000) return a[Math.floor(num/100)] + ' hundred' + (num%100? ' and '+inWords(num%100):'');
    if(num<100000) return inWords(Math.floor(num/1000)) + ' thousand' + (num%1000? ' '+inWords(num%1000):'');
    return num;
  }
  return inWords(n) || 'zero';
}

/* =============== Invoices list render ============== */
function renderInvoices(){
  const tbody = document.getElementById('invoiceListBody');
  if(invoices.length===0){ tbody.innerHTML = '<tr><td colspan="6" style="color:var(--muted)">No invoices</td></tr>'; return; }
  tbody.innerHTML = invoices.map(inv=>{
    return `<tr>
      <td>${inv.id}</td>
      <td>${inv.date}</td>
      <td>${inv.customer || '-'}</td>
      <td>${inv.payment}</td>
      <td>₹${Number(inv.total).toFixed(2)}</td>
      <td>
        <button class="openInv" data-id="${inv.id}">Open</button>
        <button class="printInv" data-id="${inv.id}">Print</button>
        <button class="delInv" data-id="${inv.id}" style="background:#ff6f6f;border:none;padding:6px 8px;border-radius:8px;color:#fff">Del</button>
      </td>
    </tr>`;
  }).join('');
  // attach events
  Array.from(document.querySelectorAll('.openInv')).forEach(b=>b.onclick = e=>{
    const id=b.dataset.id; openInvoiceToCreate(id);
  });
  Array.from(document.querySelectorAll('.printInv')).forEach(b=>b.onclick = e=>{
    const id=b.dataset.id; const inv = invoices.find(x=>x.id===id);
    if(!inv) return alert('Invoice not found');
    openPrintableWindow(inv);
  });
  Array.from(document.querySelectorAll('.delInv')).forEach(b=>b.onclick = e=>{
    if(!confirm('Move invoice to trash?')) return;
    const id=b.dataset.id; const idx = invoices.findIndex(x=>x.id===id);
    if(idx>=0){ trash.push(invoices[idx]); invoices.splice(idx,1); saveAll(); renderInvoices(); renderDashboard(); alert('Moved to trash'); document.getElementById('trashCount').textContent = trash.length; }
  });
}

/* ================ Open invoice into create form for edit =============== */
function openInvoiceToCreate(id){
  const inv = invoices.find(x=>x.id===id);
  if(!inv) return alert('Invoice not found');
  // switch to create view
  document.querySelector('.nav button[data-view="create"]').click();
  // populate form
  document.getElementById('invoiceId').value = inv.id;
  document.getElementById('invoiceDate').value = inv.date;
  document.getElementById('invoiceCustomer').value = inv.customer;
  document.getElementById('invoicePayment').value = inv.payment;
  // populate products
  const container = document.getElementById('productsContainer'); container.innerHTML='';
  inv.items.forEach((it,i)=> container.insertAdjacentHTML('beforeend', productTemplate(i+1, it)));
  // fill remainder rows to 4
  for(let i=inv.items.length;i<4;i++) container.insertAdjacentHTML('beforeend', productTemplate(i+1));
  document.getElementById('taxPct').value = inv.taxPct || 0;
  attachProductEvents();
  recalcInvoiceTotals();
}

/* ================ Render transactions table =============== */
function renderTransactions(filter=null){
  const tbody = document.getElementById('txTableBody');
  if(transactions.length===0) { tbody.innerHTML = '<tr><td colspan="6" style="color:var(--muted)">No transactions</td></tr>'; return; }
  const rows = (filter ? transactions.filter(filter) : transactions).map(tx=>{
    return `<tr>
      <td>${tx.date}</td>
      <td>${tx.type}</td>
      <td>${tx.category}</td>
      <td>${tx.pay}</td>
      <td>₹${Number(tx.amount).toFixed(2)}</td>
      <td><button class="delTx" data-id="${tx.id}">Del</button></td>
    </tr>`;
  }).join('');
  tbody.innerHTML = rows;
  Array.from(document.querySelectorAll('.delTx')).forEach(b=>{
    b.onclick = ()=>{
      if(!confirm('Delete transaction?')) return;
      const id = b.dataset.id; const idx = transactions.findIndex(t=>t.id===id);
      if(idx>=0){ trash.push(transactions[idx]); transactions.splice(idx,1); saveAll(); renderTransactions(); renderDashboard(); document.getElementById('trashCount').textContent = trash.length; }
    };
  });
}

/* =============== Transactions add & filter ============== */
document.getElementById('addTxBtn').addEventListener('click', ()=>{
  const type = document.getElementById('txType').value;
  const category = document.getElementById('txCategory').value || (type === 'income' ? 'sales' : 'expense');
  const amount = Number(document.getElementById('txAmount').value||0);
  const date = document.getElementById('txDate').value || todayISO();
  const pay = document.getElementById('txPay').value || 'Cash';
  if(!amount || amount <= 0) return alert('Amount > 0 required');
  const tx = { id: uid('tx'), date, type, category, pay, amount };
  transactions.push(tx);
  saveAll(); renderTransactions(); renderDashboard();
  alert('Transaction added');
});

document.getElementById('filterTxBtn').addEventListener('click', ()=>{
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const type = document.getElementById('filterType').value;
  const filter = t=>{
    if(type !== 'all' && t.type !== type) return false;
    if(from && t.date < from) return false;
    if(to && t.date > to) return false;
    return true;
  };
  renderTransactions(filter);
});

document.getElementById('downloadTxCsv').addEventListener('click', ()=>{
  if(transactions.length===0) return alert('No transactions to export');
  const rows = [['Date','Type','Category','Pay','Amount'], ...transactions.map(t=>[t.date,t.type,t.category,t.pay,t.amount])];
  download('transactions.csv', csvFromArray(rows));
});

/* ================ Dashboard render ================ */
function renderDashboard(){
  // totals today
  const opening = Number(localStorage.getItem('opening_today')||0);
  const income = transactions.filter(t => t.type==='income').reduce((s,t)=>s+Number(t.amount),0);
  const expense = transactions.filter(t => t.type==='expense').reduce((s,t)=>s+Number(t.amount),0);
  const cashIncome = transactions.filter(t => t.type==='income' && t.pay==='Cash').reduce((s,t)=>s+Number(t.amount),0);
  const cashExpense = transactions.filter(t => t.type==='expense' && t.pay==='Cash').reduce((s,t)=>s+Number(t.amount),0);
  const cashRemaining = opening + cashIncome - cashExpense;
  document.getElementById('totalIncome').textContent = '₹'+money(income);
  document.getElementById('totalExpense').textContent = '₹'+money(expense);
  document.getElementById('cashRemain').textContent = '₹'+money(cashRemaining);
  document.getElementById('profitDisplay').textContent = '₹'+money(income - expense);

  // recent transactions - show latest 6
  const recent = transactions.slice(-6).reverse();
  const tbody = document.getElementById('recentTransactions');
  if(recent.length==0) tbody.innerHTML = '<tr><td colspan="5" style="color:var(--muted)">No recent transactions</td></tr>';
  else tbody.innerHTML = recent.map(t=>`<tr><td>${t.date}</td><td>${t.type}</td><td>${t.category}</td><td>${t.pay}</td><td>₹${Number(t.amount).toFixed(2)}</td></tr>`).join('');
}

/* ================ Invoices CSV exports ============== */
document.getElementById('exportAllCsv').addEventListener('click', ()=>exportInvoicesCsv('all'));
document.getElementById('exportCashCsv').addEventListener('click', ()=>exportInvoicesCsv('Cash'));
document.getElementById('exportGpayCsv').addEventListener('click', ()=>exportInvoicesCsv('GPay'));

function exportInvoicesCsv(filter='all'){
  if(invoices.length===0) return alert('No invoices');
  let rows = [['Invoice','Date','Customer','Payment','Subtotal','Tax%','Total','Products']];
  const data = invoices.filter(inv=>{
    if(filter==='all') return true;
    return inv.payment === filter;
  });
  data.forEach(inv=>{
    const prods = inv.items.map(it=>`${it.desc} (x${it.qty} @ ${it.rate})`).join('; ');
    rows.push([inv.id,inv.date,inv.customer,inv.payment,inv.subtotal,inv.taxPct,inv.total,prods]);
  });
  download('invoices_'+(filter==='all'?'all':filter)+'.csv', csvFromArray(rows));
}

/* ============== EOD Export: save into localStorage and download ============== */
document.getElementById('eodExportBtn').addEventListener('click', ()=>{
  const date = todayISO();
  // collect today's invoices and transactions
  const todaysInvoices = invoices.filter(i => i.date === date);
  const todaysTransactions = transactions.filter(t => t.date === date);
  if(todaysInvoices.length===0 && todaysTransactions.length===0) return alert('No data for today');
  // create CSVs
  const invRows = [['Invoice','Date','Customer','Pay','Total'], ...todaysInvoices.map(i=>[i.id,i.date,i.customer,i.payment,i.total])];
  const txRows = [['Date','Type','Category','Pay','Amount'], ...todaysTransactions.map(t=>[t.date,t.type,t.category,t.pay,t.amount])];
  const invCSV = csvFromArray(invRows), txCSV = csvFromArray(txRows);
  // store in EOD exports
  eodExports.push({date, invCSV, txCSV, ts: Date.now()});
  saveAll();
  // download zipped? we will download two files separately
  download(`eod_invoices_${date}.csv`, invCSV);
  download(`eod_transactions_${date}.csv`, txCSV);
  alert('EOD Exported & saved');
});

/* ============== Backup export/import =============== */
document.getElementById('exportBackupBtn').addEventListener('click', ()=>{
  const payload = {invoices, transactions, trash, eodExports, ts:Date.now()};
  download('billing_backup.json', JSON.stringify(payload));
});
document.getElementById('importBackupBtn').addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='.json';
  input.onchange = (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      try{
        const data = JSON.parse(ev.target.result);
        if(confirm('Import backup and replace current data? This will overwrite current data. Continue?')){
          invoices = data.invoices || []; transactions = data.transactions || []; trash = data.trash || []; eodExports = data.eodExports || [];
          saveAll(); renderInvoices(); renderTransactions(); renderDashboard();
          alert('Import complete');
        }
      }catch(err){ alert('Invalid backup'); }
    };
    reader.readAsText(f);
  };
  input.click();
});

/* ================ Printable select populate ============= */
function populatePrintSelect(){
  const sel = document.getElementById('printSelect'); sel.innerHTML = '';
  if(invoices.length===0){ sel.innerHTML = '<option>No invoices</option>'; return; }
  invoices.forEach(inv=> sel.insertAdjacentHTML('beforeend', `<option value="${inv.id}">${inv.id} — ${inv.date} — ${inv.customer||'-'}</option>`));
}
document.getElementById('openPrintableBtn').addEventListener('click', ()=>{
  const id = document.getElementById('printSelect').value;
  const inv = invoices.find(i=>i.id===id);
  if(!inv) return alert('Invoice not found');
  openPrintableWindow(inv);
});

/* ================ Trash UI =============== */
document.getElementById('openTrashBtn').addEventListener('click', ()=>{
  if(trash.length===0) return alert('Trash is empty');
  if(confirm('Restore all trashed items back? (OK to restore all)')) { invoices = invoices.concat(trash.filter(i=>i.items)); transactions = transactions.concat(trash.filter(t=>t.amount)); trash = []; saveAll(); renderInvoices(); renderTransactions(); renderDashboard(); alert('Restored'); }
});
document.getElementById('trashCount').textContent = trash.length;

/* ============== Quick invoice panel ============= */
document.getElementById('quickAddBtn').addEventListener('click', ()=>{
  const quick = Number(document.getElementById('quickTotal').value||0);
  if(!quick || quick<=0) return alert('Enter amount');
  // create quick invoice minimal
  const inv = { id: uid('inv'), date: todayISO(), customer:'Quick', payment:'Cash', items:[{desc:'Quick sale',qty:1,rate:quick,amount:quick}], subtotal:quick, taxPct:0, total:quick };
  invoices.push(inv);
  transactions.push({id:uid('tx'),date:inv.date,type:'income',category:'sales',pay:inv.payment,amount:inv.total, invoiceId:inv.id});
  saveAll(); renderInvoices(); renderTransactions(); renderDashboard();
  alert('Quick invoice saved');
});

/* ================ Init & render on load ============== */
function boot(){
  // init create form
  initCreateForm();
  renderInvoices();
  renderTransactions();
  renderDashboard();
  populatePrintSelect();
  document.getElementById('trashCount').textContent = trash.length;
}
boot();

/* ================ Invoices printing / open from list fix ============= */
/* attach invoice open handlers on initial render already done in renderInvoices */

/* ================ Search invoices live ================ */
document.getElementById('searchInvoice').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase().trim();
  const tbody = document.getElementById('invoiceListBody');
  const filtered = invoices.filter(inv => inv.id.toLowerCase().includes(q) || (inv.customer||'').toLowerCase().includes(q));
  if(filtered.length===0) tbody.innerHTML = '<tr><td colspan="6" style="color:var(--muted)">No invoices</td></tr>';
  else {
    tbody.innerHTML = filtered.map(inv=>`<tr><td>${inv.id}</td><td>${inv.date}</td><td>${inv.customer||'-'}</td><td>${inv.payment}</td><td>₹${Number(inv.total).toFixed(2)}</td>
    <td><button class="openInv" data-id="${inv.id}">Open</button><button class="printInv" data-id="${inv.id}">Print</button><button class="delInv" data-id="${inv.id}">Del</button></td></tr>`).join('');
    Array.from(document.querySelectorAll('.openInv')).forEach(b=>b.onclick = ()=> openInvoiceToCreate(b.dataset.id));
    Array.from(document.querySelectorAll('.printInv')).forEach(b=>b.onclick = ()=> { const inv = invoices.find(x=>x.id===b.dataset.id); openPrintableWindow(inv); });
    Array.from(document.querySelectorAll('.delInv')).forEach(b=>b.onclick = ()=> { if(confirm('Move invoice to trash?')){ const idx = invoices.findIndex(i=>i.id===b.dataset.id); if(idx>=0){ trash.push(invoices[idx]); invoices.splice(idx,1); saveAll(); renderInvoices(); renderDashboard(); } } });
  }
});

/* ================ Export CSV helpers for invoices - improved csv content ============== */
document.getElementById('exportAllCsv').addEventListener('click', ()=>exportInvoicesCsv('all'));
document.getElementById('exportCashCsv').addEventListener('click', ()=>exportInvoicesCsv('Cash'));
document.getElementById('exportGpayCsv').addEventListener('click', ()=>exportInvoicesCsv('GPay'));

/* final safety: re-render after load changes in other tabs */
window.addEventListener('storage', ()=> { invoices = JSON.parse(localStorage.getItem(KEY_INVOICES)||'[]'); transactions = JSON.parse(localStorage.getItem(KEY_TRANSACTIONS)||'[]'); renderInvoices(); renderTransactions(); renderDashboard(); populatePrintSelect(); });

</script>
</body>
</html>
