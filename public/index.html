<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing — JBS KNIT WEAR</title>
<style>
  :root{
    --bg:#f4f6f8; --card:#fff; --muted:#7b8794; --accent:#1e90ff; --danger:#ff6b4a;
    --radius:12px; --gap:18px; --sidebar-w:260px; --max-w:1200px;
  }
  /* base */
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{background:var(--bg); color:#111;}
  .app{display:flex;min-height:100vh;}
  /* sidebar */
  .sidebar{width:var(--sidebar-w); background:linear-gradient(#ffffff,#fbfdff); padding:28px 18px; box-shadow: 6px 0 18px rgba(18,24,40,0.03); position:sticky; top:0; height:100vh; box-sizing:border-box;}
  .brand{font-weight:800; font-size:20px; margin-bottom:14px;}
  .brand small{font-weight:400;color:var(--muted); margin-left:6px;font-size:13px;}
  .nav{margin-top:18px;}
  .nav a{display:block;padding:12px 14px;border-radius:10px;color:#0f1724;text-decoration:none;margin-bottom:6px;}
  .nav a .muted{display:block;color:var(--muted);font-size:13px;margin-top:4px;}
  .nav a.active{background:#edf6ff;border-left:4px solid var(--accent);box-shadow:0 6px 20px rgba(25,118,210,0.05)}
  .sidebar .small{font-size:12px;color:var(--muted);margin-top:18px;display:block;}
  .sidebar .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:1px solid #e6edf3;background:#fff;margin-right:8px;margin-top:12px;cursor:pointer;}
  /* main */
  .main{flex:1;padding:20px 36px;box-sizing:border-box;max-width:calc(100% - var(--sidebar-w));}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
  .open-balance{background:var(--card);padding:10px;border-radius:10px;box-shadow:0 6px 20px rgba(18,24,40,0.03);display:flex;gap:12px;align-items:center;}
  .open-balance input{width:120px;padding:10px;border-radius:8px;border:1px solid #e7eef6;}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:20px;max-width:var(--max-w);margin:8px auto;}
  .card{background:var(--card);border-radius:var(--radius);padding:22px;box-shadow:0 12px 30px rgba(18,24,40,0.04);}
  h1{margin:0;font-size:28px;}
  h2{font-size:16px;margin:14px 0;color:var(--muted);}
  /* dashboard */
  .stat-grid{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
  .stat{background:#fff;border-radius:12px;padding:16px;min-width:180px;box-shadow:0 6px 18px rgba(18,24,40,0.03);}
  .stat p{margin:0;color:var(--muted);font-size:13px;}
  .stat strong{display:block;font-size:20px;margin-top:6px;}
  /* create invoice */
  .invoice-panel{max-width:900px;margin:0 auto;}
  .row{display:flex;gap:12px;align-items:center;}
  .form-row{display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap;}
  input[type="text"], input[type="number"], select{padding:12px;border-radius:8px;border:1px solid #e8eef6;background:#fff;min-width:120px;}
  .product-list{margin-top:12px;}
  .product-item{display:grid;grid-template-columns:40px 1fr 80px 80px 60px 70px;gap:12px;align-items:center;padding:14px;border-radius:10px;border:1px solid #eef3f7;margin-bottom:12px;background:#fff;}
  .product-item .no{color:var(--muted);font-weight:700;}
  .product-item input{padding:8px;border-radius:8px;border:1px solid #eef3f7;}
  .product-actions{display:flex;gap:8px;align-items:center;}
  .btn-primary{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;}
  .btn-ghost{background:#fff;border:1px solid #e6edf3;padding:8px 12px;border-radius:8px;cursor:pointer;}
  .btn-danger{background:var(--danger);color:#fff;padding:8px 12px;border-radius:8px;border:none;}
  .invoice-totals{display:flex;flex-direction:column;align-items:flex-end;gap:6px;margin-top:8px;}
  .invoice-totals strong{font-size:18px;}
  /* invoices list */
  table{width:100%;border-collapse:collapse;}
  th,td{padding:12px;text-align:left;border-bottom:1px solid #eef3f7;}
  th{background:transparent;color:var(--muted);}
  .actions button{margin-right:8px;}
  /* transactions */
  .tx-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;}
  /* responsive */
  @media (max-width:980px){
    .layout{grid-template-columns:1fr;max-width:100%;}
    .main{padding:12px;}
    .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(0);z-index:110;overflow:auto;}
  }
  @media (max-width:640px){
    .sidebar{width:60px;padding:12px;}
    .nav a .muted{display:none;}
    .brand{font-size:14px;}
    .open-balance input{width:80px;}
    .product-item{grid-template-columns:30px 1fr;}
    .invoice-totals{text-align:right;align-items:flex-end;}
  }

  /* print invoice template page size ~ 200mm x 140mm and portrait */
  @media print{
    @page { size: 200mm 140mm portrait; margin:10mm; }
    body *{visibility:hidden;}
    .print-area, .print-area *{visibility:visible;}
    .print-area{position:fixed;left:0;top:0;width:100%;}
  }
  /* small helpers */
  .muted{color:var(--muted)}
  .right{margin-left:auto}
  .hidden{display:none}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" role="navigation">
    <div class="brand">JBS KNIT WEAR <small>— Billing</small></div>
    <nav class="nav" id="nav">
      <a href="#dashboard" data-view="dashboard" class="active">Dashboard <span class="muted">Quick totals & recent</span></a>
      <a href="#transactions" data-view="transactions">Transactions <span class="muted">Income & expense add</span></a>
      <a href="#create" data-view="create">Create Invoice <span class="muted">Add products & save</span></a>
      <a href="#invoices" data-view="invoices">Invoices <span class="muted">Saved invoices list</span></a>
      <a href="#printable" data-view="printable">Printable template <span class="muted">View / print invoice</span></a>
    </nav>

    <div class="small">Tip: export a backup before major changes</div>
    <div>
      <button class="btn" id="btnExportBackup">Export backup</button>
      <button class="btn" id="btnImportBackup">Import</button>
    </div>
    <div style="margin-top:14px">
      <button class="btn" id="openTrash">Trash (<span id="trashCount">0</span>)</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div><h1 id="pageTitle">Billing</h1><div class="muted">— manage invoices & quick sales</div></div>
      <div class="open-balance">
        <div class="muted">Opening balance (today)</div>
        <input id="openingInput" type="number" step="0.01" placeholder="0.00" />
        <button class="btn-primary" id="setOpening">Set</button>
        <button class="btn-ghost" id="clearOpening">Clear</button>
      </div>
    </div>

    <!-- layout: content + right panel -->
    <div class="layout" id="layout">
      <!-- main content area -->
      <div id="contentColumn">

        <!-- Dashboard view -->
        <section id="view-dashboard" class="card view">
          <h1>Billing Dashboard</h1>
          <h2 class="muted">Quick overview of today's totals and recent activity</h2>
          <div class="stat-grid">
            <div class="stat"><p>Total Income</p><strong id="statIncome">₹0.00</strong></div>
            <div class="stat"><p>Total Expense</p><strong id="statExpense">₹0.00</strong></div>
            <div class="stat"><p>Cash Remaining</p><strong id="statCash">₹0.00</strong></div>
          </div>
          <div style="margin-top:18px;display:flex;justify-content:space-between;align-items:flex-start">
            <div style="flex:1;margin-right:12px">
              <h2 style="margin-bottom:10px">Recent transactions</h2>
              <div class="card" style="padding:0">
                <table id="recentTx">
                  <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th>Amount</th></tr></thead>
                  <tbody><tr><td colspan="5" class="muted">No recent transactions</td></tr></tbody>
                </table>
              </div>
            </div>
            <div style="width:330px">
              <div class="card">
                <h3>Quick invoice panel</h3>
                <div style="margin-top:8px"><input id="quickTotal" placeholder="Quick total" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e9f0f6" /></div>
                <div style="margin-top:8px"><button class="btn-primary" id="btnQuickAdd">Add</button></div>
                <div class="muted" style="margin-top:12px;font-size:13px">Use 'Create Invoice' to open full editor</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Transactions view -->
        <section id="view-transactions" class="card view hidden">
          <h1>Transactions</h1>
          <h2 class="muted">Quick add income & expense</h2>

          <div class="card" style="margin-top:12px">
            <div class="tx-filters">
              <select id="txType"><option value="income">Income</option><option value="expense">Expense</option></select>
              <input id="txCategory" placeholder="Category" />
              <input id="txAmount" placeholder="Amount" type="number" />
              <input id="txDate" placeholder="dd/mm/yyyy" />
              <select id="txPay"><option value="Cash">Cash</option><option value="GPay">GPay</option></select>
              <button class="btn-primary" id="addTx">Add</button>
            </div>

            <div style="margin-top:8px;">
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
                <input id="filterFrom" placeholder="from date" />
                <input id="filterTo" placeholder="to date" />
                <select id="filterPay"><option value="All">All</option><option value="Cash">Cash</option><option value="GPay">GPay</option></select>
                <button class="btn-ghost" id="btnFilter">Filter</button>
                <button class="btn-ghost" id="btnClearFilter">Clear</button>
                <div class="right"><button class="btn-primary" id="exportTxCsv">Download CSV</button></div>
              </div>
              <table id="txTable"><thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th>Amount</th></tr></thead><tbody><tr><td colspan="5" class="muted">No transactions added</td></tr></tbody></table>
            </div>
          </div>
        </section>

        <!-- Create Invoice view -->
        <section id="view-create" class="card view hidden invoice-panel">
          <h1>Create Invoice</h1>
          <div class="form-row" style="margin-top:12px">
            <input id="invNo" placeholder="Invoice no (auto)" style="flex:0 0 140px"/>
            <input id="invDate" placeholder="dd/mm/yyyy" style="flex:0 0 170px"/>
            <input id="invCustomer" placeholder="Customer name" style="flex:1"/>
          </div>
          <div style="margin-top:10px">
            <label class="muted">Payment Method</label>
            <select id="invPay" style="display:block;padding:10px;border-radius:8px;border:1px solid #eef3f7;margin-top:6px;width:170px;">
              <option value="Cash">Cash</option><option value="GPay">GPay</option>
            </select>
          </div>

          <div style="margin-top:12px;display:flex;align-items:center;justify-content:space-between">
            <h3 style="margin:0">Products</h3>
            <div>
              <button class="btn-primary" id="addProduct">+ Add</button>
              <button class="btn-ghost" id="clearProducts">Clear</button>
              <button class="btn-ghost" id="recalc">Recalc</button>
            </div>
          </div>

          <div id="productList" class="product-list">
            <!-- product rows inserted by JS -->
          </div>

          <div style="display:flex;justify-content:flex-end;gap:12px;">
            <div class="invoice-totals">
              <div>Subtotal: <strong id="displaySubtotal">₹0.00</strong></div>
              <div>Tax %: <input id="taxPct" type="number" value="0" style="width:80px;padding:6px;border-radius:8px;border:1px solid #eef3f7" /> <span id="displayTax">₹0.00</span></div>
              <div><strong>Total <span id="displayTotal">₹0.00</span></strong></div>
            </div>
          </div>

          <div style="margin-top:18px;display:flex;gap:12px;">
            <button class="btn-primary" id="saveInvoice">Save</button>
            <button class="btn-ghost" id="printInvoice">Print</button>
            <button class="btn-danger" id="resetInvoice">Reset</button>
          </div>
        </section>

        <!-- Invoices view -->
        <section id="view-invoices" class="card view hidden">
          <h1>Invoices</h1>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
            <input id="searchInv" placeholder="Search invoice / customer" style="padding:10px;border-radius:8px;border:1px solid #eef3f7;flex:1" />
            <button class="btn-primary" id="exportAllCsv">Export CSV (all)</button>
            <button class="btn-ghost" id="exportCashCsv">Export Cash</button>
            <button class="btn-ghost" id="exportGpayCsv">Export GPay</button>
          </div>
          <div class="card">
            <table id="invoicesTable">
              <thead><tr><th>Invoice</th><th>Date</th><th>Customer</th><th>Pay</th><th>Total</th><th>Actions</th></tr></thead>
              <tbody><tr><td colspan="6" class="muted">No invoices</td></tr></tbody>
            </table>
          </div>
        </section>

        <!-- Printable view -->
        <section id="view-printable" class="card view hidden">
          <h1>Printable template</h1>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <select id="printSelect" style="flex:1;padding:10px;border-radius:8px;border:1px solid #eef3f7"></select>
            <button class="btn-primary" id="openPrintable">Open</button>
          </div>
        </section>

      </div>

      <!-- right column -->
      <aside id="rightColumn">
        <!-- kept intentionally for layout; small widgets shown on desktop -->
      </aside>
    </div>
  </main>
</div>

<!-- Printable HTML template helper hidden -->
<template id="printTemplate">
  <div class="print-area" style="font-family:Arial,Helvetica,sans-serif;padding:8mm;">
    <div style="display:flex;justify-content:space-between;">
      <div>
        <h2>JBS KNIT WEAR</h2>
        <div>3(2)/2B, Nesavalar Colony 2nd Street, P.N.Road, Tirupur</div>
        <div>Phone: 9791902205</div>
        <div>GSTIN: 33CKAPJ7513F1ZK</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:12px">Date: {{date}}</div>
        <div style="font-size:12px">Invoice: {{invNo}}</div>
        <div style="font-size:12px">Customer: {{customer}}</div>
        <div style="font-size:12px">Payment: {{pay}}</div>
      </div>
    </div>

    <table style="width:100%;border-collapse:collapse;margin-top:10px;">
      <thead>
        <tr>
          <th style="border:1px solid #000;padding:6px">#</th>
          <th style="border:1px solid #000;padding:6px">Product</th>
          <th style="border:1px solid #000;padding:6px">Qty</th>
          <th style="border:1px solid #000;padding:6px">Rate</th>
          <th style="border:1px solid #000;padding:6px">Amount</th>
        </tr>
      </thead>
      <tbody>
        {{rows}}
      </tbody>
    </table>

    <div style="margin-top:12px;text-align:right;font-weight:700">
      Total: ₹{{total}}
    </div>
    <div style="margin-top:12px">Rupees: {{totalWords}}</div>
  </div>
</template>

<script>
/* =========================
   Simple Billing App JS
   - Stores in localStorage with stable keys
   - invoices, trash, transactions
   ========================= */

/* ---------- STORAGE KEYS ---------- */
const STORAGE_INVOICES = 'billingapp_v1_invoices';
const STORAGE_TRASH = 'billingapp_v1_trash';
const STORAGE_TX = 'billingapp_v1_transactions';
const STORAGE_BACKUPS = 'billingapp_v1_backups';

/* ---------- in-memory ---------- */
let invoices = loadJSON(STORAGE_INVOICES) || [];
let trash = loadJSON(STORAGE_TRASH) || [];
let transactions = loadJSON(STORAGE_TX) || [];

/* ---------- helpers ---------- */
function saveJSON(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
function loadJSON(k){ try { const s = localStorage.getItem(k); return s ? JSON.parse(s) : null; } catch(e){return null;} }
function uuid(){ return 'id-' + Math.random().toString(36).slice(2,11); }
function money(v){ return '₹' + Number(v || 0).toFixed(2); }
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }
function toDMY(iso){ if(!iso) return ''; const d=new Date(iso); return (d.getDate().toString().padStart(2,'0')) + '/' + ((d.getMonth()+1).toString().padStart(2,'0')) + '/' + d.getFullYear(); }
function moneyValue(s){ return Number(String(s||'').replace(/[^0-9.-]+/g,'')) || 0; }

/* ---------- UI navigation ---------- */
document.querySelectorAll('[data-view]').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    const v = a.dataset.view;
    showView(v);
    // highlight active
    document.querySelectorAll('.nav a').forEach(n=>n.classList.remove('active'));
    a.classList.add('active');
  });
});
function showView(view){
  document.querySelectorAll('.view').forEach(el=>el.classList.add('hidden'));
  const el = document.getElementById('view-' + view);
  if(el) el.classList.remove('hidden');
  document.getElementById('pageTitle').textContent = view.charAt(0).toUpperCase() + view.slice(1);
  // refresh content for the view
  if(view === 'dashboard') renderDashboard();
  if(view === 'invoices') renderInvoices();
  if(view === 'printable') refreshPrintableSelect();
  if(view === 'transactions') renderTxTable();
  if(view === 'create') renderCreate();
}
showView('dashboard');

/* ---------- Dashboard ---------- */
function renderDashboard(){
  const income = transactions.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amount||0),0);
  const expense = transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amount||0),0);
  const cashIncome = transactions.filter(t=>t.pay==='Cash').reduce((s,t)=>s+Number(t.amount||0),0);
  const cashExpense = transactions.filter(t=>t.pay==='Cash' && t.type==='expense').reduce((s,t)=>s+Number(t.amount||0),0);
  const cashRemaining = cashIncome - cashExpense;
  document.getElementById('statIncome').textContent = money(income);
  document.getElementById('statExpense').textContent = money(expense);
  document.getElementById('statCash').textContent = money(cashRemaining);

  // recent transactions
  const tbody = document.querySelector('#recentTx tbody');
  tbody.innerHTML = '';
  const recent = transactions.slice().reverse().slice(0,8);
  if(!recent.length){ tbody.innerHTML = '<tr><td colspan="5" class="muted">No recent transactions</td></tr>'; return; }
  recent.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.date||''}</td><td>${t.type}</td><td>${escapeHtml(t.category)}</td><td>${t.pay||''}</td><td>${money(t.amount)}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- Transactions ---------- */
document.getElementById('addTx').addEventListener('click', ()=>{
  const type = document.getElementById('txType').value;
  const cat = document.getElementById('txCategory').value || 'General';
  const amount = Number(document.getElementById('txAmount').value || 0);
  const date = document.getElementById('txDate').value || todayISO();
  const pay = document.getElementById('txPay').value || 'Cash';
  if(!amount || amount <= 0){ alert('Enter an amount'); return; }
  const tx = { id: uuid(), type, category:cat, amount, date, pay };
  transactions.push(tx);
  saveJSON(STORAGE_TX, transactions);
  renderDashboard(); renderTxTable();
  alert('Transaction added');
});
document.getElementById('btnFilter').addEventListener('click', ()=>{ renderTxTable(); });
document.getElementById('btnClearFilter').addEventListener('click', ()=>{ document.getElementById('filterFrom').value=''; document.getElementById('filterTo').value=''; document.getElementById('filterPay').value='All'; renderTxTable(); });

function renderTxTable(){
  const tbody = document.querySelector('#txTable tbody'); tbody.innerHTML='';
  let list = transactions.slice().reverse();
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const pay = document.getElementById('filterPay').value;
  if(from) list = list.filter(t=>t.date >= from);
  if(to) list = list.filter(t=>t.date <= to);
  if(pay && pay !== 'All') list = list.filter(t=>t.pay === pay);
  if(!list.length){ tbody.innerHTML = '<tr><td colspan="5" class="muted">No transactions added</td></tr>'; return; }
  list.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.date}</td><td>${t.type}</td><td>${escapeHtml(t.category)}</td><td>${t.pay}</td><td>${money(t.amount)}</td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById('exportTxCsv').addEventListener('click', ()=> {
  downloadCSV(transactions, 'transactions.csv');
});

/* ---------- Create invoice ---------- */
function renderCreate(){
  // fill defaults
  if(!document.getElementById('invDate').value) document.getElementById('invDate').value = todayISO();
  if(!document.getElementById('invNo').value) document.getElementById('invNo').value = String(invoices.length + 1);
  renderProducts();
  recalcTotals();
}
let productRows = [];

/* product management */
function renderProducts(){
  const container = document.getElementById('productList'); container.innerHTML='';
  if(productRows.length === 0){
    for(let i=0;i<4;i++) productRows.push(newEmptyProduct());
  }
  productRows.forEach((pr, idx)=>{
    const div = document.createElement('div'); div.className='product-item';
    div.innerHTML = `
      <div class="no">${idx+1}</div>
      <div><input class="prod-desc" data-i="${idx}" placeholder="Product description" value="${escapeHtml(pr.desc||'')}" /></div>
      <div><input class="prod-qty" type="number" data-i="${idx}" value="${pr.qty||0}" /></div>
      <div><input class="prod-rate" type="number" data-i="${idx}" value="${pr.rate||0}" /></div>
      <div><input class="prod-disc" type="number" data-i="${idx}" value="${pr.disc||0}" /></div>
      <div style="text-align:right;">
        <div style="font-weight:700" id="amt-${idx}">${money(pr.amount||0)}</div>
        <div style="margin-top:6px"><button class="btn-ghost btn-del" data-i="${idx}">x</button></div>
      </div>`;
    container.appendChild(div);
  });

  // events
  container.querySelectorAll('.prod-desc').forEach(i=>i.addEventListener('input', e=> {
    const idx = Number(e.target.dataset.i); productRows[idx].desc = e.target.value;
  }));
  container.querySelectorAll('.prod-qty').forEach(i=>i.addEventListener('input', e=> {
    const idx = Number(e.target.dataset.i); productRows[idx].qty = Number(e.target.value || 0); recalcRow(idx);
  }));
  container.querySelectorAll('.prod-rate').forEach(i=>i.addEventListener('input', e=> {
    const idx = Number(e.target.dataset.i); productRows[idx].rate = Number(e.target.value || 0); recalcRow(idx);
  }));
  container.querySelectorAll('.prod-disc').forEach(i=>i.addEventListener('input', e=> {
    const idx = Number(e.target.dataset.i); productRows[idx].disc = Number(e.target.value || 0); recalcRow(idx);
  }));
  container.querySelectorAll('.btn-del').forEach(b=>b.addEventListener('click', e=>{
    const i = Number(b.dataset.i);
    productRows.splice(i,1);
    renderProducts(); recalcTotals();
  }));
}
function newEmptyProduct(){ return { desc:'', qty:0, rate:0, disc:0, amount:0 }; }
document.getElementById('addProduct').addEventListener('click', ()=>{ productRows.push(newEmptyProduct()); renderProducts(); });
document.getElementById('clearProducts').addEventListener('click', ()=>{ productRows = []; for(let i=0;i<4;i++) productRows.push(newEmptyProduct()); renderProducts(); recalcTotals(); });
document.getElementById('recalc').addEventListener('click', ()=>recalcTotals());

function recalcRow(idx){
  const p = productRows[idx];
  p.amount = Math.max(0, (p.qty||0) * (p.rate||0) * (1 - (p.disc||0)/100));
  const amtEl = document.getElementById('amt-' + idx);
  if(amtEl) amtEl.textContent = money(p.amount);
  recalcTotals();
}
function recalcTotals(){
  const subtotal = productRows.reduce((s,p)=>s + Number(p.amount || 0),0);
  const taxPct = Number(document.getElementById('taxPct').value || 0);
  const tax = subtotal * taxPct/100;
  const total = subtotal + tax;
  document.getElementById('displaySubtotal').textContent = money(subtotal);
  document.getElementById('displayTax').textContent = money(tax);
  document.getElementById('displayTotal').textContent = money(total);
}

/* invoice saving / printing */
document.getElementById('taxPct').addEventListener('input', recalcTotals);

document.getElementById('saveInvoice').addEventListener('click', ()=>{
  const invNo = document.getElementById('invNo').value || String(invoices.length + 1);
  const date = document.getElementById('invDate').value || todayISO();
  const customer = document.getElementById('invCustomer').value || '';
  const pay = document.getElementById('invPay').value || 'Cash';
  const subtotal = productRows.reduce((s,p)=>s + Number(p.amount || 0),0);
  const taxPct = Number(document.getElementById('taxPct').value || 0);
  const tax = subtotal * taxPct/100;
  const total = subtotal + tax;
  // ensure id
  const id = uuid();
  const inv = { id, invNo:String(invNo), date, customer, pay, subtotal, taxPct, tax, total, products: JSON.parse(JSON.stringify(productRows)) };
  invoices.push(inv);
  saveJSON(STORAGE_INVOICES, invoices);
  // also add a transaction record for sale
  transactions.push({ id: uuid(), date, type: 'income', category: 'Sales', amount: total, pay });
  saveJSON(STORAGE_TX, transactions);
  renderDashboard(); renderInvoices();
  alert('Saved invoice ' + inv.invNo);
});

document.getElementById('printInvoice').addEventListener('click', ()=>{
  // try to find last saved invoice matching invNo or show preview
  const invNo = document.getElementById('invNo').value;
  let inv = invoices.find(x=>String(x.invNo) === String(invNo));
  if(!inv){
    // build from current form
    const date = document.getElementById('invDate').value || todayISO();
    const customer = document.getElementById('invCustomer').value || '';
    const pay = document.getElementById('invPay').value || 'Cash';
    const subtotal = productRows.reduce((s,p)=>s + Number(p.amount || 0),0);
    const taxPct = Number(document.getElementById('taxPct').value || 0);
    const tax = subtotal * taxPct/100;
    const total = subtotal + tax;
    inv = { id: uuid(), invNo:invNo || String(invoices.length+1), date, customer, pay, subtotal, taxPct, tax, total, products: JSON.parse(JSON.stringify(productRows)) };
  }
  openPrintableWindow(inv);
});

/* print helpers */
function renderPrintableHtml(inv){
  const tpl = document.getElementById('printTemplate').innerHTML;
  const rows = (inv.products || []).map((p,i)=>`<tr><td style="border:1px solid #000;padding:6px">${i+1}</td><td style="border:1px solid #000;padding:6px">${escapeHtml(p.desc)}</td><td style="border:1px solid #000;padding:6px">${p.qty||0}</td><td style="border:1px solid #000;padding:6px">${Number(p.rate||0).toFixed(2)}</td><td style="border:1px solid #000;padding:6px">${Number(p.amount||0).toFixed(2)}</td></tr>`).join('');
  return tpl.replace('{{date}}', inv.date).replace('{{invNo}}', inv.invNo).replace('{{customer}}', escapeHtml(inv.customer||'')).replace('{{pay}}', inv.pay||'Cash').replace('{{rows}}', rows).replace('{{total}}', Number(inv.total||0).toFixed(2)).replace('{{totalWords}}', numberToWords(Math.round(inv.total||0)));
}
function openPrintableWindow(inv){
  const html = renderPrintableHtml(inv);
  const w = window.open('about:blank','_blank');
  w.document.open();
  w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Invoice ${inv.invNo}</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;padding:8mm}
      table{width:100%;border-collapse:collapse}
    </style>
  </head><body>${html}</body></html>`);
  w.document.close();
  // give a bit time then trigger print in case user pressed Print
}

/* ---------- Invoices list ---------- */
function renderInvoices(){
  const tbody = document.querySelector('#invoicesTable tbody'); tbody.innerHTML='';
  if(!invoices.length){ tbody.innerHTML = '<tr><td colspan="6" class="muted">No invoices</td></tr>'; return; }
  // newest first
  invoices.slice().reverse().forEach(inv=>{
    if(!inv.id) inv.id = uuid();
    if(!inv.invNo) inv.invNo = String(inv.id);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(String(inv.invNo))}</td><td>${inv.date||''}</td><td>${escapeHtml(inv.customer||'')}</td><td>${inv.pay||''}</td><td>${money(inv.total||0)}</td>
      <td class="actions">
        <button class="btn-ghost btn-open" data-id="${inv.id}">Open</button>
        <button class="btn-ghost btn-print" data-id="${inv.id}">Print</button>
        <button class="btn-danger btn-delete" data-id="${inv.id}">Del</button>
      </td>`;
    tbody.appendChild(tr);
  });

  // attach events
  document.querySelectorAll('.btn-open').forEach(b=>b.onclick = (e)=>{
    const id = b.dataset.id; const inv = invoices.find(x=>x.id === id);
    if(!inv) return alert('Invoice not found');
    // open in create view for edit
    showView('create');
    loadInvoiceToForm(inv);
  });
  document.querySelectorAll('.btn-print').forEach(b=>b.onclick = (e)=>{
    const id = b.dataset.id; const inv = invoices.find(x=>x.id === id);
    if(!inv) return alert('Invoice not found'); openPrintableWindow(inv);
  });
  document.querySelectorAll('.btn-delete').forEach(b=>b.onclick = (e)=>{
    const id = b.dataset.id; const idx = invoices.findIndex(x=>x.id === id);
    if(idx === -1) return alert('Invoice not found');
    if(!confirm('Delete invoice? This moves it to Trash (recoverable).')) return;
    const [deleted] = invoices.splice(idx,1); trash.push(deleted);
    saveJSON(STORAGE_INVOICES, invoices); saveJSON(STORAGE_TRASH, trash);
    refreshAll();
  });
}

/* load invoice to create form */
function loadInvoiceToForm(inv){
  document.getElementById('invNo').value = inv.invNo || '';
  document.getElementById('invDate').value = inv.date || todayISO();
  document.getElementById('invCustomer').value = inv.customer || '';
  document.getElementById('invPay').value = inv.pay || 'Cash';
  productRows = (inv.products || []).map(p=> ({...p}));
  document.getElementById('taxPct').value = inv.taxPct || 0;
  renderProducts(); recalcTotals();
}

/* Printable select */
function refreshPrintableSelect(){
  const sel = document.getElementById('printSelect'); sel.innerHTML='';
  if(!invoices.length){ sel.innerHTML='<option value="">No invoices</option>'; return; }
  invoices.slice().reverse().forEach(inv=>{
    if(!inv.id) inv.id = uuid();
    if(!inv.invNo) inv.invNo = String(inv.id);
    const opt = document.createElement('option');
    opt.value = encodeURIComponent(inv.id);
    opt.textContent = `${inv.invNo} — ${inv.date || ''} — ${inv.customer || ''}`;
    sel.appendChild(opt);
  });
}
document.getElementById('openPrintable').addEventListener('click', ()=>{
  const val = document.getElementById('printSelect').value;
  if(!val) return alert('Select an invoice');
  const id = decodeURIComponent(val); const inv = invoices.find(x=>x.id === id); if(!inv) return alert('Invoice not found');
  openPrintableWindow(inv);
});

/* ---------- CSV / backups / trash ---------- */
function arrayToCsv(rows){
  if(!rows.length) return '';
  const keys = Object.keys(rows[0]);
  const esc = v => `"${String(v||'').replace(/"/g,'""')}"`;
  const header = keys.map(esc).join(',');
  const lines = rows.map(r => keys.map(k=>esc(r[k])).join(','));
  return header + '\n' + lines.join('\n');
}
function downloadCSV(rows, filename){
  const csv = arrayToCsv(rows);
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename || 'export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* Export invoices CSV (all / cash / gpay) */
document.getElementById('exportAllCsv').addEventListener('click', ()=> {
  const rows = invoices.map(inv => ({ Invoice: inv.invNo, Date: inv.date, Customer: inv.customer, Pay: inv.pay, Total: inv.total }));
  downloadCSV(rows, 'invoices_all.csv');
});
document.getElementById('exportCashCsv').addEventListener('click', ()=> {
  const rows = invoices.filter(i=>i.pay==='Cash').map(inv => ({ Invoice: inv.invNo, Date: inv.date, Customer: inv.customer, Pay: inv.pay, Total: inv.total }));
  downloadCSV(rows, 'invoices_cash.csv');
});
document.getElementById('exportGpayCsv').addEventListener('click', ()=> {
  const rows = invoices.filter(i=>i.pay==='GPay').map(inv => ({ Invoice: inv.invNo, Date: inv.date, Customer: inv.customer, Pay: inv.pay, Total: inv.total }));
  downloadCSV(rows, 'invoices_gpay.csv');
});

/* Export transactions CSV */
document.getElementById('exportTxCsv').addEventListener('click', ()=> {
  downloadCSV(transactions, 'transactions.csv');
});

/* Backups (export/import) */
document.getElementById('btnExportBackup').addEventListener('click', ()=>{
  const dump = { invoices, trash, transactions, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(dump, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = `billing-backup-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('btnImportBackup').addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = e => {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if(Array.isArray(data.invoices)) invoices = data.invoices;
        if(Array.isArray(data.trash)) trash = data.trash;
        if(Array.isArray(data.transactions)) transactions = data.transactions;
        saveJSON(STORAGE_INVOICES, invoices); saveJSON(STORAGE_TRASH, trash); saveJSON(STORAGE_TX, transactions);
        refreshAll(); alert('Import complete');
      } catch(err){ alert('Import error: ' + err.message); }
    };
    reader.readAsText(file);
  };
  input.click();
});

/* Trash view / recover */
document.getElementById('openTrash').addEventListener('click', ()=>{
  if(!trash.length){ alert('Trash empty'); return; }
  if(!confirm(`Trash has ${trash.length} items. Recover all to invoices?`)) return;
  // move all back
  trash.forEach(it => invoices.push(it));
  trash = [];
  saveJSON(STORAGE_INVOICES, invoices); saveJSON(STORAGE_TRASH, trash); refreshAll();
});

/* ---------- Utility re-renders ---------- */
function refreshAll(){ saveJSON(STORAGE_INVOICES, invoices); saveJSON(STORAGE_TRASH, trash); saveJSON(STORAGE_TX, transactions); renderDashboard(); renderInvoices(); refreshPrintableSelect(); document.getElementById('trashCount').textContent = String(trash.length || 0); }

/* ---------- startup ---------- */
refreshAll();

/* ---------- quick add ---------- */
document.getElementById('btnQuickAdd').addEventListener('click', ()=>{
  const v = Number(document.getElementById('quickTotal').value || 0);
  if(!v){ alert('Enter amount'); return; }
  const date = todayISO();
  transactions.push({ id: uuid(), date, type:'income', category:'Quick sale', amount: v, pay:'Cash' });
  saveJSON(STORAGE_TX, transactions); renderDashboard(); alert('Quick sale added');
});

/* ---------- Utilities ---------- */
/* number to words (small) */
function numberToWords(n){
  // simple english converter for integers up to 999999
  if(!Number.isFinite(n)) return '';
  const small = ['zero','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
  const tens = ['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
  function inWords(num){
    if(num<20) return small[num];
    if(num<100) return tens[Math.floor(num/10)] + (num%10? ' ' + small[num%10] : '');
    if(num<1000) return small[Math.floor(num/100)] + ' hundred' + (num%100 ? ' and ' + inWords(num%100) : '');
    if(num<1000000) return inWords(Math.floor(num/1000)) + ' thousand' + (num%1000 ? ' ' + inWords(num%1000) : '');
    return String(num);
  }
  return inWords(Math.round(n));
}

/* ---------- Repair routine (auto) ---------- */
/* When loading older invoices missing id/invNo, ensure stable keys */
(function repairStoredInvoices(){
  let changed=false;
  invoices.forEach((inv, i) => {
    if(!inv.id){ inv.id = uuid(); changed=true; }
    if(!inv.invNo){ inv.invNo = String(i+1); changed=true; }
  });
  if(changed) saveJSON(STORAGE_INVOICES, invoices);
})();

/* ---------- Search / UI tweaks ---------- */
document.getElementById('searchInv').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  const tbody = document.querySelector('#invoicesTable tbody'); tbody.innerHTML='';
  const filtered = invoices.filter(inv => String(inv.invNo).toLowerCase().includes(q) || (inv.customer||'').toLowerCase().includes(q));
  if(!filtered.length){ tbody.innerHTML = '<tr><td colspan="6" class="muted">No invoices</td></tr>'; return; }
  filtered.slice().reverse().forEach(inv=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(String(inv.invNo))}</td><td>${inv.date||''}</td><td>${escapeHtml(inv.customer||'')}</td><td>${inv.pay||''}</td><td>${money(inv.total||0)}</td>
      <td class="actions">
        <button class="btn-ghost btn-open" data-id="${inv.id}">Open</button>
        <button class="btn-ghost btn-print" data-id="${inv.id}">Print</button>
        <button class="btn-danger btn-delete" data-id="${inv.id}">Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
  // rebind actions
  document.querySelectorAll('.btn-open').forEach(b=>b.onclick = ()=>{ const id=b.dataset.id; const inv = invoices.find(x=>x.id===id); if(inv) loadInvoiceToForm(inv); showView('create');});
  document.querySelectorAll('.btn-print').forEach(b=>b.onclick = ()=>{ const id=b.dataset.id; const inv = invoices.find(x=>x.id===id); if(inv) openPrintableWindow(inv);});
  document.querySelectorAll('.btn-delete').forEach(b=>b.onclick = ()=>{ const id=b.dataset.id; const idx = invoices.findIndex(x=>x.id===id); if(idx>-1){ if(confirm('Delete invoice?')){ trash.push(invoices[idx]); invoices.splice(idx,1); saveJSON(STORAGE_INVOICES, invoices); saveJSON(STORAGE_TRASH, trash); refreshAll();}}});
});

/* ---------- Misc: Opening balance ---------- */
document.getElementById('setOpening').addEventListener('click', ()=>{
  const v = Number(document.getElementById('openingInput').value || 0);
  localStorage.setItem('billingapp_opening_today', JSON.stringify({value:v, at: new Date().toISOString()}));
  alert('Opening balance set: ' + money(v));
});
document.getElementById('clearOpening').addEventListener('click', ()=>{ localStorage.removeItem('billingapp_opening_today'); alert('Opening cleared'); });

/* ---------- debug/open last invoice if any ---------- */
if(invoices.length) {
  // keep list updated
  document.getElementById('trashCount').textContent = String(trash.length || 0);
}
</script>
</body>
</html>
