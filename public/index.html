<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Billing — JBS KNIT WEAR</title>

  <!-- Simple reset + variables -->
  <style>
    :root{
      --bg:#f3f6f8; --card:#ffffff; --muted:#7b8794; --accent:#1677ff;
      --radius:12px; --sidebar-w:260px; --container-max:1100px;
      --shadow: 0 10px 30px rgba(23,33,49,0.06);
      --phone-break: 760px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#111;background:var(--bg);}
    a{color:inherit}
    img{max-width:100%}
    button{cursor:pointer}

    /* Layout */
    .app{display:flex;min-height:100vh}
    .sidebar{
      width:var(--sidebar-w); background:linear-gradient(#fff,#fff); box-shadow: none;
      padding:28px 22px; border-right:1px solid rgba(20,30,40,.04); box-sizing:border-box;
      position:fixed; left:0; top:0; bottom:0; overflow:auto;
    }
    .brand{font-weight:800;font-size:20px;margin-bottom:18px}
    .brand small{font-weight:500;color:var(--muted);display:block;font-size:13px}
    .nav{margin-top:12px}
    .nav a{display:block;padding:14px 12px;border-radius:10px;color:#223; text-decoration:none;margin-bottom:6px;}
    .nav a small{display:block;color:var(--muted);font-weight:500;margin-top:4px;font-size:12px}
    .nav a.active{background:linear-gradient(90deg,#f3fbff,#fff);border-left:4px solid var(--accent);padding-left:10px}

    /* Main content wrapper */
    .main{
      margin-left:var(--sidebar-w); flex:1; padding:28px; box-sizing:border-box;
    }
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .top-right{display:flex;gap:10px;align-items:center}
    .opening{display:flex;align-items:center;gap:8px}

    /* container card */
    .card{background:var(--card);border-radius:14px;padding:22px;box-shadow:var(--shadow);}

    /* Dashboard grid */
    .grid{display:grid;grid-template-columns:1fr 360px;gap:24px;align-items:start}
    .stat-row{display:flex;gap:18px;flex-wrap:wrap}
    .stat{background:#fff;border-radius:10px;padding:18px;min-width:180px;box-shadow:var(--shadow)}
    .h1{font-size:28px;margin:0 0 8px;font-weight:800}
    .h2{font-size:16px;margin:0;color:var(--muted)}

    /* Forms & invoice layout */
    .form-row{display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .input{padding:12px;border-radius:10px;border:1px solid #e9eef2;background:#fff;min-width:0}
    .btn{background:var(--accent);color:#fff;padding:10px 12px;border-radius:8px;border:none}
    .btn.alt{background:#fff;border:1px solid #e7edf3;color:#222}
    .btn.warn{background:#ff7b5a}

    /* product list */
    .products{margin-top:8px}
    .prod-row{display:grid;grid-template-columns:48px 1fr 80px 90px 120px 32px;gap:10px;align-items:center;padding:14px;border-radius:10px;background:linear-gradient(#fff,#fff);border:1px solid #eef3f6;margin-bottom:10px}
    .prod-row .num{font-weight:700;color:#6f7882}
    .prod-row input[type="text"], .prod-row input[type="number"]{padding:8px;border-radius:8px;border:1px solid #eef3f6;background:#fafcff;min-width:0}
    .right-summary{display:flex;flex-direction:column;align-items:flex-end;gap:6px}

    /* Table for transactions */
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;text-align:left;border-bottom:1px solid #f0f4f7}
    th{background:transparent;color:#333}

    /* small helpers */
    .muted{color:var(--muted)}
    .small{font-size:13px}
    .float-right{text-align:right}

    /* Trash / invoices list */
    .list-row{display:flex;justify-content:space-between;padding:12px 14px;border-radius:10px;border:1px solid #eef3f6;margin-bottom:8px;align-items:center;background:#fff}

    /* Mobile responsiveness */
    @media (max-width:760px){
      .sidebar{position:relative;width:100%;height:auto;display:flex;gap:12px;align-items:center;overflow:hidden;padding:12px}
      .main{margin-left:0;padding:12px}
      .grid{grid-template-columns:1fr}
      .stat-row{justify-content:space-between}
      .prod-row{grid-template-columns:36px 1fr 70px 70px 80px 28px}
      .right-summary{align-items:flex-start}
    }

    /* Print invoice (portrait 14cm x 20cm) */
    @media print {
      @page { size: 14cm 20cm portrait; margin: 8mm; }
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">JBS KNIT WEAR — <small>Billing</small></div>
      <nav class="nav" id="nav">
        <a href="#" data-view="dashboard" class="active">Dashboard <small>Quick totals & recent</small></a>
        <a href="#" data-view="transactions">Transactions <small>Income & expense add</small></a>
        <a href="#" data-view="create">Create Invoice <small>Add products & save</small></a>
        <a href="#" data-view="invoices">Invoices <small>Saved invoices list</small></a>
        <a href="#" data-view="printable">Printable template <small>View / print invoice</small></a>
        <hr style="border:none;margin:18px 0;border-top:1px dashed #eee">
        <div class="small muted">Tip: Use Export backup before major changes</div>
        <div style="margin-top:12px">
          <button class="btn alt" id="exportBackupBtn">Export backup</button>
          <label style="display:inline-block;margin-left:8px">
            <input type="file" id="importFile" accept=".json" style="display:none">
            <button class="btn alt" id="importBtn">Import</button>
          </label>
        </div>
        <div style="margin-top:8px">
          <button class="btn alt" id="openTrash">Trash (<span id="trashCount">0</span>)</button>
        </div>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="topbar">
        <div style="display:flex;align-items:center;gap:12px">
          <button class="btn alt" id="menuToggle">≡</button>
          <div style="font-weight:700;font-size:18px">Billing <small class="muted" style="font-weight:500;margin-left:8px">— manage invoices & quick sales</small></div>
        </div>

        <div class="top-right">
          <div class="opening small muted">Opening balance (today)</div>
          <input id="openingInput" class="input input-small" style="padding:10px;border-radius:10px;border:1px solid #e9eef2;width:120px" placeholder="0.00" />
          <button class="btn alt" id="setOpening">Set</button>
          <button class="btn alt" id="clearOpening">Clear</button>
        </div>
      </div>

      <!-- Views container -->
      <div id="viewRoot">
        <!-- Dashboard view -->
        <section id="view-dashboard" class="card" style="display:block">
          <div class="h1">Billing Dashboard</div>
          <div class="muted small">Quick overview of today's totals and recent activity</div>
          <div style="margin-top:18px" class="grid">
            <div>
              <div class="card" style="margin-bottom:18px">
                <div class="stat-row">
                  <div class="stat">
                    <div class="small muted">Total Income</div>
                    <div style="font-size:20px;font-weight:800">₹<span id="totalIncome">0.00</span></div>
                  </div>
                  <div class="stat">
                    <div class="small muted">Total Expense</div>
                    <div style="font-size:20px;font-weight:800">₹<span id="totalExpense">0.00</span></div>
                  </div>
                  <div class="stat">
                    <div class="small muted">Profit</div>
                    <div style="font-size:20px;font-weight:800">₹<span id="profit">0.00</span></div>
                  </div>
                </div>

                <div style="margin-top:18px">
                  <div class="h2">Recent transactions</div>
                  <div style="margin-top:12px">
                    <div class="card" style="padding:0">
                      <table>
                        <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Amount</th></tr></thead>
                        <tbody id="recentTx"><tr><td colspan="4" class="muted small">No recent transactions</td></tr></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <aside>
              <div class="card" style="margin-bottom:14px">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="h2">Recent transactions</div>
                  <button class="btn" id="exportCsvBtn" title="Download CSV">Export CSV</button>
                </div>
                <div style="margin-top:10px">
                  <table>
                    <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Amount</th></tr></thead>
                    <tbody id="rightRecentTx"><tr><td colspan="4" class="muted small">No recent transactions</td></tr></tbody>
                  </table>
                </div>
              </div>

              <div class="card">
                <div class="h2">Trash</div>
                <div class="muted small">Recover deleted invoices from trash</div>
                <div id="trashList" style="margin-top:8px"></div>
              </div>
            </aside>
          </div>
        </section>

        <!-- Transactions view -->
        <section id="view-transactions" class="card" style="display:none">
          <div class="h1">Transactions</div>
          <div class="muted small">Quick add income & expense</div>

          <div style="margin-top:12px">
            <div class="form-row">
              <select id="txType" class="input">
                <option value="income">Income</option>
                <option value="expense">Expense</option>
              </select>
              <input id="txCategory" class="input" placeholder="Category (sales / purchases...)" />
              <input id="txAmount" class="input" placeholder="Amount" type="number" />
              <input id="txDate" class="input" placeholder="dd/mm/yyyy" />
              <select id="txPay" class="input"><option>Cash</option><option>GPay</option></select>
              <button class="btn" id="txAdd">Add</button>
            </div>

            <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
              <input id="filterFrom" type="date" class="input" />
              <input id="filterTo" type="date" class="input" />
              <select id="filterType" class="input"><option value="all">All</option><option value="income">Income</option><option value="expense">Expense</option></select>
              <button class="btn alt" id="filterBtn">Filter</button>
              <button class="btn alt" id="clearFilter">Clear</button>
              <button class="btn" id="downloadTxCsv" style="margin-left:auto">Download CSV</button>
            </div>
          </div>

          <div style="margin-top:14px">
            <table>
              <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th>Amount</th><th></th></tr></thead>
              <tbody id="txTable">
                <tr><td colspan="6" class="muted">No transactions added</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Create invoice -->
        <section id="view-create" class="card" style="display:none">
          <div class="h1">Create Invoice</div>
          <div class="form-row" style="margin-top:12px">
            <input id="invoiceNo" class="input" placeholder="Invoice no (auto)" />
            <input id="invoiceDate" class="input" type="date" />
            <input id="customerName" class="input" placeholder="Customer name" style="flex:1" />
          </div>

          <div class="form-row">
            <label class="muted small" style="margin-right:6px">Payment Method</label>
            <select id="paymentMethod" class="input" style="width:160px">
              <option>Cash</option><option>GPay</option>
            </select>

            <div style="margin-left:auto;display:flex;gap:8px">
              <button class="btn" id="addProductBtn">+ Add</button>
              <button class="btn alt" id="clearProducts">Clear</button>
              <button class="btn alt" id="recalcTotals">Recalc</button>
            </div>
          </div>

          <div class="products" id="productsContainer">
            <!-- product rows generated by JS -->
          </div>

          <div style="display:flex;justify-content:flex-end;align-items:center;margin-top:10px;gap:18px">
            <div class="right-summary">
              <div class="muted small">Subtotal:</div>
              <div style="font-weight:800">₹<span id="subtotal">0.00</span></div>
            </div>
            <div class="right-summary">
              <div class="muted small">Tax %:</div>
              <input id="taxPct" class="input" type="number" value="0" style="width:80px" />
              <div style="font-weight:800">₹<span id="taxAmount">0.00</span></div>
            </div>
            <div class="right-summary">
              <div class="muted small">Total</div>
              <div style="font-weight:900;font-size:20px">₹<span id="invoiceTotal">0.00</span></div>
            </div>
          </div>

          <div style="margin-top:18px;display:flex;gap:12px">
            <button class="btn" id="saveInvoice">Save</button>
            <button class="btn alt" id="printInvoice">Print</button>
            <button class="btn warn" id="resetInvoice">Reset</button>
          </div>
        </section>

        <!-- Invoices list -->
        <section id="view-invoices" class="card" style="display:none">
          <div class="h1">Invoices</div>
          <div class="muted small">Saved invoices</div>
          <div style="margin-top:12px" id="invoiceList"></div>
        </section>

        <!-- Printable template -->
        <section id="view-printable" class="card" style="display:none">
          <div class="h1">Printable template</div>
          <div class="muted small">Click a saved invoice to view printable version</div>
          <div style="margin-top:14px" id="printPreview"></div>
        </section>
      </div>
    </main>
  </div>

  <!-- Hidden print area used by print function -->
  <div id="printArea" style="display:none"></div>

  <!-- script: storage, UI wiring, logic -->
  <script>
  /***********************
    Persistent app state & helpers (migration + soft-delete + backup)
  ************************/
  const APP_STORAGE_KEY = 'billing_app_v1';
  const DEFAULT_STATE = {
    invoices: [],
    transactions: [],
    deletedInvoices: [],
    meta: { createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() }
  };

  function migrateOldKeys(){
    try{
      const oldInvoiceKey = 'billing_invoices_v1';
      const oldTxKey = 'billing_transactions_v1';
      const existing = JSON.parse(localStorage.getItem(APP_STORAGE_KEY) || 'null');
      if(existing) return existing;
      const newState = JSON.parse(JSON.stringify(DEFAULT_STATE));
      const oldInvRaw = localStorage.getItem(oldInvoiceKey);
      if(oldInvRaw){
        try{ const p = JSON.parse(oldInvRaw); if(Array.isArray(p)) newState.invoices = p }catch(e){}
      }
      const oldTxRaw = localStorage.getItem(oldTxKey);
      if(oldTxRaw){
        try{ const p = JSON.parse(oldTxRaw); if(Array.isArray(p)) newState.transactions = p }catch(e){}
      }
      localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(newState));
      return newState;
    }catch(e){ console.error('migrate err',e); return JSON.parse(JSON.stringify(DEFAULT_STATE)); }
  }

  let STATE;
  try{
    const raw = localStorage.getItem(APP_STORAGE_KEY);
    if(raw){ STATE = JSON.parse(raw);
      if(!STATE.invoices) STATE.invoices=[]; if(!STATE.transactions) STATE.transactions=[]; if(!STATE.deletedInvoices) STATE.deletedInvoices=[]; if(!STATE.meta) STATE.meta={updatedAt:new Date().toISOString()};
    } else {
      STATE = migrateOldKeys() || JSON.parse(JSON.stringify(DEFAULT_STATE));
    }
  } catch(err){
    console.error('Failed to read app storage',err);
    STATE = JSON.parse(JSON.stringify(DEFAULT_STATE));
    localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(STATE));
  }

  function saveState(){ try{ STATE.meta.updatedAt = new Date().toISOString(); localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(STATE)); }catch(e){console.error('persist fail',e);} }

  function id(){ return 'id-'+Math.random().toString(36).slice(2,9); }

  /* invoices management */
  function addInvoice(inv){
    if(!inv.id) inv.id = id();
    STATE.invoices.push(inv);
    saveState();
    return inv.id;
  }
  function updateInvoice(updated){
    const idx = STATE.invoices.findIndex(i=>i.id===updated.id);
    if(idx>-1){ STATE.invoices[idx] = updated; saveState(); return true; }
    return false;
  }
  function softDeleteInvoice(invoiceId,reason='deleted'){
    const idx = STATE.invoices.findIndex(i=>i.id===invoiceId);
    if(idx===-1) return false;
    const rec = STATE.invoices.splice(idx,1)[0];
    rec.deletedAt = new Date().toISOString(); rec.deletedReason = reason;
    STATE.deletedInvoices.push(rec);
    saveState(); return true;
  }
  function restoreInvoiceFromTrash(trashId){
    const idx = STATE.deletedInvoices.findIndex(d=>d.id===trashId);
    if(idx===-1) return false;
    const rec = STATE.deletedInvoices.splice(idx,1)[0];
    if(STATE.invoices.some(i=>i.id===rec.id)) rec.id = 'restored-'+id();
    STATE.invoices.push(rec);
    saveState(); return true;
  }
  function permanentPurgeDeleted(){ STATE.deletedInvoices=[]; saveState(); }
  function exportBackup(){
    try{
      const payload = { exportedAt:new Date().toISOString(), state:STATE };
      const blob = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = 'billing_backup_'+(new Date().toISOString().slice(0,19)).replace(/[:T]/g,'-')+'.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }catch(e){ alert('Export failed: '+e) }
  }
  function importBackupFile(file){
    return new Promise((resolve,reject)=>{
      if(!file) return reject('No file');
      const r = new FileReader();
      r.onload = (ev)=>{
        try{
          const payload = JSON.parse(ev.target.result);
          if(!payload || !payload.state) return reject('Invalid file');
          const incoming = payload.state;
          (incoming.invoices||[]).forEach(inv=>{
            if(!STATE.invoices.find(i=>i.id===inv.id) && !STATE.deletedInvoices.find(d=>d.id===inv.id)) STATE.invoices.push(inv);
            else { inv.id = inv.id + '-import-' + Date.now(); STATE.invoices.push(inv); }
          });
          (incoming.transactions||[]).forEach(tx=>{
            if(!STATE.transactions.find(t=>t.id===tx.id)) STATE.transactions.push(tx); else { tx.id = tx.id + '-import-' + Date.now(); STATE.transactions.push(tx); }
          });
          (incoming.deletedInvoices||[]).forEach(d=>{
            if(!STATE.deletedInvoices.find(dd=>dd.id===d.id)) STATE.deletedInvoices.push(d); else { d.id = d.id + '-import-' + Date.now(); STATE.deletedInvoices.push(d); }
          });
          saveState();
          resolve({ok:true});
        }catch(err){ reject('Parse error: '+err) }
      };
      r.onerror = ()=>reject('Read error');
      r.readAsText(file);
    });
  }

  // transactions
  function addTransaction(tx){ tx.id = tx.id || id(); STATE.transactions.push(tx); saveState(); }

  // expose helpers to console
  window.APP = { STATE, saveState, addInvoice, updateInvoice, softDeleteInvoice, restoreInvoiceFromTrash, permanentPurgeDeleted, exportBackup, importBackupFile, addTransaction };

  /***********************
    UI wiring & rendering
  ************************/
  const views = ['dashboard','transactions','create','invoices','printable'];
  function showView(name){
    views.forEach(v => document.getElementById('view-'+v).style.display = (v===name?'block':'none'));
    // mark active nav
    Array.from(document.querySelectorAll('#nav a')).forEach(a=>a.classList.remove('active'));
    const navItem = document.querySelector('#nav a[data-view="'+name+'"]');
    if(navItem) navItem.classList.add('active');
    // scroll small screens to top
    window.scrollTo({top:0,behavior:'smooth'});
  }
  document.querySelectorAll('#nav a').forEach(a=>{
    a.addEventListener('click', e=>{
      e.preventDefault();
      const v = a.getAttribute('data-view'); if(v) showView(v);
    });
  });
  document.getElementById('menuToggle').addEventListener('click',()=>{
    const sb = document.getElementById('sidebar');
    if(window.innerWidth < 760){ sb.style.display = sb.style.display==='none'?'block':'none'; }
  });

  // open import file picker
  document.getElementById('importBtn').addEventListener('click', ()=>document.getElementById('importFile').click());
  document.getElementById('exportBackupBtn').addEventListener('click', ()=>{ exportBackup(); });

  document.getElementById('importFile').addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    importBackupFile(f).then(()=>{ alert('Import success'); renderAll(); }).catch(err=> alert('Import failed: '+err));
  });

  // Trash UI
  function renderTrash(){
    const el = document.getElementById('trashList'), tc = document.getElementById('trashCount');
    el.innerHTML = '';
    const list = STATE.deletedInvoices.slice().reverse();
    tc.textContent = list.length;
    if(list.length===0){ el.innerHTML = '<div class="muted small">Trash is empty</div>'; return; }
    list.forEach(item=>{
      const div = document.createElement('div'); div.className='list-row';
      div.innerHTML = `
        <div>
          <div style="font-weight:700">${item.customer||'—'}</div>
          <div class="muted small">${new Date(item.date||item.createdAt||Date()).toLocaleString()}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted small">₹${(item.total||0).toFixed(2)}</div>
          <button class="btn alt" data-id="${item.id}" data-action="restore">Restore</button>
          <button class="btn warn" data-id="${item.id}" data-action="purge">Delete</button>
        </div>
      `;
      el.appendChild(div);
    });
    el.querySelectorAll('button[data-action="restore"]').forEach(b => {
      b.addEventListener('click', e=>{
        const id = b.getAttribute('data-id'); if(restoreInvoiceFromTrash(id)){ renderAll(); alert('Restored'); } else alert('Restore failed');
      });
    });
    el.querySelectorAll('button[data-action="purge"]').forEach(b=>{
      b.addEventListener('click', e=>{
        const id = b.getAttribute('data-id');
        if(confirm('Permanently delete this invoice from trash?')) {
          STATE.deletedInvoices = STATE.deletedInvoices.filter(d=>d.id!==id); saveState(); renderAll();
        }
      });
    });
  }
  document.getElementById('openTrash').addEventListener('click', ()=>{ showView('dashboard'); renderTrash(); });

  /***********************
   Dashboard render
  ************************/
  function renderDashboard(){
    const income = STATE.transactions.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amount||0),0);
    const expense = STATE.transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amount||0),0);
    document.getElementById('totalIncome').textContent = income.toFixed(2);
    document.getElementById('totalExpense').textContent = expense.toFixed(2);
    document.getElementById('profit').textContent = (income - expense).toFixed(2);

    // recent tx (right)
    const recent = STATE.transactions.slice(-5).reverse();
    const rightT = document.getElementById('rightRecentTx');
    rightT.innerHTML = '';
    if(recent.length===0) rightT.innerHTML = '<tr><td colspan="4" class="muted small">No recent transactions</td></tr>';
    else recent.forEach(tx => {
      const tr = document.createElement('tr');
      const d = new Date(tx.date||tx.createdAt||Date()).toLocaleDateString();
      tr.innerHTML = `<td>${d}</td><td>${tx.type}</td><td>${tx.category||''}</td><td>₹${Number(tx.amount||0).toFixed(2)}</td>`;
      rightT.appendChild(tr);
    });

    // main recent table
    const recT = document.getElementById('recentTx');
    recT.innerHTML = '';
    const recAll = STATE.transactions.slice(-6).reverse();
    if(recAll.length===0) recT.innerHTML = '<tr><td colspan="4" class="muted small">No recent transactions</td></tr>';
    else recAll.forEach(tx=>{
      const tr = document.createElement('tr');
      const d = new Date(tx.date||tx.createdAt||Date()).toLocaleDateString();
      tr.innerHTML = `<td>${d}</td><td>${tx.type}</td><td>${tx.category||''}</td><td>₹${Number(tx.amount||0).toFixed(2)}</td>`;
      recT.appendChild(tr);
    });

    renderTrash();
  }

  /***********************
    Transactions UI
  ************************/
  function renderTransactions(filterOpts){
    const tbody = document.getElementById('txTable');
    tbody.innerHTML = '';
    let list = STATE.transactions.slice().reverse();
    if(filterOpts){
      if(filterOpts.type && filterOpts.type!=='all') list = list.filter(t=>t.type===filterOpts.type);
      if(filterOpts.from) list = list.filter(t=> new Date(t.date||t.createdAt||0) >= new Date(filterOpts.from));
      if(filterOpts.to) list = list.filter(t=> new Date(t.date||t.createdAt||0) <= new Date(filterOpts.to));
    }
    if(list.length===0) { tbody.innerHTML = '<tr><td colspan="6" class="muted">No transactions added</td></tr>'; return; }
    list.forEach(tx=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(tx.date||tx.createdAt).toLocaleDateString()}</td><td>${tx.type}</td><td>${tx.category||''}</td><td>${tx.pay||''}</td><td>₹${Number(tx.amount||0).toFixed(2)}</td>
        <td style="text-align:right"><button class="btn alt" data-id="${tx.id}" data-action="delTx">Delete</button></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button[data-action="delTx"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.getAttribute('data-id');
        if(confirm('Delete transaction?')){ STATE.transactions = STATE.transactions.filter(t=>t.id!==id); saveState(); renderTransactions(); renderDashboard(); }
      });
    });
  }

  document.getElementById('txAdd').addEventListener('click', ()=>{
    const type = document.getElementById('txType').value;
    const cat = document.getElementById('txCategory').value.trim()|| (type==='income'?'sales':'expense');
    const amount = Number(document.getElementById('txAmount').value||0);
    if(!amount){ alert('Enter amount'); return; }
    const date = document.getElementById('txDate').value || new Date().toISOString();
    const pay = document.getElementById('txPay').value || 'Cash';
    addTransaction({ id:id(), type, category:cat, amount, date, pay, createdAt:new Date().toISOString() });
    document.getElementById('txAmount').value=''; document.getElementById('txCategory').value='';
    renderTransactions(); renderDashboard();
  });

  document.getElementById('filterBtn').addEventListener('click', ()=>{
    const from = document.getElementById('filterFrom').value || null;
    const to = document.getElementById('filterTo').value || null;
    const type = document.getElementById('filterType').value || 'all';
    renderTransactions({from,to,type});
  });
  document.getElementById('clearFilter').addEventListener('click', ()=>{
    document.getElementById('filterFrom').value=''; document.getElementById('filterTo').value=''; document.getElementById('filterType').value='all';
    renderTransactions();
  });

  // CSV export for transactions (all or filtered)
  function downloadCSV(rows, filename='transactions.csv'){
    if(!rows || rows.length===0){ alert('No rows'); return; }
    const keys = Object.keys(rows[0]);
    const csv = [keys.join(',')].concat(rows.map(r=>keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
    const blob = new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob), a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  document.getElementById('downloadTxCsv').addEventListener('click', ()=>{
    if(STATE.transactions.length===0){ alert('No transactions'); return; }
    downloadCSV(STATE.transactions.map(t=>({date:t.date||t.createdAt,type:t.type,category:t.category,pay:t.pay,amount:t.amount})), 'transactions.csv');
  });

  // Dashboard right CSV (quick export)
  document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
    if(STATE.transactions.length===0){ alert('No transactions'); return; }
    downloadCSV(STATE.transactions.map(t=>({date:t.date||t.createdAt,type:t.type,category:t.category,pay:t.pay,amount:t.amount})), 'transactions.csv');
  });

  /***********************
    Invoice / Create UI
  ************************/
  const productsContainer = document.getElementById('productsContainer');
  function makeProductRow(index, data){
    const row = document.createElement('div'); row.className = 'prod-row'; row.dataset.index = index;
    const productName = data?.name||'';
    const qty = Number(data?.qty||0);
    const rate = Number(data?.rate||0);
    const disc = Number(data?.disc||0);
    const amount = Math.max(0,(qty * rate) * (1 - (disc/100)));
    row.innerHTML = `
      <div class="num">${index}</div>
      <div><input type="text" class="input prod-name" placeholder="Product description" value="${productName}"></div>
      <div><input type="number" min="0" class="input prod-qty" value="${qty}"></div>
      <div><input type="number" min="0" class="input prod-rate" value="${rate}"></div>
      <div><input type="number" min="0" class="input prod-disc" value="${disc}"></div>
      <div style="text-align:right">₹<span class="prod-amount">${amount.toFixed(2)}</span> <button style="margin-left:8px" class="btn alt small remove-btn">x</button></div>
    `;
    // events
    row.querySelectorAll('.prod-qty, .prod-rate, .prod-disc, .prod-name').forEach(el=>{
      el.addEventListener('input', ()=>{ recalcRow(row); recalcTotals(); });
    });
    row.querySelector('.remove-btn').addEventListener('click', ()=>{
      row.remove(); renumberProducts(); recalcTotals();
    });
    return row;
  }
  function recalcRow(row){
    const q = Number(row.querySelector('.prod-qty').value||0);
    const r = Number(row.querySelector('.prod-rate').value||0);
    const d = Number(row.querySelector('.prod-disc').value||0);
    const a = Math.max(0, q * r * (1 - d/100));
    row.querySelector('.prod-amount').textContent = a.toFixed(2);
  }
  function renumberProducts(){
    Array.from(productsContainer.querySelectorAll('.prod-row')).forEach((r,i)=> r.querySelector('.num').textContent = (i+1));
  }
  function recalcTotals(){
    const rows = Array.from(productsContainer.querySelectorAll('.prod-row'));
    const subtotal = rows.reduce((s,r)=> s + Number(r.querySelector('.prod-amount').textContent||0), 0);
    const taxPct = Number(document.getElementById('taxPct').value||0);
    const tax = subtotal * (taxPct/100);
    const total = subtotal + tax;
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('taxAmount').textContent = tax.toFixed(2);
    document.getElementById('invoiceTotal').textContent = total.toFixed(2);
  }
  function addProduct(data){
    const idx = productsContainer.querySelectorAll('.prod-row').length + 1;
    const r = makeProductRow(idx, data);
    productsContainer.appendChild(r);
    recalcTotals();
  }
  function loadCreateDefaults(){
    // ensure at least 4 rows (like original)
    if(productsContainer.children.length===0){
      for(let i=0;i<4;i++) addProduct({});
    }
  }
  document.getElementById('addProductBtn').addEventListener('click', ()=> addProduct({}));
  document.getElementById('clearProducts').addEventListener('click', ()=>{
    if(confirm('Clear product rows?')){ productsContainer.innerHTML=''; loadCreateDefaults(); recalcTotals(); }
  });
  document.getElementById('recalcTotals').addEventListener('click', recalcTotals);
  document.getElementById('taxPct').addEventListener('input', recalcTotals);

  // Save invoice
  document.getElementById('saveInvoice').addEventListener('click', ()=>{
    const invNo = document.getElementById('invoiceNo').value.trim() || ('INV-'+Date.now());
    const date = document.getElementById('invoiceDate').value || new Date().toISOString();
    const customer = document.getElementById('customerName').value.trim();
    const paymentMethod = document.getElementById('paymentMethod').value;
    const rows = Array.from(productsContainer.querySelectorAll('.prod-row')).map((r,i)=>({
      sn: i+1,
      name: r.querySelector('.prod-name').value || '',
      qty: Number(r.querySelector('.prod-qty').value||0),
      rate: Number(r.querySelector('.prod-rate').value||0),
      disc: Number(r.querySelector('.prod-disc').value||0),
      amount: Number(r.querySelector('.prod-amount').textContent||0)
    }));
    const subtotal = Number(document.getElementById('subtotal').textContent||0);
    const tax = Number(document.getElementById('taxAmount').textContent||0);
    const total = Number(document.getElementById('invoiceTotal').textContent||0);
    const invoice = { id: id(), invNo, date, customer, paymentMethod, rows, subtotal, tax, total, createdAt:new Date().toISOString() };
    addInvoice(invoice);
    // also create transaction for accounting (sales as income)
    addTransaction({ id: id(), type:'income', category:'sales', amount: total, date, pay: paymentMethod, createdAt:new Date().toISOString() });
    alert('Saved invoice');
    renderAll(); showView('invoices');
  });

  // Print invoice: will open printable window showing template (portrait)
  document.getElementById('printInvoice').addEventListener('click', ()=>{
    // build printable content for current values
    const invNo = document.getElementById('invoiceNo').value.trim() || ('INV-'+Date.now());
    const date = document.getElementById('invoiceDate').value || new Date().toISOString();
    const customer = document.getElementById('customerName').value.trim();
    const paymentMethod = document.getElementById('paymentMethod').value;
    const rows = Array.from(productsContainer.querySelectorAll('.prod-row')).map((r,i)=>({
      sn: i+1,
      name: r.querySelector('.prod-name').value || '',
      qty: Number(r.querySelector('.prod-qty').value||0),
      rate: Number(r.querySelector('.prod-rate').value||0),
      amount: Number(r.querySelector('.prod-amount').textContent||0)
    }));
    const html = buildPrintableHTML({invNo,date,customer,paymentMethod,rows,subtotal:document.getElementById('subtotal').textContent,tax:document.getElementById('taxAmount').textContent,total:document.getElementById('invoiceTotal').textContent});
    const w = window.open('','_blank');
    w.document.write(html); w.document.close();
    // auto print
    setTimeout(()=> w.print(), 500);
  });

  function buildPrintableHTML(inv){
    // portrait 14cm x 20cm CSS included inline
    const rowsHtml = (inv.rows||[]).map(r=>`<tr><td style="width:10%">${r.sn}</td><td style="width:50%">${escapeHtml(r.name)}</td><td style="width:10%;text-align:center">${r.qty}</td><td style="width:15%;text-align:right">${Number(r.rate||0).toFixed(2)}</td><td style="text-align:right;width:15%">${Number(r.amount||0).toFixed(2)}</td></tr>`).join('');
    const html = `
      <!doctype html><html><head><meta charset="utf-8"><title>Invoice ${escapeHtml(inv.invNo)}</title>
      <style>
        @page { size:14cm 20cm portrait; margin:10mm; }
        body{font-family:Arial,Helvetica,sans-serif;color:#111;padding:0;margin:0}
        .wrap{padding:8mm}
        h1{font-size:22px;margin:0 0 6px}
        .meta{margin-top:8px;font-size:13px}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        td,th{padding:6px;border:1px solid #ddd;font-size:12px}
        .right{text-align:right}
      </style></head>
      <body><div class="wrap">
      <h1>JBS KNIT WEAR</h1>
      <div class="meta">Date: ${escapeHtml((new Date(inv.date)).toLocaleDateString())}<br>Invoice ID: ${escapeHtml(inv.invNo)}<br>Customer: ${escapeHtml(inv.customer||'')}</div>
      <table>
        <thead><tr><th>#</th><th>Product</th><th>Qty</th><th style="text-align:right">Rate</th><th style="text-align:right">Amount</th></tr></thead>
        <tbody>${rowsHtml}</tbody>
      </table>
      <div style="margin-top:10px;text-align:right;font-weight:800">Total: ₹${escapeHtml(Number(inv.total||0).toFixed(2))}</div>
      <div style="margin-top:20px">Payment: ${escapeHtml(inv.paymentMethod||'Cash')}</div>
      </div></body></html>`;
    return html;
  }

  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  document.getElementById('resetInvoice').addEventListener('click', ()=>{
    if(confirm('Reset invoice form?')){ document.getElementById('invoiceNo').value=''; document.getElementById('invoiceDate').value=''; document.getElementById('customerName').value=''; productsContainer.innerHTML=''; loadCreateDefaults(); recalcTotals(); }
  });

  /***********************
    Invoices list & printable
  ************************/
  function renderInvoicesList(){
    const el = document.getElementById('invoiceList'); el.innerHTML = '';
    if(STATE.invoices.length===0) { el.innerHTML = '<div class="muted">No invoices saved</div>'; return; }
    STATE.invoices.slice().reverse().forEach(inv=>{
      const div = document.createElement('div'); div.className='list-row';
      div.innerHTML = `<div>
        <div style="font-weight:700">${inv.invNo} — ${inv.customer||'—'}</div>
        <div class="muted small">${new Date(inv.date||inv.createdAt).toLocaleString()}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="muted small">₹${Number(inv.total||0).toFixed(2)}</div>
        <button class="btn alt" data-id="${inv.id}" data-action="view">View</button>
        <button class="btn" data-id="${inv.id}" data-action="print">Print</button>
        <button class="btn warn" data-id="${inv.id}" data-action="del">Delete</button>
      </div>`;
      el.appendChild(div);
    });
    el.querySelectorAll('button[data-action="view"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id=b.dataset.id; const inv = STATE.invoices.find(i=>i.id===id);
        if(!inv) return alert('Not found');
        const html = buildPrintableHTML({invNo:inv.invNo,date:inv.date,customer:inv.customer,paymentMethod:inv.paymentMethod,rows:inv.rows,subtotal:inv.subtotal,tax:inv.tax,total:inv.total});
        document.getElementById('printPreview').innerHTML = `<div class="card print-area">${html}</div>`;
        showView('printable');
      });
    });
    el.querySelectorAll('button[data-action="print"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id=b.dataset.id; const inv = STATE.invoices.find(i=>i.id===id);
        if(!inv) return alert('Not found');
        const html = buildPrintableHTML({invNo:inv.invNo,date:inv.date,customer:inv.customer,paymentMethod:inv.paymentMethod,rows:inv.rows,subtotal:inv.subtotal,tax:inv.tax,total:inv.total});
        const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),500);
      });
    });
    el.querySelectorAll('button[data-action="del"]').forEach(b=>{
      b.addEventListener('click', ()=>{
        if(!confirm('Move invoice to trash?')) return;
        const id = b.dataset.id; softDeleteInvoice(id); renderAll();
      });
    });
  }

  /***********************
    Helpers on load render & opening balance
  ************************/
  document.getElementById('setOpening').addEventListener('click', ()=>{
    const v = Number(document.getElementById('openingInput').value||0);
    localStorage.setItem('opening_today', String(v));
    alert('Opening balance set: ₹'+v.toFixed(2));
  });
  document.getElementById('clearOpening').addEventListener('click', ()=>{ localStorage.removeItem('opening_today'); alert('Cleared'); });

  // restore old data if present (migration done earlier), update UI
  function renderAll(){
    renderDashboard(); renderTransactions(); renderInvoicesList(); loadCreateDefaults(); recalcTotals();
    // update trash count
    document.getElementById('trashCount').textContent = STATE.deletedInvoices.length;
  }

  // on load
  window.addEventListener('load', ()=>{
    renderAll();
  });

  /***********************
    Utility: CSV per payment method
  ************************/
  function exportByPaymentMethod(){
    const cash = STATE.transactions.filter(t=>t.pay==='Cash');
    const gpay = STATE.transactions.filter(t=>t.pay==='GPay');
    if(cash.length===0 && gpay.length===0) return alert('No transactions');
    if(cash.length) downloadCSV(cash.map(t=>({date:t.date||t.createdAt,type:t.type,category:t.category,pay:t.pay,amount:t.amount})), 'cash_sales.csv');
    if(gpay.length) downloadCSV(gpay.map(t=>({date:t.date||t.createdAt,type:t.type,category:t.category,pay:t.pay,amount:t.amount})), 'gpay_sales.csv');
  }
  // plugin button that user asked:
  // create quick export button or tie to export CSV in header if needed
  // but we expose a convenience function to console: window.exportByPaymentMethod()
  window.exportByPaymentMethod = exportByPaymentMethod;

  </script>
</body>
</html>
