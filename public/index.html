<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JBS Knit Wear — Billing</title>

  <style>
  :root{
    --bg:#f5f7fb;
    --sidebar:#fff;
    --card:#ffffff;
    --muted:#8b98a6;
    --accent:#1976ff;
    --radius:12px;
    --shadow: 0 8px 20px rgba(20,30,50,0.06);
    --container-max:1200px;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{background:var(--bg);color:#111;}

/* Top header */
.header{
  height:68px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 18px;
  background:transparent;
  position:sticky;
  top:0;
  z-index:20;
}

/* App title left */
.brand{display:flex;align-items:center;gap:12px}
.brand .title{font-weight:800;font-size:18px;letter-spacing:0.2px}
.small-note{color:var(--muted);font-size:12px}

/* Wrapper with left sidebar and main content */
.wrapper{display:flex;min-height:calc(100vh - 68px);}

/* Sidebar */
.sidebar{
  width:230px;
  background:var(--sidebar);
  padding:28px 18px;
  box-shadow: 0 2px 8px rgba(20,30,50,0.03);
  border-right:1px solid rgba(16,24,40,0.03);
  box-sizing:border-box;
  position:sticky;
  top:68px;
  height: calc(100vh - 68px);
}
.logo{font-weight:800;margin-bottom:18px}
.nav{display:flex;flex-direction:column;gap:8px}
.nav a{display:block;padding:12px 10px;border-radius:8px;color:#111;text-decoration:none;font-weight:600}
.nav a small{display:block;color:var(--muted);font-weight:400;font-size:12px;margin-top:2px}
.nav a.active{background:linear-gradient(90deg,#ffffff,#fbfdff);box-shadow: 0 6px 18px rgba(20,30,50,0.04);border-left:4px solid var(--accent);padding-left:16px}

/* Layout container (content + right panel) */
.container{
  display:grid;
  width:100%;
  max-width:var(--container-max);
  margin:20px auto;
  grid-template-columns: 1fr 420px;
  column-gap:28px;
  align-items:start;
  padding:0 18px;
  box-sizing:border-box;
}

/* main content column */
.content{
  min-width:0;
}

/* right panel (invoice card area) */
.panel{
  min-width:0;
  display:block;
}

/* Card style */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:20px;
  box-shadow:var(--shadow);
  border:1px solid rgba(16,24,40,0.03);
  box-sizing:border-box;
}

/* Dashboard big card */
.h1{font-size:28px;font-weight:800;margin-bottom:6px}
.h2{font-size:15px;color:var(--muted);margin-bottom:14px}

/* Stats row */
.stat-row{display:flex;gap:18px;flex-wrap:wrap}
.stat{flex:1;min-width:180px;background:#fff;border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(20,30,50,0.03)}
.stat .label{color:var(--muted);font-size:13px}
.stat .value{font-weight:800;font-size:20px;margin-top:8px}

/* Recent list */
.table{margin-top:16px;border-radius:10px;overflow:hidden;background:#fff;padding:8px;border:1px solid rgba(16,24,40,0.03)}
.table .thead{display:flex;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(16,24,40,0.03)}
.table .thead div{flex:1;font-weight:700}
.table .row{display:flex;gap:10px;padding:12px}

/* Create Invoice card specifics */
.invoice-card .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.input{background:#fff;border:1px solid #e6eef9;padding:10px;border-radius:8px;min-height:38px;box-sizing:border-box}
.input.small{width:100px}
.input.medium{width:200px}
.input.full{width:100%}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#fff;padding:9px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid #e7eef8;color:#111}
.btn.warn{background:#ff8a00}

/* Products list */
.items{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.item{
  display:grid;
  gap:10px;
  align-items:center;
  grid-template-columns:
    48px              /* sno */
    minmax(140px, 1fr)/* product */
    76px              /* qty */
    90px              /* rate */
    64px              /* disc% */
    88px              /* amount */
    36px;             /* remove */
  background:#fff;border:1px solid #eef3f8;border-radius:10px;padding:8px;
}
.item .sno{font-weight:700;color:var(--muted);padding-left:8px}
.item input, .item select{
  width:100%;height:36px;padding:6px 8px;border-radius:6px;border:1px solid #e8eef6;box-sizing:border-box;
  background:transparent;
}

/* footer totals */
.totals{display:flex;flex-direction:column;gap:8px;align-items:flex-end;margin-top:12px}
.totals .line{display:flex;gap:12px;align-items:center}
.totals .label{color:var(--muted);min-width:120px;text-align:right}
.totals .value{font-weight:800;font-size:18px;min-width:80px;text-align:right}

/* mobile / responsive rules */
@media (max-width:980px){
  .container{grid-template-columns: 1fr; padding-bottom:60px}
  .sidebar{position:relative;width:100%;height:auto;border-right:0;border-bottom:1px solid rgba(16,24,40,0.03);}
  .panel{order:2;margin-top:14px}
  .content{order:1}
  .item{
    grid-template-columns:
      48px minmax(140px, 1fr);
  }
  .item > .qty,
  .item > .rate,
  .item > .disc,
  .item > .amt,
  .item > .remove {
    grid-column: 1 / -1;
    display:flex;
    gap:8px;
  }
}

/* tiny phones */
@media (max-width:480px){
  .brand .title{font-size:16px}
  .nav a{padding:10px 8px}
  .card{padding:12px}
  .item input{height:34px}
}
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="title">JBS KNIT WEAR — Billing</div>
      <div class="small-note">Simple billing for retail</div>
    </div>

    <div style="display:flex;align-items:center;gap:12px">
      <div style="color:var(--muted);font-size:13px">Opening balance (today)</div>
      <input id="openingInput" class="input small" type="number" step="0.01" value="0.00" />
      <button id="setOpeningBtn" class="btn">Set</button>
      <button id="clearOpeningBtn" class="btn ghost">Clear</button>
    </div>
  </div>

  <div class="wrapper">
    <aside class="sidebar">
      <div class="logo">JBS KNIT WEAR — <small style="font-weight:600">Billing</small></div>

      <nav class="nav" aria-label="Main menu">
        <a href="#" class="active" id="nav-dashboard">Dashboard <small>Quick totals & recent</small></a>
        <a href="#" id="nav-trans">Transactions <small>Income & expense quick add</small></a>
        <a href="#" id="nav-create">Create Invoice <small>Add products & save</small></a>
        <a href="#" id="nav-invoices">Invoices <small>Saved invoices list</small></a>
        <a href="#" id="nav-print">Printable template <small>View / print invoice</small></a>
      </nav>

      <div style="margin-top:18px;color:var(--muted);font-size:13px">
        Tip: Use Save then Print from the invoice view.
      </div>
    </aside>

    <main class="container">
      <!-- left content -->
      <section class="content">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div>
              <div class="h1">Billing Dashboard</div>
              <div class="h2">Quick overview of today's totals and recent activity</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700;color:var(--accent);">Profit: ₹<span id="profitVal">0.00</span></div>
            </div>
          </div>

          <div style="margin-top:12px" class="stat-row">
            <div class="stat">
              <div class="label">Total Income</div>
              <div class="value">₹<span id="totalIncome">0.00</span></div>
            </div>
            <div class="stat">
              <div class="label">Total Expense</div>
              <div class="value">₹<span id="totalExpense">0.00</span></div>
            </div>
            <div class="stat">
              <div class="label">Profit</div>
              <div class="value">₹<span id="totalProfit">0.00</span></div>
            </div>
          </div>

          <div class="table" style="margin-top:14px">
            <div class="thead">
              <div style="flex:1">Date</div>
              <div style="flex:1">Type</div>
              <div style="flex:1">Category</div>
              <div style="flex:1;text-align:right">Amount</div>
            </div>
            <div id="recentList"></div>
          </div>
        </div>
      </section>

      <!-- right panel - invoice card -->
      <aside class="panel">
        <div class="card invoice-card" id="invoiceCard">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div style="font-weight:800;font-size:18px">Create Invoice</div>
            <div style="color:var(--muted);font-size:13px">Tip: enter product, qty & rate — amounts auto</div>
          </div>

          <!-- top inputs -->
          <div class="row" style="margin-bottom:8px">
            <input id="invoiceNo" class="input medium" placeholder="Invoice no (auto)" readonly />
            <input id="invoiceDate" class="input medium" type="date" />
            <input id="customerName" class="input full" placeholder="Customer name" />
          </div>

          <!-- products header -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
            <div style="font-weight:700;color:var(--muted)">Products</div>
            <div class="controls">
              <button id="addProductBtn" class="btn">+ Add</button>
              <button id="clearProductsBtn" class="btn ghost">Clear</button>
              <button id="recalcBtn" class="btn ghost">Recalc</button>
            </div>
          </div>

          <!-- items list -->
          <div class="items" id="itemsContainer">
            <!-- JS will populate rows -->
          </div>

          <!-- totals -->
          <div class="totals">
            <div class="line">
              <div class="label">Subtotal:</div>
              <div class="value">₹<span id="subtotal">0.00</span></div>
            </div>
            <div class="line">
              <div style="display:flex;gap:8px;align-items:center">
                <div class="label">Tax %:</div>
                <input id="taxPct" class="input small" type="number" min="0" value="0" />
              </div>
              <div class="value">₹<span id="taxVal">0.00</span></div>
            </div>
            <div class="line" style="font-size:18px">
              <div class="label" style="font-weight:800">Total</div>
              <div class="value">₹<span id="totalVal">0.00</span></div>
            </div>

            <div style="display:flex;gap:10px;margin-top:10px">
              <button id="saveInvBtn" class="btn">Save</button>
              <button id="printInvBtn" class="btn ghost">Print</button>
              <button id="resetFormBtn" class="btn warn">Reset</button>
            </div>
          </div>

        </div>
      </aside>
    </main>
  </div>

  <script>
  // ---------- Helpers ----------
  const el = (id)=>document.getElementById(id);
  const fmt = v=>Number(v||0).toFixed(2);

  // ---------- Invoice UI logic ----------
  let items = [];

  function makeRow(index, data = {}) {
    const row = document.createElement('div');
    row.className = 'item';
    row.dataset.index = index;

    row.innerHTML = `
      <div class="sno">${index+1}</div>
      <div><input class="prod" placeholder="Product" value="${data.product||''}" /></div>
      <div class="qty"><input type="number" min="0" step="1" class="qtyI" value="${data.qty||''}" placeholder="Qty" /></div>
      <div class="rate"><input type="number" min="0" step="0.01" class="rateI" value="${data.rate||''}" placeholder="Rate" /></div>
      <div class="disc"><input type="number" min="0" step="0.01" class="discI" value="${data.disc||0}" placeholder="Disc%" /></div>
      <div class="amt"><input readonly class="amtI input" value="${fmt(data.amount||0)}" /></div>
      <div class="remove"><button class="btn ghost removeBtn">x</button></div>
    `;
    attachRowHandlers(row);
    return row;
  }

  function attachRowHandlers(row){
    const qty = row.querySelector('.qtyI');
    const rate = row.querySelector('.rateI');
    const disc = row.querySelector('.discI');
    const prod = row.querySelector('.prod');
    const remove = row.querySelector('.removeBtn');
    qty.addEventListener('input',()=>recalcAll());
    rate.addEventListener('input',()=>recalcAll());
    disc.addEventListener('input',()=>recalcAll());
    prod.addEventListener('change',()=>{}); // placeholder
    remove.addEventListener('click',()=>{
      const idx = Number(row.dataset.index);
      items.splice(idx,1);
      renderItems();
    });
  }

  function renderItems(){
    const container = el('itemsContainer');
    container.innerHTML = '';
    items.forEach((d,i)=>container.appendChild(makeRow(i,d)));
    recalcAll();
  }

  function addProduct(data){
    items.push(data||{product:'',qty:'',rate:'',disc:0,amount:0});
    renderItems();
    // focus last product input
    setTimeout(()=> {
      const last = document.querySelector('#itemsContainer .item:last-child .prod');
      if(last) last.focus();
    },40);
  }

  function clearProducts(){
    items = [];
    for(let i=0;i<4;i++) items.push({product:'',qty:'',rate:'',disc:0,amount:0});
    renderItems();
  }

  function recalcAll(){
    const container = el('itemsContainer');
    let subtotal = 0;
    const rows = container.querySelectorAll('.item');
    rows.forEach((row,idx)=>{
      const qty = Number(row.querySelector('.qtyI').value||0);
      const rate = Number(row.querySelector('.rateI').value||0);
      const disc = Number(row.querySelector('.discI').value||0);
      let amount = qty * rate;
      if(disc) amount = amount * (1 - (disc/100));
      subtotal += amount;
      row.querySelector('.amtI').value = fmt(amount);
      items[idx] = {
        product: row.querySelector('.prod').value||'',
        qty, rate, disc, amount
      };
    });
    el('subtotal').innerText = fmt(subtotal);
    const taxPct = Number(el('taxPct').value||0);
    const taxVal = subtotal * (taxPct/100);
    el('taxVal').innerText = fmt(taxVal);
    const total = subtotal + taxVal;
    el('totalVal').innerText = fmt(total);
    // update some dashboard totals (local only)
    el('totalIncome').innerText = fmt(total);
    el('totalExpense').innerText = fmt(0);
    el('totalProfit').innerText = fmt(total);
  }

  // ---------- Save / Print ----------
  async function saveInvoice(){
    recalcAll();
    const payload = {
      invoice_no: el('invoiceNo').value || null,
      date: el('invoiceDate').value|| new Date().toISOString().slice(0,10),
      customer: el('customerName').value||'',
      items: items.map(it=>({product:it.product, qty:it.qty, rate:it.rate, disc:it.disc, amount:it.amount})),
      subtotal: Number(el('subtotal').innerText||0),
      tax_pct: Number(el('taxPct').value||0),
      tax_amount: Number(el('taxVal').innerText||0),
      total: Number(el('totalVal').innerText||0)
    };

    try{
      const res = await fetch('/invoices', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok) {
        const text = await res.text();
        alert('Save failed: ' + (res.statusText||text));
        return;
      }
      const data = await res.json();
      // server should return saved invoice id or invoice_no
      el('invoiceNo').value = data.invoice_no || data.id || '';
      alert('Saved invoice id ' + (data.id || data.invoice_no || 'OK'));
    }catch(e){
      alert('Save error: ' + e.message);
    }
  }

  function printInvoice(){
    // naive: open printable template route in new tab if server provides it
    const id = el('invoiceNo').value;
    if(!id){
      alert('Please save invoice first to print (or enter invoice id).');
      return;
    }
    // try /invoice-template.html?id=ID
    window.open('/invoice-template.html?id=' + encodeURIComponent(id), '_blank');
  }

  // ---------- opening balance ----------

  function setOpening(){
    const val = Number(el('openingInput').value||0);
    localStorage.setItem('opening_balance_today', String(val));
    alert('Opening balance set: ₹' + fmt(val));
    // show somewhere if needed
    el('profitVal').innerText = fmt(val);
  }
  function clearOpening(){
    localStorage.removeItem('opening_balance_today');
    el('openingInput').value = '0.00';
    el('profitVal').innerText = '0.00';
    alert('Opening cleared');
  }

  // ---------- init ----------
  function init(){
    // invoice defaults
    el('invoiceDate').value = new Date().toISOString().slice(0,10);
    el('invoiceNo').value = ''; // server auto
    // prepare 4 rows by default
    clearProducts();

    // load opening if exists
    const open = localStorage.getItem('opening_balance_today');
    if(open) el('openingInput').value = fmt(open);

    // attach buttons
    el('addProductBtn').addEventListener('click', ()=>addProduct());
    el('clearProductsBtn').addEventListener('click', ()=>{ clearProducts(); });
    el('recalcBtn').addEventListener('click', ()=>recalcAll());
    el('saveInvBtn').addEventListener('click', ()=>saveInvoice());
    el('printInvBtn').addEventListener('click', ()=>printInvoice());
    el('resetFormBtn').addEventListener('click', ()=>{
      if(!confirm('Type RESET to confirm permanent wipe of form data:')){
        return;
      }
      // simple reset of form to defaults
      el('customerName').value = '';
      el('taxPct').value = 0;
      el('invoiceNo').value = '';
      el('invoiceDate').value = new Date().toISOString().slice(0,10);
      clearProducts();
      recalcAll();
    });

    el('setOpeningBtn').addEventListener('click', setOpening);
    el('clearOpeningBtn').addEventListener('click', clearOpening);

    // nav anchors
    document.getElementById('nav-create').addEventListener('click', (e)=>{
      e.preventDefault();
      // scroll panel into view on narrow screens
      document.querySelector('.panel').scrollIntoView({behavior:'smooth'});
    });

    // initial recalc
    recalcAll();
  }

  // run on load
  window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
