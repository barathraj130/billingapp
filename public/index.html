<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing — JBS KNIT WEAR</title>

<!-- Minimal UI + responsive CSS (mobile-first) -->
<style>
  :root{
    --bg:#f4f7fa;
    --panel:#ffffff;
    --muted:#8b96a3;
    --accent:#1976ff;
    --danger:#ff6b5f;
    --radius:12px;
    --gap:18px;
    --sidebar-w:260px;
    --max-w:1200px;
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{background:var(--bg);color:#111;line-height:1.25}
  .app{display:flex;min-height:100vh;}
  /* Sidebar */
  .sidebar{
    width:var(--sidebar-w);
    background:linear-gradient(#fff,#fff);
    padding:28px 18px;
    box-shadow:0 0 0 1px rgba(0,0,0,0.02);
    box-sizing:border-box;
  }
  .brand{font-weight:800;font-size:18px;margin-bottom:6px}
  .brand small{font-weight:400;color:var(--muted);display:block;font-size:12px;margin-top:4px}
  .nav{margin-top:22px}
  .nav a{display:block;padding:12px 10px;border-radius:8px;color:#0f1720;text-decoration:none;margin-bottom:6px; font-weight:600}
  .nav a .hint{display:block;font-size:12px;color:var(--muted);font-weight:400;margin-top:4px}
  .nav a.active{background:#eef6ff;border-left:4px solid var(--accent); padding-left:14px}
  .sidebar .small{font-size:12px;color:var(--muted);margin-top:24px}
  .sidebar .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;margin-right:8px;cursor:pointer}
  .sidebar .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .sidebar .meta{margin-top:18px;color:var(--muted);font-size:13px}

  /* Main content */
  .main{flex:1;padding:24px;box-sizing:border-box;display:flex;flex-direction:column;align-items:center}
  .topbar{width:100%;max-width:var(--max-w);display:flex;justify-content:flex-end;gap:12px;align-items:center;margin-bottom:18px}
  .container{width:100%;max-width:var(--max-w);display:grid;grid-template-columns:1fr 380px;gap:20px}

  /* On mobile, single column */
  @media (max-width:980px){
    .container{grid-template-columns:1fr}
    .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:10;transform:translateX(0);width:220px}
    .main{padding-left:240px}
  }

  @media (max-width:720px){
    .sidebar{display:none}
    .main{padding-left:16px;padding-right:16px}
    .container{grid-template-columns:1fr}
  }

  /* Cards and forms */
  .card{background:var(--panel);border-radius:var(--radius);padding:22px;box-shadow:0 10px 30px rgba(17,24,39,0.06);box-sizing:border-box}
  h1.section{margin:0 0 12px 0;font-size:28px}
  .stat-group{display:flex;gap:12px;flex-wrap:wrap}
  .stat{flex:1;min-width:170px;background:#fff;border-radius:12px;padding:18px;border:1px solid #f1f5f9}
  .stat .label{color:var(--muted);font-size:13px}
  .stat .value{font-weight:800;font-size:20px;margin-top:6px}

  /* Transactions / table */
  table{width:100%;border-collapse:collapse}
  table thead th{background:#fbfdff;text-align:left;padding:12px 16px;border-radius:8px;font-weight:700;color:#233}
  table td{padding:14px 16px;border-bottom:1px solid #f2f4f7;color:#333}
  .right{text-align:right}

  /* Create Invoice form layout */
  .invoice-form{display:flex;flex-direction:column;gap:14px}
  .row{display:flex;gap:12px;align-items:center}
  .row .flex{flex:1}
  input[type="text"],input[type="number"],select,input[type="date"]{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e7eef6;background:#fff;box-sizing:border-box;font-size:14px
  }
  .product-row{display:grid;grid-template-columns:48px 1fr 80px 90px 70px 36px;gap:10px;align-items:center;padding:12px;border-radius:10px;border:1px solid #eef3f8;background:#fff}
  .product-row .idx{font-weight:700;color:#666}
  .product-row input{padding:10px;border-radius:8px;border:1px solid #eef3f8;background:transparent}
  .controls{display:flex;gap:10px;align-items:center}
  .btn{padding:8px 14px;border-radius:10px;border:1px solid transparent;background:var(--panel);cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .btn.ghost{background:#fff;border:1px solid #e6eef9}
  .btn.warn{background:var(--danger);color:#fff}

  /* right totals */
  .totals{display:flex;flex-direction:column;align-items:flex-end;gap:8px;margin-top:8px}
  .totals .line{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:13px}

  /* printable invoice */
  @media print{
    body{background:#fff}
    .sidebar,.topbar,.nav{display:none}
    .container{max-width:100%;grid-template-columns:1fr}
    .card{box-shadow:none;border-radius:0}
  }
  /* small helpers */
  .pill{display:inline-block;padding:6px 10px;border-radius:8px;background:#f3f6fb;color:var(--muted);font-weight:600}
  .float-right{margin-left:auto}
  .center{display:flex;align-items:center;justify-content:center}
  .trash-badge{font-size:13px;background:#fff;border-radius:8px;padding:6px 10px;border:1px dashed #e6e9ee}
</style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">JBS KNIT WEAR — <strong style="font-weight:700">Billing</strong>
      <small>Simple billing for retail</small>
    </div>

    <nav class="nav" id="nav">
      <a href="#" data-view="dashboard" class="active">Dashboard <span class="hint">Quick totals & recent</span></a>
      <a href="#" data-view="transactions">Transactions <span class="hint">Income & expense add</span></a>
      <a href="#" data-view="create">Create Invoice <span class="hint">Add products & save</span></a>
      <a href="#" data-view="invoices">Invoices <span class="hint">Saved invoices list</span></a>
      <a href="#" data-view="printable">Printable template <span class="hint">View / print invoice</span></a>
    </nav>

    <div class="meta">
      <div class="small">Tip: Save then Print from invoice view.</div>
      <div style="margin-top:14px">
        <button class="btn" id="exportBackupBtn">Export backup</button>
        <button class="btn" id="importBackupBtn">Import</button>
      </div>
      <div style="margin-top:12px">
        <button class="btn" id="trashBtn">Trash (<span id="trashCount">0</span>)</button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="pill muted">Opening balance (today)</div>
      <input id="openingInput" type="number" placeholder="0.00" style="width:120px;padding:10px;border-radius:8px;border:1px solid #e7eef6;background:#fff" />
      <button class="btn primary" id="setOpening">Set</button>
      <button class="btn ghost" id="clearOpening">Clear</button>
    </div>

    <div class="container">
      <!-- LEFT COLUMN: Dashboard, Transactions, Create etc (switchable) -->
      <div id="leftColumn">

        <!-- DASHBOARD VIEW -->
        <div class="card" id="view-dashboard">
          <h1 class="section">Billing Dashboard <span class="pill float-right" id="profitLabel">Profit: ₹0.00</span></h1>
          <div class="muted">Quick overview of today's totals and recent activity</div>
          <div style="height:16px"></div>

          <div class="stat-group">
            <div class="stat">
              <div class="label">Total Income</div>
              <div class="value" id="stat-income">₹0.00</div>
            </div>
            <div class="stat">
              <div class="label">Total Expense</div>
              <div class="value" id="stat-expense">₹0.00</div>
            </div>
            <div class="stat">
              <div class="label">Profit</div>
              <div class="value" id="stat-profit">₹0.00</div>
            </div>
          </div>

          <div style="height:18px"></div>

          <div style="display:flex;gap:18px;align-items:flex-start">
            <div style="flex:1">
              <div style="margin-top:10px" class="card">
                <h2 style="margin:0 0 12px 0">Recent transactions</h2>
                <table>
                  <thead><tr><th>Date</th><th>Type</th><th>Category</th><th class="right">Amount</th></tr></thead>
                  <tbody id="dashboardRecent">
                    <tr><td colspan="4" class="muted">No recent transactions</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div style="width:320px">
              <div class="card">
                <h3 style="margin:0 0 8px 0">Recent transactions</h3>
                <div style="text-align:right;margin-bottom:8px"><button class="btn primary" id="exportAllCsv">Export CSV</button></div>
                <table><thead><tr><th>Date</th><th>Type</th><th>Cat</th><th class="right">Amount</th></tr></thead>
                <tbody id="miniTransactions"><tr><td colspan="4" class="muted">No recent transactions</td></tr></tbody></table>
              </div>
            </div>
          </div>
        </div>

        <!-- TRANSACTIONS VIEW -->
        <div class="card" id="view-transactions" style="display:none">
          <h1 class="section">Transactions</h1>
          <div class="muted">Quick add income & expense</div>

          <div style="height:12px"></div>

          <div style="display:flex;flex-wrap:wrap;gap:10px">
            <select id="txType" style="min-width:120px"><option value="income">Income</option><option value="expense">Expense</option></select>
            <input id="txCategory" type="text" placeholder="Category (e.g. sales, office)" />
            <input id="txAmount" type="number" placeholder="Amount" />
            <input id="txDate" type="date" />
            <select id="txPayMethod"><option value="Cash">Cash</option><option value="GPay">GPay</option><option value="Other">Other</option></select>
            <button class="btn primary" id="addTxBtn">Add</button>
          </div>

          <div style="height:10px"></div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <input id="filterFrom" type="date" />
            <input id="filterTo" type="date" />
            <select id="filterType"><option value="all">All</option><option value="income">Income</option><option value="expense">Expense</option></select>
            <select id="filterPay"><option value="all">All</option><option value="Cash">Cash</option><option value="GPay">GPay</option></select>
            <button class="btn" id="filterBtn">Filter</button>
            <button class="btn" id="clearFilterBtn">Clear</button>
            <div style="margin-left:auto"><button class="btn primary" id="downloadTxCsv">Download CSV</button></div>
          </div>

          <div style="height:12px"></div>
          <div class="card" style="padding:0">
            <table>
              <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th class="right">Amount</th></tr></thead>
              <tbody id="txTableBody"><tr><td colspan="5" class="muted">No transactions added</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- CREATE INVOICE VIEW -->
        <div class="card" id="view-create" style="display:none">
          <h1 class="section">Create Invoice <span class="muted" style="font-size:14px;margin-left:8px">— manage invoices & quick sales</span></h1>

          <div class="invoice-form">
            <div class="row">
              <input id="invNo" type="text" placeholder="Invoice no (auto)" style="max-width:180px"/>
              <input id="invDate" type="date" />
              <input id="invCustomer" type="text" placeholder="Customer name" />
            </div>

            <div>
              <div class="muted">Payment Method</div>
              <select id="invPay" style="width:220px;margin-top:6px">
                <option>Cash</option><option>GPay</option><option>Other</option>
              </select>
            </div>

            <div>
              <div style="display:flex;justify-content:space-between;align-items:center">
                <h3 style="margin:6px 0">Products</h3>
                <div class="controls">
                  <button class="btn primary" id="addProdBtn">+ Add</button>
                  <button class="btn ghost" id="clearProdBtn">Clear</button>
                  <button class="btn ghost" id="recalcBtn">Recalc</button>
                </div>
              </div>

              <div id="productsList" style="display:flex;flex-direction:column;gap:12px">
                <!-- product-row template will be inserted here -->
              </div>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <button class="btn primary" id="saveInvoiceBtn">Save</button>
                <button class="btn" id="printInvoiceBtn">Print</button>
                <button class="btn warn" id="resetInvBtn">Reset</button>
              </div>

              <div class="totals">
                <div class="line"><div class="muted">Subtotal:</div><div style="width:24px"></div><div id="subTotal">₹0.00</div></div>
                <div class="line"><div class="muted">Tax %:</div><input id="taxPct" type="number" value="0" style="width:80px"/></div>
                <div class="line" style="font-weight:800;font-size:18px"><div class="muted">Total</div><div style="width:18px"></div><div id="invTotal">₹0.00</div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- INVOICES VIEW -->
        <div class="card" id="view-invoices" style="display:none">
          <h1 class="section">Invoices</h1>
          <div style="margin-top:8px">
            <input id="searchInvoice" type="text" placeholder="Search invoice / customer" style="padding:8px;border-radius:8px;border:1px solid #e7eef6;width:320px"/>
            <button class="btn" id="searchInvoiceBtn">Search</button>
            <button class="btn primary" id="exportInvoicesCsv">Export CSV (all)</button>
            <button class="btn" id="exportCashCsv">Export Cash</button>
            <button class="btn" id="exportGpayCsv">Export GPay</button>
          </div>

          <div style="height:12px"></div>

          <div class="card" style="padding:0">
            <table>
              <thead><tr><th>Invoice</th><th>Date</th><th>Customer</th><th>Pay</th><th class="right">Total</th><th>Actions</th></tr></thead>
              <tbody id="invoicesTable"><tr><td colspan="6" class="muted">No invoices</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- PRINTABLE TEMPLATE VIEW -->
        <div class="card" id="view-printable" style="display:none">
          <h1 class="section">Printable template</h1>
          <div class="muted">View / print invoice</div>
          <div style="height:12px"></div>
          <div class="card">
            <div style="display:flex;gap:8px">
              <select id="printSelect" style="flex:1;padding:10px"><option value="">Select invoice to preview</option></select>
              <button class="btn primary" id="openPrintBtn">Open</button>
            </div>
            <div style="height:12px"></div>
            <div id="printPreview" style="border:1px dashed #e7eef6;padding:12px;border-radius:8px"></div>
          </div>
        </div>

      </div>

      <!-- RIGHT COLUMN: quick panel or invoice summary -->
      <div id="rightColumn">
        <!-- small summary panel -->
        <div class="card" id="right-panel">
          <h3 style="margin:0 0 8px 0">Quick invoice panel</h3>
          <div class="muted">(also available in Create Invoice)</div>
          <div style="height:12px"></div>

          <div>
            <div style="display:flex;gap:8px">
              <input id="quickTotal" type="text" placeholder="Quick total" />
              <button class="btn primary" id="quickAddBtn">Add</button>
            </div>
          </div>

          <div style="height:16px"></div>
          <div class="muted">Use the left menu to open the full Create Invoice screen for editing and printing.</div>
        </div>
      </div>

    </div> <!-- container -->
  </main>
</div>

<!-- JS -->
<script>
/**
 * Full front-end logic:
 * - localStorage persistence for invoices & transactions
 * - view switching (sidebar)
 * - create invoice UI, products, calculations, save, print
 * - transactions quick add, filter, CSV export
 * - trash / restore and export/import backup
 *
 * NOTE: For server persistence (recommended for production) add API calls
 * to your server endpoints to persist invoices/transactions in DB.
 */

/* ---------- Storage helpers ---------- */
const STORAGE_KEYS = {
  INVOICES: 'billing_invoices_v1',
  TRANSACTIONS: 'billing_transactions_v1',
  TRASH: 'billing_trash_v1',
  OPENING: 'billing_opening_v1',
  DAILY_BACKUPS: 'billing_daily_backups_v1'
};

function readJson(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch(e){ console.error('readJson error',e); return fallback; }
}
function writeJson(key, data){
  localStorage.setItem(key, JSON.stringify(data));
}

/* init storage */
let invoices = readJson(STORAGE_KEYS.INVOICES, []);
let transactions = readJson(STORAGE_KEYS.TRANSACTIONS, []);
let trash = readJson(STORAGE_KEYS.TRASH, []);
let backups = readJson(STORAGE_KEYS.DAILY_BACKUPS, {});

/* ---------- UI helpers ---------- */
function el(id){ return document.getElementById(id); }
function money(v){ return '₹' + Number(v||0).toFixed(2); }

/* ---------- NAV / VIEW SWITCH ---------- */
const navLinks = document.querySelectorAll('#nav a');
navLinks.forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    // toggle active
    navLinks.forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    const view = a.getAttribute('data-view');
    showView(view);
  });
});
function showView(name){
  const views = ['dashboard','transactions','create','invoices','printable'];
  views.forEach(v=>{
    const id = 'view-' + v;
    const elView = document.getElementById(id);
    if(elView) elView.style.display = (v===name) ? 'block' : 'none';
  });
  // on show actions
  if(name==='dashboard'){ renderDashboard(); }
  if(name==='transactions'){ renderTxTable(); }
  if(name==='create'){ initCreateInvoice(); }
  if(name==='invoices'){ renderInvoicesTable(); }
  if(name==='printable'){ renderPrintSelect(); }
}

/* ---------- Dashboard ---------- */
function renderDashboard(){
  // totals for today
  const today = new Date().toISOString().slice(0,10);
  let income=0, expense=0;
  transactions.forEach(t=>{
    if(t.date === today || true){ // show totals overall (change as you want)
      if(t.type === 'income') income += Number(t.amount || 0);
      if(t.type === 'expense') expense += Number(t.amount || 0);
    }
  });
  el('stat-income').textContent = money(income);
  el('stat-expense').textContent = money(expense);
  el('stat-profit').textContent = money(income - expense);
  el('profitLabel').textContent = 'Profit: ' + money(income - expense);

  // show recent tx (last 5)
  const recent = transactions.slice().reverse().slice(0,5);
  const db = el('dashboardRecent'); db.innerHTML = '';
  if(!recent.length) db.innerHTML = '<tr><td colspan="4" class="muted">No recent transactions</td></tr>';
  else recent.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.type}</td><td>${r.category}</td><td class="right">${money(r.amount)}</td>`;
    db.appendChild(tr);
  });

  // mini right panel
  const mini = el('miniTransactions'); mini.innerHTML = '';
  if(!recent.length) mini.innerHTML = '<tr><td colspan="4" class="muted">No recent transactions</td></tr>';
  else recent.forEach(r=> {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.type}</td><td>${r.category}</td><td class="right">${money(r.amount)}</td>`;
    mini.appendChild(tr);
  });
}

/* ---------- TRANSACTIONS ---------- */
function saveTransactions(){
  writeJson(STORAGE_KEYS.TRANSACTIONS, transactions);
}
function renderTxTable(filtered){
  const tb = el('txTableBody'); tb.innerHTML = '';
  const list = filtered || transactions;
  if(!list.length){ tb.innerHTML = '<tr><td colspan="5" class="muted">No transactions added</td></tr>'; return; }
  list.slice().reverse().forEach((t, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.date}</td><td>${t.type}</td><td>${t.category}</td><td>${t.pay}</td><td class="right">${money(t.amount)}</td>`;
    tb.appendChild(tr);
  });
}
el('addTxBtn').addEventListener('click', ()=>{
  const type = el('txType').value;
  const cat = el('txCategory').value || '-';
  const amt = parseFloat(el('txAmount').value || '0');
  const date = el('txDate').value || new Date().toISOString().slice(0,10);
  const pay = el('txPayMethod').value || 'Cash';
  if(!amt || amt<=0){ alert('Enter amount'); return; }
  const id = 'tx_' + Date.now();
  transactions.push({id,type,category:cat,amount:amt,date,pay});
  saveTransactions();
  el('txCategory').value=''; el('txAmount').value=''; el('txDate').value='';
  renderTxTable();
  renderDashboard();
});
el('filterBtn').addEventListener('click', ()=>{
  const from = el('filterFrom').value;
  const to = el('filterTo').value;
  const type = el('filterType').value;
  const pay = el('filterPay').value;
  let list = transactions.slice();
  if(type!=='all') list = list.filter(x=>x.type===type);
  if(pay!=='all') list = list.filter(x=>x.pay===pay);
  if(from) list = list.filter(x=>x.date >= from);
  if(to) list = list.filter(x=>x.date <= to);
  renderTxTable(list);
});
el('clearFilterBtn').addEventListener('click', ()=>{ el('filterFrom').value=''; el('filterTo').value=''; el('filterType').value='all'; el('filterPay').value='all'; renderTxTable(); });

/* CSV export helper */
function downloadCSV(filename, rows){
  const csv = rows.map(r => r.map(c => {
    if(typeof c === 'string' && c.includes(',')) return '"' + c.replace(/"/g,'""') + '"';
    return c;
  }).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
el('downloadTxCsv').addEventListener('click', ()=>{
  const rows = [['date','type','category','pay','amount']];
  transactions.forEach(t=> rows.push([t.date,t.type,t.category,t.pay,t.amount]));
  downloadCSV('transactions.csv', rows);
});
el('exportAllCsv').addEventListener('click', ()=> document.getElementById('downloadTxCsv').click());

/* ---------- CREATE INVOICE ---------- */

/* template product row factory */
function createProductRow(idx, data = {}){
  const wrapper = document.createElement('div');
  wrapper.className = 'product-row';
  const qty = data.qty || 0, rate = data.rate || 0, disc = data.disc || 0, name = data.name || '';
  wrapper.innerHTML = `
    <div class="idx">${idx}</div>
    <div><input class="p-name" type="text" value="${escapeHtml(name)}" placeholder="Product description" /></div>
    <div><input class="p-qty" type="number" value="${qty}" min="0" /></div>
    <div><input class="p-rate" type="number" value="${rate}" min="0" /></div>
    <div><input class="p-disc" type="number" value="${disc}" min="0" /></div>
    <div class="center"><button class="btn" title="Remove">x</button></div>
  `;
  // remove handler
  wrapper.querySelector('button').addEventListener('click', ()=>{
    wrapper.remove();
    refreshProductIndices();
    recalcTotals();
  });
  return wrapper;
}
function escapeHtml(s){ return String(s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

function refreshProductIndices(){
  const rows = [...document.querySelectorAll('#productsList .product-row')];
  rows.forEach((r,i)=> r.querySelector('.idx').textContent = (i+1));
}

function recalcTotals(){
  const rows = [...document.querySelectorAll('#productsList .product-row')];
  let subtotal = 0;
  rows.forEach(r=>{
    const qty = Number(r.querySelector('.p-qty').value || 0);
    const rate = Number(r.querySelector('.p-rate').value || 0);
    const disc = Number(r.querySelector('.p-disc').value || 0);
    let amount = qty * rate;
    if(disc) amount = amount * (1 - (disc/100));
    subtotal += amount;
    // update rightmost amount (we inserted as last cell—better show by updating a small element)
    // For simplicity show as inline number in last cell's button area (we can add an element)
    // We'll set a data attribute for display
    let disp = r.querySelector('.p-amount');
    if(!disp){
      disp = document.createElement('div'); disp.className='p-amount'; disp.style.fontWeight='700'; disp.style.textAlign='right';
      r.appendChild(disp);
    }
    disp.textContent = money(amount);
  });
  el('subTotal').textContent = money(subtotal);
  const taxPct = Number(el('taxPct').value || 0);
  const taxVal = subtotal * (taxPct/100);
  const total = subtotal + taxVal;
  el('invTotal').textContent = money(total);
  // keep totals numeric as well
  return {subtotal, taxVal, total};
}

/* init create invoice: ensure some rows exist */
function initCreateInvoice(){
  const list = el('productsList');
  list.innerHTML = '';
  // default 4 rows if none (or when opening)
  for(let i=1;i<=4;i++){
    const row = createProductRow(i);
    list.appendChild(row);
  }
  // wire recalc on inputs
  list.addEventListener('input', ()=>{
    recalcTotals();
  });
  recalcTotals();
}
el('addProdBtn').addEventListener('click', ()=>{
  const list = el('productsList');
  const idx = list.children.length + 1;
  list.appendChild(createProductRow(idx));
});
el('clearProdBtn').addEventListener('click', ()=>{
  if(!confirm('Clear product rows?')) return;
  initCreateInvoice();
});
el('recalcBtn').addEventListener('click', recalcTotals);

/* Save invoice -> localStorage */
function generateInvoiceId(){
  return (invoices.length ? (Math.max(...invoices.map(i=>i.id)) + 1) : 1);
}

el('saveInvoiceBtn').addEventListener('click', ()=>{
  const invNo = el('invNo').value || '';
  const id = invNo ? invNo : generateInvoiceId();
  const date = el('invDate').value || new Date().toISOString().slice(0,10);
  const customer = el('invCustomer').value || '';
  const pay = el('invPay').value || 'Cash';
  const rows = [...document.querySelectorAll('#productsList .product-row')].map(r=>({
    name: r.querySelector('.p-name').value || '',
    qty: Number(r.querySelector('.p-qty').value || 0),
    rate: Number(r.querySelector('.p-rate').value || 0),
    disc: Number(r.querySelector('.p-disc').value || 0),
    amount: Number((r.querySelector('.p-qty').value||0)) * Number((r.querySelector('.p-rate').value||0))
  }));
  const totals = recalcTotals();
  const invoice = {id,invoiceNo: id, date, customer, pay, rows, subtotal: totals.subtotal, tax: Number(el('taxPct').value||0), total: totals.total, createdAt: new Date().toISOString()};
  invoices.push(invoice);
  writeJson(STORAGE_KEYS.INVOICES, invoices);

  // add to transactions too (so dashboard / records include this sale)
  transactions.push({id:'tx_inv_'+Date.now(), type:'income', category:'sales', amount: invoice.total, date: invoice.date, pay: invoice.pay});
  saveTransactions();

  // EOD daily backup storing
  const dayKey = new Date().toISOString().slice(0,10);
  backups[dayKey] = backups[dayKey] || [];
  backups[dayKey].push(invoice);
  writeJson(STORAGE_KEYS.DAILY_BACKUPS, backups);

  alert('Saved invoice ' + invoice.invoiceNo);
  renderInvoicesTable();
  renderDashboard();
});

/* Print invoice (open printable window) */
el('printInvoiceBtn').addEventListener('click', ()=>{
  // generate printable HTML
  const inv = collectCurrentInvoicePreview();
  openPrintable(inv);
});

function collectCurrentInvoicePreview(){
  const id = el('invNo').value || generateInvoiceId();
  const date = el('invDate').value || new Date().toISOString().slice(0,10);
  const customer = el('invCustomer').value || '';
  const pay = el('invPay').value || 'Cash';
  const rows = [...document.querySelectorAll('#productsList .product-row')].map((r,i)=>({
    no: i+1,
    name: r.querySelector('.p-name').value || '',
    qty: Number(r.querySelector('.p-qty').value || 0),
    rate: Number(r.querySelector('.p-rate').value || 0),
    amount: Number(r.querySelector('.p-qty').value || 0) * Number(r.querySelector('.p-rate').value || 0)
  }));
  const totals = recalcTotals();
  const invoice = {id,invoiceNo:id, company:{name:'JBS KNIT WEAR', phone:'97919 02205', gst:'33CKAPJ7513F1ZK', address:'3(2)/2B, Nesavalar Colony 2nd Street, P.N.Road, Tirupur - 641 602.'}, date, customer, pay, rows, subtotal:totals.subtotal, taxpct:Number(el('taxPct').value||0), total:totals.total};
  return invoice;
}
function openPrintable(inv){
  const w = window.open('about:blank','_blank','toolbar=0,location=0,menubar=0');
  const html = buildPrintableHtml(inv);
  w.document.write(html);
  w.document.close();
}
function buildPrintableHtml(inv){
  // portrait-friendly HTML
  return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Invoice ${inv.invoiceNo}</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:18px;color:#111}
    .h1{font-weight:800;font-size:20px}
    .meta{margin-bottom:12px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    table th,table td{border:1px solid #aaa;padding:6px;text-align:left}
    .right{text-align:right}
    .footer{margin-top:18px}
  </style>
  </head><body>
    <div class="h1">${inv.company.name}</div>
    <div style="font-size:12px">${inv.company.address}</div>
    <div class="meta">Phone: ${inv.company.phone} &nbsp;&nbsp; GSTIN: ${inv.company.gst}</div>
    <div>Date: ${inv.date} &nbsp;&nbsp; Invoice ID: ${inv.invoiceNo}</div>
    <div>Customer: ${inv.customer||'—'}</div>
    <table>
      <thead><tr><th style="width:30px">#</th><th>Product</th><th style="width:60px">Qty</th><th style="width:80px">Rate</th><th style="width:90px">Amount</th></tr></thead>
      <tbody>
        ${inv.rows.map(r=>`<tr><td>${r.no}</td><td>${escapeHtml(r.name)}</td><td class="right">${r.qty}</td><td class="right">${Number(r.rate).toFixed(2)}</td><td class="right">${Number(r.amount).toFixed(2)}</td></tr>`).join('')}
      </tbody>
    </table>
    <div class="footer">
      <div>Payment: ${inv.pay}</div>
      <div style="font-weight:800;margin-top:8px">Total: ${money(inv.total)}</div>
    </div>
  </body></html>`;
}

/* ---------- INVOICES list ---------- */
function renderInvoicesTable(){
  const tb = el('invoicesTable'); tb.innerHTML = '';
  if(!invoices.length){ tb.innerHTML = '<tr><td colspan="6" class="muted">No invoices</td></tr>'; return; }
  invoices.slice().reverse().forEach(inv=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${inv.invoiceNo}</td><td>${inv.date}</td><td>${inv.customer || ''}</td><td>${inv.pay}</td><td class="right">${money(inv.total)}</td>
      <td><button class="btn" data-id="${inv.invoiceNo}" onclick="openInvoice(${inv.invoiceNo})">Open</button>
          <button class="btn" data-id="${inv.invoiceNo}" onclick="deleteInvoice('${inv.invoiceNo}')">Delete</button></td>`;
    tb.appendChild(tr);
  });
}
window.openInvoice = function(id){
  const inv = invoices.find(i=>String(i.invoiceNo) === String(id));
  if(!inv){ alert('Invoice not found'); return; }
  // fill printable preview select and open print view
  const html = buildPrintableHtml(inv);
  const w = window.open('about:blank','_blank');
  w.document.write(html); w.document.close();
};
window.deleteInvoice = function(id){
  if(!confirm('Move invoice to trash?')) return;
  // move to trash
  const idx = invoices.findIndex(i=>String(i.invoiceNo)===String(id));
  if(idx==-1) return alert('Not found');
  const item = invoices.splice(idx,1)[0];
  writeJson(STORAGE_KEYS.INVOICES, invoices);
  // add to trash log with timestamp
  trash.push({deletedAt:new Date().toISOString(), item});
  writeJson(STORAGE_KEYS.TRASH, trash);
  el('trashCount').textContent = trash.length;
  renderInvoicesTable();
};

/* Trash button */
el('trashBtn').addEventListener('click', ()=>{
  if(!trash.length){ alert('Trash empty'); return; }
  // show a simple restore dialog
  const list = trash.map((t,i)=>`${i+1}. ${t.item.invoiceNo} (${t.item.date})`).join('\n');
  const idx = prompt('Trash items:\n' + list + '\nEnter item number to restore (or empty to close)');
  const n = Number(idx||0);
  if(n > 0 && n <= trash.length){
    const item = trash.splice(n-1,1)[0].item;
    invoices.push(item);
    writeJson(STORAGE_KEYS.INVOICES, invoices);
    writeJson(STORAGE_KEYS.TRASH, trash);
    el('trashCount').textContent = trash.length;
    alert('Restored invoice ' + item.invoiceNo);
    renderInvoicesTable();
  }
});

/* Export invoice lists */
el('exportInvoicesCsv').addEventListener('click', ()=>{
  const rows = [['invoiceNo','date','customer','pay','total']];
  invoices.forEach(i=>rows.push([i.invoiceNo,i.date,i.customer,i.pay,i.total]));
  downloadCSV('invoices_all.csv', rows);
});
el('exportCashCsv').addEventListener('click', ()=>{
  const rows = [['invoiceNo','date','customer','total']];
  invoices.filter(i=>i.pay==='Cash').forEach(i=>rows.push([i.invoiceNo,i.date,i.customer,i.total]));
  downloadCSV('invoices_cash.csv', rows);
});
el('exportGpayCsv').addEventListener('click', ()=>{
  const rows = [['invoiceNo','date','customer','total']];
  invoices.filter(i=>i.pay==='GPay').forEach(i=>rows.push([i.invoiceNo,i.date,i.customer,i.total]));
  downloadCSV('invoices_gpay.csv', rows);
});

/* ---------- Printable view select ---------- */
function renderPrintSelect(){
  const sel = el('printSelect'); sel.innerHTML = '<option value="">Select invoice to preview</option>';
  invoices.forEach(i=> sel.innerHTML += `<option value="${i.invoiceNo}">${i.invoiceNo} — ${i.date} — ${i.customer || ''}</option>`);
}
el('openPrintBtn').addEventListener('click', ()=>{
  const v = el('printSelect').value;
  if(!v) return alert('Select invoice');
  openInvoice(v);
});

/* ---------- Export/Import backup ---------- */
el('exportBackupBtn').addEventListener('click', ()=>{
  const data = {invoices, transactions, trash, backups};
  downloadJSON('billing-backup-' + new Date().toISOString().slice(0,10) + '.json', data);
});
function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}
el('importBackupBtn').addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = e=>{
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ev=>{
      try{
        const obj = JSON.parse(ev.target.result);
        if(obj.invoices) { invoices = obj.invoices; writeJson(STORAGE_KEYS.INVOICES, invoices); }
        if(obj.transactions) { transactions = obj.transactions; writeJson(STORAGE_KEYS.TRANSACTIONS, transactions); }
        if(obj.trash) { trash = obj.trash; writeJson(STORAGE_KEYS.TRASH, trash); }
        if(obj.backups) { backups = obj.backups; writeJson(STORAGE_KEYS.DAILY_BACKUPS, backups); }
        alert('Import complete');
        renderInvoicesTable(); renderDashboard(); renderTxTable();
      }catch(err){ alert('Invalid file'); }
    };
    r.readAsText(f);
  };
  input.click();
});

/* ---------- Opening balance ---------- */
el('setOpening').addEventListener('click', ()=>{
  const v = Number(el('openingInput').value||0);
  localStorage.setItem(STORAGE_KEYS.OPENING, String(v));
  alert('Opening balance set: ₹' + v.toFixed(2));
});
el('clearOpening').addEventListener('click', ()=>{
  localStorage.removeItem(STORAGE_KEYS.OPENING);
  el('openingInput').value = '';
  alert('Opening cleared');
});

/* ---------- Utility wiring & init ---------- */
function init(){
  // set trash count
  el('trashCount').textContent = trash.length || 0;

  // default view
  showView('dashboard');

  // default invoice init
  initCreateInvoice();

  // load opening if any
  const opening = localStorage.getItem(STORAGE_KEYS.OPENING);
  if(opening) el('openingInput').value = opening;

  // wire recalc when tax changes
  el('taxPct').addEventListener('input', recalcTotals);

  // wire quick add (right panel)
  el('quickAddBtn').addEventListener('click', ()=>{
    const v = Number(el('quickTotal').value||0);
    if(!v) return alert('Enter amount');
    transactions.push({id:'tx_quick_'+Date.now(), type:'income', category:'quick', amount:v, date:new Date().toISOString().slice(0,10), pay:'Cash'});
    saveTransactions(); renderTxTable(); renderDashboard();
    el('quickTotal').value='';
  });

  // export transactions CSV for dashboard button
  el('exportAllCsv').addEventListener('click', ()=> el('downloadTxCsv').click());

  // register downloads for transactions export already done above

  // show invoices table initially
  renderInvoicesTable();
  renderTxTable();
  renderDashboard();
}
init();

/* ---------- Helper: CSV daily EOD backup (download stored daily backup) ---------- */
function exportDailyBackup(date){
  // date: yyyy-mm-dd
  if(!backups[date] || !backups[date].length) return alert('No backups for ' + date);
  const rows = [['invoiceNo','date','customer','pay','total']];
  backups[date].forEach(i=> rows.push([i.invoiceNo,i.date,i.customer,i.pay,i.total]));
  downloadCSV('backup_'+date+'.csv', rows);
}

/* ---------- Helper: small UX niceties ---------- */
document.addEventListener('click', (e)=>{
  // nav automatic: if anchor with data-view clicked -> handled above
});

/* ---------- Small utility to ensure UI stable on load ---------- */
window.addEventListener('load', ()=>{
  // hide sidebar for mobile
  if(window.innerWidth <= 720){
    document.querySelector('.sidebar').style.display = 'none';
  }
});
</script>
</body>
</html>
