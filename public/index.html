<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing Dashboard — JBS KNIT WEAR</title>

<!-- Mobile-first responsive CSS -->
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --accent:#0b79ff; --muted:#6b7280;
    --gap:12px; --radius:12px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#111;background:var(--bg)}
  a{color:var(--accent)}
  .app{display:flex;flex-direction:column;min-height:100%}

  /* Top navigation (mobile first) */
  .topbar{
    display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);box-shadow:0 1px 0 rgba(0,0,0,0.04);
    position:sticky;top:0;z-index:20;
  }
  .brand{font-weight:800;font-size:18px}
  .hamburger{width:40px;height:40px;border-radius:8px;border:0;background:transparent;cursor:pointer}
  .top-actions{margin-left:auto;display:flex;gap:8px;align-items:center}

  /* Layout */
  .container{display:flex;flex:1;gap:18px;padding:18px;box-sizing:border-box}
  .sidebar{
    width:260px;background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(12,17,25,0.04);
    flex-shrink:0;
  }
  .main{flex:1;min-width:0}
  .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(12,17,25,0.04);margin-bottom:18px}
  h1{margin:0 0 6px 0;font-size:22px}
  h2{margin:0 0 12px 0;font-size:18px}

  /* Nav list */
  .nav{display:flex;flex-direction:column;gap:6px}
  .nav button{background:transparent;border:0;padding:10px;border-radius:8px;text-align:left;cursor:pointer;font-size:15px;color:#111}
  .nav button.active{background:linear-gradient(90deg, rgba(11,121,255,0.06), rgba(11,121,255,0.02));border:1px solid rgba(11,121,255,0.06)}

  /* Form controls */
  input,select,textarea{padding:10px;border:1px solid #e6e6e6;border-radius:8px;font-size:15px;box-sizing:border-box}
  button.btn{background:var(--accent);color:white;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid #ddd;padding:8px 12px;border-radius:8px}
  .muted{color:var(--muted)}

  /* summary cards */
  .summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .summary-grid .card{padding:14px}
  .summary-value{font-size:18px;font-weight:700}

  /* tables */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #f0f0f0;text-align:left;font-size:14px}
  th{background:#fafafa}
  .right{text-align:right}

  /* invoice table scroll container */
  .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch}

  /* smaller utilities */
  .flex{display:flex;gap:8px;align-items:center}
  .grow{flex:1}
  .small{font-size:13px}
  .actions{display:flex;gap:8px}

  /* responsive rules for phone */
  @media (max-width:900px) {
    .container{padding:12px;flex-direction:column}
    .sidebar{display:none} /* hide wide sidebar on small screens */
    .summary-grid{grid-template-columns:repeat(1,1fr)}
    h1{font-size:20px}
    .card{padding:12px}
    input,select,textarea{font-size:16px;padding:12px}
    th,td{padding:12px;font-size:15px}
    .topbar{gap:10px;padding:10px}
    .brand{font-size:16px}
    .top-actions .badge{display:none}
    .table-wrap{overflow-x:auto}
  }

  /* desktop extra spacing */
  @media (min-width:901px) {
    .app{min-height:100vh}
  }

  /* small UI niceties */
  .badge{background:#eef6ff;color:var(--accent);padding:8px 10px;border-radius:8px;font-weight:600}
  .form-row{display:flex;gap:12px;align-items:center}
  .form-row .grow{min-width:0}
  .invoice-items td input{width:100%;padding:8px}
  .no-print{display:inline-block}
  @media print{.no-print{display:none}}
</style>
</head>
<body>
  <div class="app">

    <!-- topbar (mobile friendly) -->
    <div class="topbar">
      <button id="hamburger" class="hamburger" aria-label="Open menu">☰</button>
      <div class="brand" id="brandName">JBS KNIT WEAR — Billing</div>

      <div class="top-actions">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="muted small">Opening</div>
          <input id="openingInput" type="number" step="0.01" placeholder="0.00" style="width:110px"/>
          <button id="saveOpeningBtn" class="btn">Set</button>
          <button id="clearOpeningBtn" class="ghost">Clear</button>
        </div>
        <div style="margin-left:8px">
          <span class="badge" id="profitBadge">Profit: ₹0.00</span>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Sidebar (desktop) -->
      <aside class="sidebar card" id="sidebarNav">
        <div class="nav">
          <button data-view="dashboard" class="active">Dashboard <div class="muted small">Quick totals & recent</div></button>
          <button data-view="transactions">Transactions <div class="muted small">Income & expense quick add</div></button>
          <button data-view="create-invoice">Create Invoice <div class="muted small">Add products & save</div></button>
          <button data-view="invoices">Invoices <div class="muted small">Saved invoices list</div></button>
          <button data-view="printable">Printable template <div class="muted small">View / print invoice</div></button>
        </div>
      </aside>

      <!-- Main content -->
      <main class="main">
        <!-- Dashboard -->
        <section class="card view" id="view-dashboard">
          <h1>Billing Dashboard</h1>
          <div class="small muted">Quick overview</div>

          <div style="margin-top:12px" class="summary-grid">
            <div class="card">
              <div class="muted">Total Income</div>
              <div class="summary-value" id="totalIncome">₹0.00</div>
            </div>
            <div class="card">
              <div class="muted">Total Expense</div>
              <div class="summary-value" id="totalExpense">₹0.00</div>
            </div>
            <div class="card">
              <div class="muted">Profit</div>
              <div class="summary-value" id="profit">₹0.00</div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h2>Recent transactions</h2>
            <div class="table-wrap">
              <table id="recentTxTable">
                <thead><tr><th>Date</th><th>Type</th><th>Category</th><th class="right">Amount</th><th>Reference</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Transactions -->
        <section class="card view" id="view-transactions" style="display:none">
          <h2>Add transaction</h2>
          <form id="txForm" style="margin-top:10px">
            <div class="form-row" style="flex-wrap:wrap">
              <select id="txType" style="width:160px">
                <option value="income">Income</option>
                <option value="expense">Expense</option>
              </select>
              <input id="txCategory" placeholder="Category (sales, rent...)" class="grow" />
              <input id="txAmount" placeholder="Amount" type="number" step="0.01" style="width:140px" />
              <input id="txDate" type="date" style="width:160px" />
            </div>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
              <input id="txReference" placeholder="Reference (invoice no)" style="width:240px" />
              <input id="txNotes" placeholder="Notes" class="grow" />
              <button class="btn" type="button" id="txSaveBtn">Save</button>
            </div>
          </form>
        </section>

        <!-- Create Invoice -->
        <section class="card view" id="view-create-invoice" style="display:none">
          <h2>Create Invoice</h2>
          <div class="form-row" style="margin-top:12px;flex-wrap:wrap">
            <input id="invoiceNo" placeholder="Invoice no (auto)" style="width:180px" />
            <input id="invoiceDate" type="date" style="width:180px" />
            <input id="customerName" placeholder="Customer name" class="grow" />
          </div>

          <div class="table-wrap" style="margin-top:12px">
            <table class="invoice-items">
              <thead>
                <tr>
                  <th style="width:4%">S.No</th>
                  <th>Particulars</th>
                  <th style="width:12%">Qty</th>
                  <th style="width:12%">Rate</th>
                  <th style="width:12%">Disc %</th>
                  <th style="width:16%">Amount</th>
                  <th style="width:6%"></th>
                </tr>
              </thead>
              <tbody id="invoiceItems"></tbody>
            </table>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;flex-wrap:wrap;gap:12px">
            <div>
              <button class="btn" id="addItemBtn">+ Add product</button>
              <button class="ghost" id="clearItemsBtn">Clear all</button>
              <button class="ghost" id="recalcBtn">Recalculate amounts</button>
            </div>

            <div style="min-width:220px">
              <div style="display:flex;justify-content:space-between"><div class="muted">Subtotal</div><div id="invSubtotal" class="right">0.00</div></div>
              <div style="display:flex;justify-content:space-between;margin-top:6px">
                <div class="muted">Tax % <input id="invTaxPercent" type="number" value="0" min="0" max="100" style="width:60px;margin-left:8px"/></div>
                <div id="invTaxAmount" class="right">0.00</div>
              </div>
              <div style="display:flex;justify-content:space-between;font-weight:700;margin-top:8px"><div>Total</div><div id="invGrand" class="right">0.00</div></div>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button class="btn" id="saveInvoiceBtn">Save Invoice</button>
            <button class="btn" id="openPrintableBtn" style="background:#2a9d8f">Open Printable</button>
            <div id="invoiceSavedMsg" class="muted"></div>
          </div>
        </section>

        <!-- Invoices list -->
        <section class="card view" id="view-invoices" style="display:none">
          <h2>Saved Invoices</h2>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;flex-wrap:wrap;gap:8px">
            <div style="display:flex;gap:8px;align-items:center">
              <input id="searchInv" placeholder="Search invoice no or customer" style="padding:10px;border:1px solid #ddd;border-radius:8px;width:220px"/>
              <button id="refreshInv" class="ghost">Refresh</button>
            </div>
            <div class="muted">Total: <span id="invCount">0</span></div>
          </div>

          <div style="margin-top:12px" class="table-wrap">
            <table id="invoicesTable">
              <thead><tr><th>ID</th><th>Invoice No</th><th>Date</th><th>Customer</th><th class="right">Total</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- Printable quick view -->
        <section class="card view" id="view-printable" style="display:none">
          <h2>Printable Template</h2>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="printInvoiceId" placeholder="Enter invoice id" style="width:160px" />
            <button class="btn" id="openPrintableDirect">Open Printable</button>
          </div>
          <div class="muted" style="margin-top:8px">Printable opens in a new tab using the printable template.</div>
        </section>
      </main>
    </div>
  </div>

<!-- SCRIPT: keep your app logic (API calls + UI wiring) -->
<script>
/* ---------- SETTINGS / COMPANY ---------- */
const COMPANY = { name: 'JBS KNIT WEAR', addressLine1: '3(2)/2B, Nesavalar Colony 2nd Street, P.N.Road, Tirupur - 641 602.', gstin: '33CKAPJ7513F1ZK' };

/* ---------- SPA nav (hamburger + sidebar) ---------- */
const navButtons = document.querySelectorAll('.nav button[data-view]');
const views = document.querySelectorAll('.view');
const sidebar = document.getElementById('sidebarNav');
const hamburger = document.getElementById('hamburger');

function showView(name){
  views.forEach(v => v.style.display = v.id === 'view-' + name ? 'block' : 'none');
  navButtons.forEach(b => b.classList.toggle('active', b.dataset.view === name));
  // on mobile, close popover sidebar (if visible)
  if(window.innerWidth <= 900) sidebar.style.display = 'none';
}
navButtons.forEach(b => b.addEventListener('click', ()=> showView(b.dataset.view)));
hamburger.addEventListener('click', ()=>{
  // toggle sidebar panel for mobile
  sidebar.style.display = (sidebar.style.display === 'block') ? 'none' : 'block';
});
showView('dashboard');
document.getElementById('brandName').textContent = COMPANY.name + ' — Billing';

/* ---------- API helpers ---------- */
const API = '/api';
async function apiGet(path){ const r = await fetch(API + path); return r.json(); }
async function apiPost(path, p){ const r = await fetch(API + path, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(p)}); return r.json(); }

/* ---------- Opening balance (localStorage) ---------- */
const OPENING_KEY = 'billing_opening_balance';
const openingInput = document.getElementById('openingInput');
const openingDisplay = document.getElementById('profitBadge'); // reusing badge to show profit (compact)
const saveOpeningBtn = document.getElementById('saveOpeningBtn');
const clearOpeningBtn = document.getElementById('clearOpeningBtn');

function loadOpening() {
  const raw = localStorage.getItem(OPENING_KEY);
  if (!raw) return null;
  const val = parseFloat(raw);
  return isNaN(val) ? null : val;
}
function setOpening(value) {
  if (value === null) { localStorage.removeItem(OPENING_KEY); return; }
  localStorage.setItem(OPENING_KEY, String(Number(value).toFixed(2)));
}
saveOpeningBtn.addEventListener('click', () => {
  const v = parseFloat(openingInput.value);
  if (isNaN(v)) return alert('Enter a valid number for opening balance');
  setOpening(v);
  alert('Opening balance set to ₹' + v.toFixed(2));
  loadDashboard();
});
clearOpeningBtn.addEventListener('click', ()=>{ if(!confirm('Clear opening?')) return; setOpening(null); loadDashboard(); });

/* ---------- Dashboard load ---------- */
async function loadDashboard(){
  try{
    const sum = await fetch(API + '/reports/summary').then(r=>r.json());
    const income = sum.income || 0, expense = sum.expense || 0;
    document.getElementById('totalIncome').textContent = '₹' + Number(income).toFixed(2);
    document.getElementById('totalExpense').textContent = '₹' + Number(expense).toFixed(2);
    const profitVal = income - expense;
    document.getElementById('profit').textContent = '₹' + profitVal.toFixed(2);
    document.getElementById('profitBadge').textContent = 'Profit: ₹' + profitVal.toFixed(2);
  }catch(e){ console.warn('summary load failed', e); }

  try{
    const tx = await fetch(API + '/transactions').then(r=>r.json());
    const tbody = document.querySelector('#recentTxTable tbody');
    tbody.innerHTML = '';
    (tx || []).slice(0,8).forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.date}</td><td>${t.type}</td><td>${t.category||''}</td><td class="right">${Number(t.amount||0).toFixed(2)}</td><td>${t.reference||''}</td>`;
      tbody.appendChild(tr);
    });
  }catch(e){ console.warn('recent tx failed', e); }
}

/* ---------- Transactions save ---------- */
document.getElementById('txSaveBtn').addEventListener('click', async ()=>{
  const type = document.getElementById('txType').value;
  const category = document.getElementById('txCategory').value;
  const amount = parseFloat(document.getElementById('txAmount').value) || 0;
  const date = document.getElementById('txDate').value || new Date().toISOString().slice(0,10);
  const reference = document.getElementById('txReference').value;
  const notes = document.getElementById('txNotes').value;
  if (!amount){ alert('Enter amount'); return; }
  const res = await apiPost('/transactions',{type,category,amount,date,reference,notes});
  if (res && res.id){ alert('Saved'); document.getElementById('txForm').reset(); loadDashboard(); } else alert('Save failed: ' + JSON.stringify(res));
});

/* ---------- Invoice logic (rows, calc, save) ---------- */
const invoiceItemsBody = document.getElementById('invoiceItems');

function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function createInvoiceRow(idx, data={}){
  const tr = document.createElement('tr');
  tr.dataset.idx = idx;
  if (data.override) tr.dataset.override = 'true';
  tr.innerHTML = `
    <td>${idx+1}</td>
    <td><input class="inv-desc" placeholder="Product description" value="${escapeHtml(data.description||'')}" /></td>
    <td><input class="inv-qty" type="number" min="0" step="1" value="${data.qty||''}" style="width:100%"/></td>
    <td><input class="inv-rate" type="number" min="0" step="0.01" value="${data.unit_price||''}" style="width:100%"/></td>
    <td><input class="inv-discount" type="number" min="0" max="100" step="0.01" value="${data.discount||0}" style="width:100%"/></td>
    <td class="right"><input class="inv-amount" value="${data.line_total?Number(data.line_total).toFixed(2):''}" style="width:100%"/></td>
    <td><button class="ghost removeItemBtn">x</button></td>
  `;
  const qtyEl = tr.querySelector('.inv-qty');
  const rateEl = tr.querySelector('.inv-rate');
  const discEl = tr.querySelector('.inv-discount');
  const amtEl = tr.querySelector('.inv-amount');

  [qtyEl, rateEl, discEl].forEach(el => el.addEventListener('input', () => {
    if (tr.dataset.override === 'true') return;
    const q = parseFloat(qtyEl.value) || 0;
    const r = parseFloat(rateEl.value) || 0;
    const d = parseFloat(discEl.value) || 0;
    const computed = q * r * (1 - (d/100));
    amtEl.value = computed ? computed.toFixed(2) : '';
    calculateInvoiceTotals();
  }));

  amtEl.addEventListener('input', () => {
    if (amtEl.value.trim() === '') delete tr.dataset.override; else tr.dataset.override = 'true';
    calculateInvoiceTotals();
  });

  tr.querySelector('.removeItemBtn').addEventListener('click', ()=>{
    tr.remove(); reindexInvoiceRows(); calculateInvoiceTotals();
  });

  return tr;
}

function reindexInvoiceRows(){ const rows = invoiceItemsBody.querySelectorAll('tr'); rows.forEach((r,i)=> r.querySelector('td').textContent = i+1); }
function addInvoiceRow(data){ invoiceItemsBody.appendChild(createInvoiceRow(invoiceItemsBody.querySelectorAll('tr').length, data)); }
function clearInvoiceRows(){ invoiceItemsBody.innerHTML=''; for(let i=0;i<6;i++) addInvoiceRow(); calculateInvoiceTotals(); }

function calculateInvoiceTotals(){
  const rows = invoiceItemsBody.querySelectorAll('tr');
  let subtotal = 0;
  rows.forEach(r=>{
    const qty = parseFloat(r.querySelector('.inv-qty').value) || 0;
    const rate = parseFloat(r.querySelector('.inv-rate').value) || 0;
    const disc = parseFloat(r.querySelector('.inv-discount').value) || 0;
    const amtInput = r.querySelector('.inv-amount');
    let amt = 0;
    if (r.dataset.override === 'true') { amt = parseFloat(amtInput.value) || 0; }
    else { amt = qty * rate * (1 - (disc/100)); amtInput.value = amt ? amt.toFixed(2) : ''; }
    subtotal += amt;
  });
  const taxPerc = parseFloat(document.getElementById('invTaxPercent').value) || 0;
  const taxAmt = subtotal * (taxPerc/100);
  const grand = subtotal + taxAmt;
  document.getElementById('invSubtotal').textContent = subtotal.toFixed(2);
  document.getElementById('invTaxAmount').textContent = taxAmt.toFixed(2);
  document.getElementById('invGrand').textContent = grand.toFixed(2);
}

document.getElementById('addItemBtn').addEventListener('click', ()=> addInvoiceRow());
document.getElementById('clearItemsBtn').addEventListener('click', ()=> { if(confirm('Clear all items?')) clearInvoiceRows(); });
document.getElementById('invTaxPercent').addEventListener('input', calculateInvoiceTotals);
document.getElementById('recalcBtn').addEventListener('click', ()=> {
  document.querySelectorAll('#invoiceItems tr').forEach(tr => { delete tr.dataset.override; });
  calculateInvoiceTotals();
});

document.getElementById('saveInvoiceBtn').addEventListener('click', async ()=>{
  const items = [];
  const rows = invoiceItemsBody.querySelectorAll('tr');
  rows.forEach(r=>{
    const desc = r.querySelector('.inv-desc').value.trim();
    const qty = parseFloat(r.querySelector('.inv-qty').value) || 0;
    const rate = parseFloat(r.querySelector('.inv-rate').value) || 0;
    const discount = parseFloat(r.querySelector('.inv-discount').value) || 0;
    const amount = parseFloat(r.querySelector('.inv-amount').value) || 0;
    if (desc || qty || rate || amount) {
      items.push({ description: desc || 'Item', qty: Math.round(qty), unit_price: parseFloat(rate.toFixed(2)), discount: parseFloat(discount.toFixed(2)), line_total: parseFloat(amount.toFixed(2)) });
    }
  });
  if (!items.length){ alert('Add at least one product'); return; }
  const payload = {
    invoice_no: document.getElementById('invoiceNo').value || undefined,
    date: document.getElementById('invoiceDate').value || new Date().toISOString().slice(0,10),
    customer_name: document.getElementById('customerName').value || '',
    subtotal: parseFloat(document.getElementById('invSubtotal').textContent) || 0,
    tax: parseFloat(document.getElementById('invTaxAmount').textContent) || 0,
    total: parseFloat(document.getElementById('invGrand').textContent) || 0,
    notes: '',
    items
  };
  const res = await apiPost('/invoices', payload);
  if (res && (res.id || (res.invoice && res.invoice.id))) {
    const id = res.id || (res.invoice && res.invoice.id);
    document.getElementById('invoiceSavedMsg').innerHTML = `Saved invoice id ${id}. <a href="/invoice-template.html?id=${id}" target="_blank">Open printable</a>`;
    if (res.invoice_no) document.getElementById('invoiceNo').value = res.invoice_no;
    loadInvoicesList(); loadDashboard();
  } else alert('Save failed: ' + JSON.stringify(res));
});

/* Open printable (from Create Invoice panel) */
document.getElementById('openPrintableBtn').addEventListener('click', ()=>{
  const msg = document.getElementById('invoiceSavedMsg').textContent || '';
  const m = msg.match(/Saved invoice id (\d+)/);
  const idToOpen = m ? m[1] : prompt('Enter invoice id to open printable:');
  if (idToOpen) window.open('/invoice-template.html?id=' + encodeURIComponent(idToOpen), '_blank');
});

/* ---------- Invoices list ---------- */
async function loadInvoicesList(){
  const q = document.getElementById('searchInv').value.trim();
  let url = '/api/invoices';
  if (q) url += '?q=' + encodeURIComponent(q);
  const list = await fetch(url).then(r=>r.json());
  const tbody = document.querySelector('#invoicesTable tbody');
  tbody.innerHTML = '';
  (list||[]).forEach(inv=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${inv.id}</td><td>${inv.invoice_no||''}</td><td>${inv.date||''}</td><td>${inv.customer_name||inv.customer||''}</td><td class="right">${inv.total!==undefined?Number(inv.total).toFixed(2):''}</td><td><button class="ghost openInv" data-id="${inv.id}">Open</button> <button class="ghost printInv" data-id="${inv.id}">Print</button> <button class="ghost delInv" data-id="${inv.id}" style="background:#ffecec">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('invCount').textContent = (list||[]).length;

  document.querySelectorAll('.openInv').forEach(b=>b.addEventListener('click', e=>{ const id = e.target.dataset.id; window.location.href = '/invoice-template.html?id=' + encodeURIComponent(id); }));
  document.querySelectorAll('.printInv').forEach(b=>b.addEventListener('click', e=>{ const id = e.target.dataset.id; window.open('/invoice-template.html?id=' + encodeURIComponent(id), '_blank'); }));
  document.querySelectorAll('.delInv').forEach(b=>b.addEventListener('click', async e=>{ const id = e.target.dataset.id; if (!confirm('Delete invoice #'+id+' ?')) return; const resp = await fetch('/api/invoices/' + id, { method: 'DELETE' }); const j = await resp.json(); if (resp.ok) loadInvoicesList(); else alert('Delete failed: ' + JSON.stringify(j)); }));
}

/* ---------- Printable ---------- */
document.getElementById('openPrintableDirect').addEventListener('click', ()=>{ const id = document.getElementById('printInvoiceId').value.trim(); if (!id) return alert('Enter invoice id'); window.open('/invoice-template.html?id=' + encodeURIComponent(id), '_blank'); });

/* ---------- Day report print (uses opening value) ---------- */
function isoDate(d){ const dt = new Date(d); return dt.toISOString().slice(0,10); }
async function fetchSummaryRange(from,to){ const url = `/api/reports/summary${from && to ? `?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}` : ''}`; const r = await fetch(url); if (!r.ok) throw new Error('Failed to fetch summary'); return r.json(); }
async function fetchTransactionsRange(from,to){ const url = `/api/transactions?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`; const r = await fetch(url); if (!r.ok) throw new Error('Failed to fetch transactions'); return r.json(); }
function formatCurrency(n){ return '₹' + Number(n || 0).toFixed(2); }

async function buildAndPrintDayReport(){
  try{
    const today = new Date(); const todayStr = isoDate(today); const yesterday = new Date(today); yesterday.setDate(yesterday.getDate()-1); const yesterdayStr = isoDate(yesterday);
    let openingValue = loadOpening();
    if (openingValue === null) {
      const openingSummary = await fetchSummaryRange('1970-01-01', yesterdayStr);
      openingValue = (openingSummary.income || 0) - (openingSummary.expense || 0);
    }
    const todaySummary = await fetchSummaryRange(todayStr,todayStr);
    const todayIncome = todaySummary.income || 0;
    const todayExpense = todaySummary.expense || 0;
    const closingBalance = openingValue + todayIncome - todayExpense;
    const txs = await fetchTransactionsRange(todayStr,todayStr);

    const reportHtml = `<!doctype html><html><head><meta charset="utf-8"><title>Day Report — ${todayStr}</title><style>body{font-family:Arial;padding:18px;color:#111}table{width:100%;border-collapse:collapse;margin-top:8px}th,td{padding:8px;border:1px solid #eee}th{background:#fafafa}.right{text-align:right}</style></head><body><h1>${COMPANY.name}</h1><div>Day Report — <strong>${todayStr}</strong></div><div style="margin-top:12px"><strong>Opening:</strong> ${formatCurrency(openingValue)} | <strong>Income:</strong> ${formatCurrency(todayIncome)} | <strong>Expense:</strong> ${formatCurrency(todayExpense)} | <strong>Closing:</strong> ${formatCurrency(closingBalance)}</div><h2 style="margin-top:12px">Transactions</h2><table><thead><tr><th>#</th><th>Date</th><th>Type</th><th>Category</th><th class="right">Amount</th><th>Reference</th></tr></thead><tbody>${(txs || []).map((t,i)=>`<tr><td>${i+1}</td><td>${t.date||''}</td><td>${t.type||''}</td><td>${t.category||''}</td><td class="right">${formatCurrency(t.amount)}</td><td>${t.reference||''}</td></tr>`).join('')}</tbody></table><div style="margin-top:18px"><button onclick="window.print()" style="padding:8px 12px;background:#0b79ff;color:#fff;border:none;border-radius:6px">Print</button></div></body></html>`;

    const w = window.open('', '_blank', 'width=900,height=800'); w.document.open(); w.document.write(reportHtml); w.document.close(); w.focus(); setTimeout(()=>{ try{ w.print(); } catch(e){ console.warn('print', e); } }, 600);

  } catch(err) { alert('Day report failed: ' + (err.message || err)); console.error(err); }
}
document.getElementById('saveOpeningBtn').addEventListener('click', ()=>{}); // already wired earlier
document.getElementById('saveOpeningBtn').addEventListener('click', ()=>{}); // keep duplicate safe
document.getElementById('saveOpeningBtn').addEventListener('click', ()=>{}); // no-op guard

/* ---------- Reset (forgiving check) ---------- */
const resetBtn = document.getElementById('resetDataBtn');
if (!resetBtn) {
  // if reset button not present in mobile header, create small control in console
  // (we won't show a destructive reset by default on mobile topbar)
}
if (window.location.hash === '#open-create') showView('create-invoice');

/* ---------- Init ---------- */
function initInvoiceFormDefaults(){ document.getElementById('invoiceDate').value = new Date().toISOString().slice(0,10); clearInvoiceRows(); document.getElementById('invoiceNo').value = ''; }
function clearInvoiceRows(){ invoiceItemsBody.innerHTML=''; for(let i=0;i<6;i++) addInvoiceRow(); calculateInvoiceTotals(); }
function addInvoiceRow(data){ invoiceItemsBody.appendChild(createInvoiceRow(invoiceItemsBody.querySelectorAll('tr').length, data)); }

loadDashboard();
loadInvoicesList();
initInvoiceFormDefaults();
calculateInvoiceTotals();
navButtons.forEach(b => b.addEventListener('click', () => { if (b.dataset.view === 'dashboard') loadDashboard(); if (b.dataset.view === 'invoices') loadInvoicesList(); }));
</script>
</body>
</html>
