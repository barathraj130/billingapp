<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Billing — JBS KNIT WEAR</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  /* ---------- Reset & base ---------- */
  :root{
    --bg:#f4f6f8;
    --panel:#ffffff;
    --muted:#9aa3ad;
    --accent:#1677ff;
    --radius:12px;
    --shadow: 0 8px 22px rgba(17,24,39,0.06);
    --max:1100px;
    --sidebar-w:260px;
    --gap:20px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:#111827;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }
  a{color:var(--accent);text-decoration:none}
  button{cursor:pointer}
  input,button,select,textarea{font-family:inherit}

  /* ---------- Layout ---------- */
  .app{
    display:flex;
    min-height:100vh;
  }
  .sidebar{
    width:var(--sidebar-w);
    background:linear-gradient(180deg,#fff, #fbfcfd);
    padding:28px 18px;
    box-shadow: inset -1px 0 0 rgba(0,0,0,0.03);
  }
  .brand{font-weight:800;font-size:18px;margin-bottom:6px}
  .brand-sub{color:var(--muted);font-size:12px;margin-bottom:18px}

  .nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .nav button{
    display:flex;flex-direction:column;align-items:flex-start;padding:12px 14px;border-radius:8px;border:1px solid transparent;background:transparent;color:#111827;font-weight:600;
  }
  .nav button.small{font-weight:500;color:var(--muted);font-size:13px}
  .nav button.active{background:linear-gradient(90deg,#f7fbff,#fff);border-color:#e6f0ff;box-shadow:var(--shadow);outline:2px solid rgba(22,119,255,0.08)}

  .sidebar .hint{margin-top:18px;color:var(--muted);font-size:13px}
  .sidebar .hint .muted{display:block;margin-top:8px}
  .sidebar .smallbtn{display:inline-block;padding:8px 10px;border-radius:8px;border:1px solid #ebf0f6;background:#fff;margin-right:10px;margin-top:10px}
  .trash-count{display:inline-block;margin-top:10px;color:var(--muted);font-size:13px}

  .main{
    flex:1;padding:24px;max-width:calc(100% - var(--sidebar-w));min-width:0;
  }

  .topbar{
    display:flex;justify-content:flex-end;align-items:center;gap:10px;margin-bottom:18px;
  }
  .opening{display:inline-flex;gap:8px;align-items:center}
  .opening input{width:120px;padding:10px;border-radius:8px;border:1px solid #e7edf3;background:#fff}

  /* ---------- Card ---------- */
  .card{
    background:var(--panel);
    border-radius:var(--radius);
    padding:22px;
    box-shadow:var(--shadow);
  }
  .layout{
    display:grid;
    grid-template-columns: 1fr 380px;
    gap:24px;
    align-items:start;
  }

  /* ---------- Dashboard ---------- */
  h1{margin:0;font-size:28px}
  h2{margin:0;font-size:20px}
  .kpi-row{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
  .stat{background:#fff;border-radius:12px;padding:18px;min-width:220px;flex:1;box-shadow:var(--shadow)}
  .stat .label{color:var(--muted);font-size:13px}
  .stat .value{font-weight:800;font-size:20px;margin-top:8px}

  /* ---------- Form / Invoice ---------- */
  .form-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .form-row .wide{flex:1;min-width:160px}
  input[type="text"], input[type="number"], input[type="date"], select{
    width:100%;padding:10px;border-radius:8px;border:1px solid #e7edf3;background:#fff;
  }
  .btn{
    display:inline-block;padding:10px 14px;border-radius:9px;border:1px solid transparent;background:var(--accent);color:#fff;font-weight:700;
  }
  .btn.ghost{background:#fff;border:1px solid #e7edf3;color:#111827}
  .btn.warn{background:#ff6b51}

  .products{margin-top:18px}
  .prod-row{
    display:grid;
    grid-template-columns: 48px 1fr 70px 90px 70px 60px;
    gap:12px;
    align-items:center;
    padding:12px;border-radius:10px;border:1px solid #eef3f7;margin-bottom:12px;
  }
  .prod-row .no{text-align:center;color:var(--muted);font-weight:700}
  .prod-row input.prod-desc{padding:10px;border-radius:8px;border:1px solid #eef3f7;background:#fff}
  .prod-row input.q, .prod-row input.rate, .prod-row input.disc{width:70px;padding:8px;border-radius:8px;border:1px solid #eef3f7}
  .prod-row .amount{text-align:right;font-weight:700}

  .invoice-summary{margin-top:18px;display:flex;justify-content:flex-end;gap:14px;align-items:center;flex-wrap:wrap}
  .summary-col{text-align:right}

  /* ---------- Invoices table ---------- */
  .table{width:100%;border-collapse:collapse;margin-top:16px}
  .table th{background:#fff;padding:14px;border-radius:8px 8px 0 0;text-align:left}
  .table td{background:#fff;padding:12px;border-top:1px solid #f1f4f6}

  /* ---------- Transactions ---------- */
  .tx-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tx-controls input[type="date"]{width:150px}
  .download{background:#16a34a;color:#fff;padding:8px 12px;border-radius:8px}

  /* ---------- Printable template styles (preview window uses simplified CSS) ---------- */

  /* ---------- Responsive ---------- */
  @media (max-width:980px){
    .layout{grid-template-columns:1fr; }
    .main{padding:16px}
    .sidebar{position:fixed;left:0;top:0;height:100vh;z-index:30;transform:translateX(0);width:220px}
    body.show-sidebar .sidebar{transform:translateX(0)}
  }
  @media (max-width:640px){
    .sidebar{width:64px;padding:12px}
    .nav button{padding:8px}
    .brand{display:none}
    .layout{padding:8px}
    .topbar{justify-content:space-between}
  }
  /* small helper */
  .muted{color:var(--muted);font-size:13px}
  .right{margin-left:auto}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">JBS KNIT WEAR — <span style="font-weight:600">Billing</span></div>
    <div class="brand-sub">Simple billing for retail</div>

    <nav class="nav" id="nav">
      <button data-view="dashboard" class="active">Dashboard <span class="small muted">Quick totals & recent</span></button>
      <button data-view="transactions">Transactions <span class="small muted">Income & expense add</span></button>
      <button data-view="create">Create Invoice <span class="small muted">Add products & save</span></button>
      <button data-view="invoices">Invoices <span class="small muted">Saved invoices list</span></button>
      <button data-view="printable">Printable template <span class="small muted">View / print invoice</span></button>
    </nav>

    <div class="hint">
      Tip: Save then Print from invoice view.
      <div class="muted" style="margin-top:10px">Export backup before major changes</div>
      <div style="margin-top:10px">
        <button class="smallbtn" id="btnExportBackup">Export backup</button>
        <button class="smallbtn" id="btnImportBackup">Import</button>
      </div>
      <div style="margin-top:10px">
        <button class="smallbtn" id="btnTrash">Trash (<span id="trashCount">0</span>)</button>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="opening">
        <div class="muted">Opening balance (today)</div>
        <input id="openingInput" type="number" step="0.01" placeholder="0.00"/>
        <button class="btn ghost" id="setOpening">Set</button>
        <button class="btn ghost" id="clearOpening">Clear</button>
      </div>
    </div>

    <!-- Views container -->
    <div id="views">
      <!-- Dashboard -->
      <section id="view-dashboard" class="card" style="display:block;">
        <div style="display:flex;align-items:center;gap:20px;">
          <h1>Billing Dashboard</h1>
          <div class="muted" style="margin-left:auto;">Quick overview of today's totals and recent activity</div>
        </div>

        <div class="kpi-row">
          <div class="stat">
            <div class="label">Total Income (GPay + Cash)</div>
            <div id="kpi-income" class="value">₹0.00</div>
          </div>
          <div class="stat">
            <div class="label">Total Expense</div>
            <div id="kpi-expense" class="value">₹0.00</div>
          </div>
          <div class="stat">
            <div class="label">Cash remaining (opening + cash sales - cash expenses)</div>
            <div id="kpi-cash" class="value">₹0.00</div>
          </div>

          <div class="card" style="margin-left:auto;min-width:320px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <h2 style="font-size:18px;margin:0">Recent transactions</h2>
              <button class="download" id="exportTxAll">Export CSV</button>
            </div>

            <table class="table" id="recentTxTable" style="min-width:100%">
              <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Amount</th></tr></thead>
              <tbody><tr><td colspan="4" class="muted">No recent transactions</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Transactions -->
      <section id="view-transactions" class="card" style="display:none;margin-top:20px">
        <h1>Transactions</h1>
        <div class="muted">Quick add income & expense</div>

        <div style="margin-top:14px" class="card" id="txPanel">
          <div class="tx-controls" style="margin-bottom:8px">
            <select id="txType">
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
            <input id="txCategory" placeholder="Category (e.g. Sale, Rent)"/>
            <input id="txAmount" type="number" step="0.01" placeholder="Amount"/>
            <input id="txDate" type="date"/>
            <select id="txPay">
              <option value="cash">Cash</option>
              <option value="gpay">GPay</option>
            </select>
            <button class="btn" id="addTxBtn">Add</button>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
            <input id="filterFrom" type="date"/>
            <input id="filterTo" type="date"/>
            <select id="filterType"><option value="all">All</option><option value="income">Income</option><option value="expense">Expense</option></select>
            <button class="btn ghost" id="filterBtn">Filter</button>
            <button class="btn ghost" id="clearFilter">Clear</button>
            <button class="download right" id="exportTxFiltered">Download CSV</button>
          </div>

          <table class="table" id="txTable">
            <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Pay</th><th>Amount</th><th>Actions</th></tr></thead>
            <tbody><tr><td colspan="6" class="muted">No transactions added</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- Create Invoice -->
      <section id="view-create" class="card" style="display:none;margin-top:20px">
        <h1>Create Invoice</h1>
        <div class="muted">Add products & save</div>

        <div style="margin-top:16px">
          <div class="form-row">
            <input id="invNo" class="wide" type="text" placeholder="Invoice no (auto)" />
            <input id="invDate" type="date" />
            <input id="invCustomer" class="wide" type="text" placeholder="Customer name"/>
          </div>

          <div style="margin-top:12px" class="form-row">
            <label class="muted">Payment Method</label>
            <select id="invPay" style="width:160px;padding:8px;border-radius:8px;border:1px solid #e7edf3;">
              <option value="cash">Cash</option><option value="gpay">GPay</option>
            </select>

            <div style="margin-left:auto">
              <button class="btn ghost" id="addProduct">+ Add</button>
              <button class="btn ghost" id="clearProducts">Clear</button>
              <button class="btn ghost" id="recalc">Recalc</button>
            </div>
          </div>

          <div class="products" id="products"></div>

          <div style="display:flex;justify-content:flex-end;align-items:center;margin-top:18px">
            <div style="text-align:right;margin-right:20px">
              <div class="muted">Subtotal:</div>
              <div class="muted">Tax %:</div>
              <div style="font-weight:800;font-size:20px">Total</div>
            </div>
            <div style="text-align:right">
              <div id="invSubtotal">₹0.00</div>
              <div><input id="invTax" type="number" value="0" style="width:80px;padding:8px;border-radius:8px;border:1px solid #eef3f7"/></div>
              <div id="invTotal" style="font-weight:800;font-size:20px">₹0.00</div>
            </div>
          </div>

          <div style="margin-top:22px">
            <button class="btn" id="saveInvoice">Save</button>
            <button class="btn ghost" id="printInvoice">Print</button>
            <button class="btn warn" id="resetInvoice">Reset</button>
          </div>
        </div>
      </section>

      <!-- Invoices list -->
      <section id="view-invoices" class="card" style="display:none;margin-top:20px">
        <h1>Invoices</h1>
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <input id="searchInvoice" placeholder="Search invoice / customer" style="padding:10px;border-radius:8px;border:1px solid #eef3f7;flex:1"/>
          <button class="btn ghost" id="btnExportAllCSV">Export CSV (all)</button>
          <button class="btn ghost" id="btnExportCash">Export Cash</button>
          <button class="btn ghost" id="btnExportGpay">Export GPay</button>
        </div>

        <table class="table" style="margin-top:14px" id="invoicesTable">
          <thead><tr><th>Invoice</th><th>Date</th><th>Customer</th><th>Pay</th><th>Total</th><th>Actions</th></tr></thead>
          <tbody><tr><td colspan="6" class="muted">No invoices</td></tr></tbody>
        </table>
      </section>

      <!-- Printable template -->
      <section id="view-printable" class="card" style="display:none;margin-top:20px">
        <h1>Printable template</h1>
        <div style="margin-top:14px;display:flex;gap:8px;align-items:center;">
          <select id="printSelect"></select>
          <button class="btn" id="openPrintable">Open</button>
        </div>
      </section>
    </div>
  </main>
</div>

<script>
/*
  billing-app frontend single file
  - storage keys
*/
const STORAGE_INVOICES = 'billingapp_invoices_v1';
const STORAGE_TX = 'billingapp_transactions_v1';
const STORAGE_TRASH = 'billingapp_trash_v1';
const STORAGE_OPENING = 'billingapp_opening_v1';
/* ---------- Utilities ---------- */
function money(v){ return '₹' + Number(v||0).toFixed(2); }
function uuid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
function loadJSON(k, fallback){ try{ const raw=localStorage.getItem(k); return raw?JSON.parse(raw):fallback; }catch(e){return fallback} }
function saveJSON(k,val){ localStorage.setItem(k, JSON.stringify(val)); }

/* ---------- App state ---------- */
let invoices = loadJSON(STORAGE_INVOICES, []); // array of invoice objects
let transactions = loadJSON(STORAGE_TX, []); // array of tx objects
let trash = loadJSON(STORAGE_TRASH, []);
let opening_balance = Number(localStorage.getItem(STORAGE_OPENING) || 0);

/* ---------- Helpers ---------- */
function setActiveView(name){
  document.querySelectorAll('#views > section').forEach(s=>s.style.display='none');
  const view = document.getElementById('view-'+name);
  if(view) view.style.display='block';
  // nav active
  document.querySelectorAll('.nav button').forEach(b=> b.classList.toggle('active', b.dataset.view===name));
  // if create and small screen, scroll to view
  if(window.innerWidth < 900 && name==='create'){
    window.scrollTo({top:document.getElementById('view-create').offsetTop - 60, behavior:'smooth'});
  }
  refreshAll();
}

/* ---------- Init nav ---------- */
document.querySelectorAll('.nav button').forEach(btn=>{
  btn.addEventListener('click', ()=> setActiveView(btn.dataset.view));
});

/* ---------- Opening balance ---------- */
document.getElementById('openingInput').value = opening_balance || '';
document.getElementById('setOpening').addEventListener('click', ()=>{
  opening_balance = Number(document.getElementById('openingInput').value || 0);
  localStorage.setItem(STORAGE_OPENING, opening_balance);
  alert('Opening balance set: ₹' + opening_balance.toFixed(2));
  refreshAll();
});
document.getElementById('clearOpening').addEventListener('click', ()=>{
  opening_balance = 0; document.getElementById('openingInput').value=''; localStorage.removeItem(STORAGE_OPENING); refreshAll();
});

/* ---------- Dashboard render ---------- */
function renderDashboard(){
  // totals
  const inc = invoices.filter(i=>i.total>0).reduce((s,i)=>s + Number(i.total || 0), 0);
  const expenses = transactions.filter(t=>t.type==='expense').reduce((s,t)=>s + Number(t.amount||0), 0);
  // cash remaining = opening + cash income - cash expenses
  const cashIncome = invoices.filter(i=>i.pay==='cash').reduce((s,i)=>s + Number(i.total||0), 0);
  const cashExpense = transactions.filter(t=>t.type==='expense' && t.pay==='cash').reduce((s,t)=>s + Number(t.amount||0), 0);
  const cashRemaining = opening_balance + cashIncome - cashExpense;

  document.getElementById('kpi-income').innerText = money(inc);
  document.getElementById('kpi-expense').innerText = money(expenses);
  document.getElementById('kpi-cash').innerText = money(cashRemaining);

  // recent transactions
  const recent = transactions.slice().sort((a,b)=> new Date(b.date) - new Date(a.date)).slice(0,6);
  const tbody = document.querySelector('#recentTxTable tbody'); tbody.innerHTML='';
  if(!recent.length){ tbody.innerHTML = '<tr><td colspan="4" class="muted">No recent transactions</td></tr>'; return; }
  recent.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.type}</td><td>${r.category||''}</td><td>${money(r.amount)}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- Transactions ---------- */
function renderTxTable(list){
  const tbody = document.querySelector('#txTable tbody'); tbody.innerHTML='';
  if(!list.length){ tbody.innerHTML = '<tr><td colspan="6" class="muted">No transactions added</td></tr>'; return; }
  list.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${t.date}</td><td>${t.type}</td><td>${t.category}</td><td>${t.pay}</td><td>${money(t.amount)}</td>
      <td>
        <button data-id="${t.id}" class="btn ghost btn-edit-tx">Edit</button>
        <button data-id="${t.id}" class="btn warn btn-delete-tx">Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
  // hooks
  document.querySelectorAll('.btn-delete-tx').forEach(b=> b.addEventListener('click', e=>{
    const id=b.dataset.id;
    if(confirm('Delete transaction?')) {
      transactions = transactions.filter(x=>x.id!==id);
      saveJSON(STORAGE_TX, transactions);
      refreshAll();
    }
  }));
}
document.getElementById('addTxBtn').addEventListener('click', ()=>{
  const type = document.getElementById('txType').value;
  const category = document.getElementById('txCategory').value || (type==='income'?'Misc':'Expense');
  const amount = Number(document.getElementById('txAmount').value || 0);
  const date = document.getElementById('txDate').value || todayISO();
  const pay = document.getElementById('txPay').value || 'cash';
  if(!amount){ alert('Enter amount'); return; }
  const tx = { id: uuid(), type, category, amount, date, pay };
  transactions.push(tx); saveJSON(STORAGE_TX, transactions); refreshAll();
  // clear inputs
  document.getElementById('txAmount').value=''; document.getElementById('txCategory').value='';
});
document.getElementById('filterBtn').addEventListener('click', ()=>{
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const type = document.getElementById('filterType').value;
  let list = transactions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(type!=='all') list = list.filter(x=>x.type===type);
  if(from) list = list.filter(x=> new Date(x.date) >= new Date(from));
  if(to) list = list.filter(x=> new Date(x.date) <= new Date(to));
  renderTxTable(list);
});
document.getElementById('clearFilter').addEventListener('click', ()=>{
  document.getElementById('filterFrom').value='';document.getElementById('filterTo').value='';document.getElementById('filterType').value='all';
  renderTxTable(transactions.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)));
});

/* ---------- Export transactions CSV ---------- */
function downloadCSV(filename, rows){
  if(!rows || !rows.length){ alert('No rows to export'); return; }
  const keys = Object.keys(rows[0]);
  const lines = [keys.join(',')];
  rows.forEach(r=>{
    lines.push(keys.map(k=>{
      let v = r[k]===undefined || r[k]===null ? '' : String(r[k]);
      // escape
      if(v.includes(',') || v.includes('"')) v = '"' + v.replace(/"/g,'""') + '"';
      return v;
    }).join(','));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}
document.getElementById('exportTxAll').addEventListener('click', ()=>{
  if(!transactions.length){ alert('No transactions'); return; }
  downloadCSV(`transactions_all_${todayISO()}.csv`, transactions);
});
document.getElementById('exportTxFiltered').addEventListener('click', ()=>{
  // use filter inputs to generate filtered list
  const from = document.getElementById('filterFrom').value;
  const to = document.getElementById('filterTo').value;
  const type = document.getElementById('filterType').value;
  let list = transactions.slice();
  if(type!=='all') list = list.filter(x=>x.type===type);
  if(from) list = list.filter(x=> new Date(x.date) >= new Date(from));
  if(to) list = list.filter(x=> new Date(x.date) <= new Date(to));
  if(!list.length){ alert('No transactions'); return; }
  downloadCSV(`transactions_filtered_${todayISO()}.csv`, list);
});

/* ---------- Invoices: product UI ---------- */
function makeProductRow(idx, item){
  // item: {desc, qty, rate, disc}
  const div = document.createElement('div'); div.className='prod-row';
  div.dataset.idx = idx;
  const no = document.createElement('div'); no.className='no no-wrap no-select no'; no.innerText = idx+1;
  const desc = document.createElement('input'); desc.className='prod-desc'; desc.placeholder='Product description'; desc.value = (item && item.desc) || '';
  const qty = document.createElement('input'); qty.type='number'; qty.className='q'; qty.value=(item && item.qty) || 0; qty.min=0;
  const rate = document.createElement('input'); rate.type='number'; rate.className='rate'; rate.value=(item && item.rate) || 0; rate.min=0;
  const disc = document.createElement('input'); disc.type='number'; disc.className='disc'; disc.value=(item && item.disc) || 0; disc.min=0;
  const amount = document.createElement('div'); amount.className='amount'; amount.innerText = money((item && (item.qty*item.rate*(1 - (Number(item.disc||0)/100)))) || 0);

  const btnDel = document.createElement('button'); btnDel.className='btn ghost'; btnDel.innerText='x';
  btnDel.addEventListener('click', ()=> {
    // remove this row
    const container = document.getElementById('products');
    container.removeChild(div);
    refreshProductIndex();
    recalcInvoice();
  });

  // listeners
  [qty,rate,disc,desc].forEach(inp=>inp.addEventListener('input', () => {
    amount.innerText = money(Number(qty.value || 0) * Number(rate.value || 0) * (1 - (Number(disc.value||0)/100)));
    recalcInvoice();
  }));

  div.appendChild(no);
  div.appendChild(desc);
  div.appendChild(qty);
  div.appendChild(rate);
  div.appendChild(disc);
  div.appendChild(amount);
  div.appendChild(btnDel);
  return div;
}
function refreshProductIndex(){
  const rows = Array.from(document.querySelectorAll('.prod-row'));
  rows.forEach((r,i)=> r.querySelector('.no').innerText = i+1);
}
function recalcInvoice(){
  const rows = Array.from(document.querySelectorAll('.prod-row'));
  let subtotal = 0;
  const prodData = rows.map(r=>{
    const desc = r.querySelector('.prod-desc').value || '';
    const qty = Number(r.querySelector('.q').value || 0);
    const rate = Number(r.querySelector('.rate').value || 0);
    const disc = Number(r.querySelector('.disc').value || 0);
    const amt = qty * rate * (1 - disc/100);
    subtotal += amt;
    r.querySelector('.amount').innerText = money(amt);
    return {desc, qty, rate, disc, amount:amt};
  });
  const taxPct = Number(document.getElementById('invTax').value || 0);
  const tax = subtotal * (taxPct/100);
  const total = subtotal + tax;
  document.getElementById('invSubtotal').innerText = money(subtotal);
  document.getElementById('invTotal').innerText = money(total);
  return {subtotal, tax, total, prodData};
}

/* product buttons */
document.getElementById('addProduct').addEventListener('click', ()=>{
  const container = document.getElementById('products');
  const idx = container.children.length;
  const row = makeProductRow(idx, {desc:'', qty:0, rate:0, disc:0});
  container.appendChild(row);
});
document.getElementById('clearProducts').addEventListener('click', ()=>{
  if(!confirm('Clear all products?')) return;
  document.getElementById('products').innerHTML='';
  recalcInvoice();
});
document.getElementById('recalc').addEventListener('click', recalcInvoice);
document.getElementById('invTax').addEventListener('input', recalcInvoice);

/* ---------- Save / Print invoice ---------- */
function newInvoiceObject(){
  const id = uuid();
  const invNo = document.getElementById('invNo').value || (invoices.length + 1).toString();
  const date = document.getElementById('invDate').value || todayISO();
  const customer = document.getElementById('invCustomer').value || '';
  const pay = document.getElementById('invPay').value || 'cash';
  const calc = recalcInvoice();
  return {
    id, invNo, date, customer, pay,
    products: calc.prodData,
    subtotal: calc.subtotal,
    tax: calc.tax,
    total: calc.total
  };
}
document.getElementById('saveInvoice').addEventListener('click', ()=>{
  const invoice = newInvoiceObject();
  invoices.push(invoice); saveJSON(STORAGE_INVOICES, invoices);
  alert('Invoice saved');
  refreshAll(); // update UI lists
});
document.getElementById('printInvoice').addEventListener('click', ()=>{
  const invoice = newInvoiceObject();
  openPrintableWindow(invoice);
});
document.getElementById('resetInvoice').addEventListener('click', ()=>{
  if(!confirm('Reset invoice form?')) return;
  document.getElementById('products').innerHTML=''; document.getElementById('invSubtotal').innerText = money(0); document.getElementById('invTotal').innerText = money(0);
});

/* print window generation */
function openPrintableWindow(invoice){
  // if invoice param not passed, try to get selected from list
  if(!invoice && invoices && invoices.length){
    invoice = invoices[0];
  }
  const win = window.open('about:blank','_blank');
  const html = printableHtml(invoice);
  win.document.open();
  win.document.write(html);
  win.document.close();
  // auto print
  setTimeout(()=>{ win.print(); }, 300);
}

/* build printable HTML (portrait) */
function printableHtml(inv){
  // header fixed company details
  const company = {
    name: 'JBS KNIT WEAR',
    address: '3(2)/2B, Nesavalar Colony 2nd Street, P.N.Road, Tirupur - 641 602.',
    gst: '33CKAPJ7513F1ZK',
    phone: '97919 02205'
  };
  const rows = (inv && inv.products) ? inv.products : [];
  const rowsHtml = rows.map((r,i)=>`<tr>
    <td style="padding:6px;border:1px solid #ddd;text-align:center;width:40px">${i+1}</td>
    <td style="padding:6px;border:1px solid #ddd">${escapeHtml(r.desc)}</td>
    <td style="padding:6px;border:1px solid #ddd;text-align:center;width:60px">${r.qty}</td>
    <td style="padding:6px;border:1px solid #ddd;text-align:right;width:90px">${Number(r.rate||0).toFixed(2)}</td>
    <td style="padding:6px;border:1px solid #ddd;text-align:right;width:110px">${Number(r.amount||0).toFixed(2)}</td>
  </tr>`).join('\n');

  const total = Number(inv ? inv.total : 0).toFixed(2);
  // simple CSS for print
  return `<!doctype html><html><head><meta charset="utf-8"><title>Invoice</title>
    <style>
      @page { size: portrait; margin: 18mm; }
      body{font-family:Arial, Helvetica, sans-serif;font-size:12px;color:#111}
      .header{display:flex;justify-content:space-between;align-items:flex-start}
      h1{margin:0;font-size:22px}
      .company{font-weight:700}
      table{border-collapse:collapse;width:100%;margin-top:14px}
      th{background:#f7f7f7;padding:6px;border:1px solid #ddd}
      td{padding:6px;border:1px solid #ddd}
      .right{text-align:right}
      .footer{margin-top:24px}
    </style>
  </head><body>
    <div class="header">
      <div>
        <div class="company">${company.name}</div>
        <div>${company.address}</div>
        <div>GSTIN: ${company.gst}</div>
        <div>Ph: ${company.phone}</div>
      </div>
      <div style="text-align:right">
        <div>Date: ${inv ? inv.date : ''}</div>
        <div>Invoice ID: ${inv ? inv.invNo : ''}</div>
        <div>Customer: ${escapeHtml(inv ? inv.customer : '')}</div>
        <div>Payment: ${inv ? inv.pay : ''}</div>
      </div>
    </div>

    <table>
      <thead><tr><th style="width:40px">#</th><th>Product</th><th style="width:60px">Qty</th><th style="width:90px">Rate</th><th style="width:110px">Amount</th></tr></thead>
      <tbody>
        ${rowsHtml}
        <tr><td colspan="3"></td><td style="text-align:right;font-weight:700">Total:</td><td style="text-align:right;font-weight:700">${total}</td></tr>
      </tbody>
    </table>

    <div class="footer">
      <div>Payment: ${inv ? inv.pay : ''}</div>
    </div>
  </body></html>`;
}

function escapeHtml(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- Invoices list rendering ---------- */
function renderInvoices(){
  const tbody = document.querySelector('#invoicesTable tbody'); tbody.innerHTML='';
  if(!invoices.length){ tbody.innerHTML = '<tr><td colspan="6" class="muted">No invoices</td></tr>'; return; }
  invoices.slice().reverse().forEach(inv=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${inv.invNo}</td><td>${inv.date}</td><td>${escapeHtml(inv.customer)}</td><td>${inv.pay}</td><td>${money(inv.total)}</td>
      <td>
        <button class="btn ghost btn-open" data-id="${inv.id}">Open</button>
        <button class="btn ghost btn-print" data-id="${inv.id}">Print</button>
        <button class="btn warn btn-delete" data-id="${inv.id}">Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
  // hooks
  document.querySelectorAll('.btn-open').forEach(b=>b.addEventListener('click', ()=> {
    const id=b.dataset.id; const inv = invoices.find(x=>x.id===id);
    if(!inv) return alert('Invoice not found');
    // open printable view in tab
    const h = printableHtml(inv);
    const w = window.open('about:blank','_blank'); w.document.open(); w.document.write(h); w.document.close();
  }));
  document.querySelectorAll('.btn-print').forEach(b=>b.addEventListener('click', ()=> {
    const id=b.dataset.id; const inv = invoices.find(x=>x.id===id);
    if(!inv) return alert('Invoice not found');
    openPrintableWindow(inv);
  }));
  document.querySelectorAll('.btn-delete').forEach(b=>b.addEventListener('click', ()=> {
    const id=b.dataset.id;
    if(!confirm('Delete invoice? It will be moved to Trash (recoverable).')) return;
    const [deleted] = invoices.filter(x=>x.id===id);
    invoices = invoices.filter(x=>x.id!==id);
    trash.push(deleted);
    saveJSON(STORAGE_INVOICES, invoices); saveJSON(STORAGE_TRASH, trash);
    refreshAll();
  }));
}

/* ---------- Printable select ---------- */
function refreshPrintableSelect(){
  const sel = document.getElementById('printSelect'); sel.innerHTML='';
  if(!invoices.length){ sel.innerHTML='<option>No invoices</option>'; return; }
  invoices.slice().reverse().forEach(inv=>{
    const opt=document.createElement('option'); opt.value=inv.id; opt.innerText = `${inv.invNo} — ${inv.date} — ${inv.customer||''}`; sel.appendChild(opt);
  });
}
document.getElementById('openPrintable').addEventListener('click', ()=>{
  const id = document.getElementById('printSelect').value;
  const inv = invoices.find(x=>x.id===id);
  if(!inv) return alert('select invoice');
  const h = printableHtml(inv);
  const w = window.open('about:blank','_blank'); w.document.open(); w.document.write(h); w.document.close();
});

/* ---------- Backup / Import / Trash ---------- */
document.getElementById('btnExportBackup').addEventListener('click', ()=>{
  const data = { invoices, transactions, trash, opening_balance };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `billing-backup-${todayISO()}.json`; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('btnImportBackup').addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.addEventListener('change', (ev)=>{
    const f = ev.target.files[0]; if(!f) return;
    const reader = new FileReader(); reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(!confirm('This will replace current data with backup. Continue?')) return;
        invoices = data.invoices || []; transactions = data.transactions || []; trash = data.trash || []; opening_balance = data.opening_balance || 0;
        saveJSON(STORAGE_INVOICES, invoices); saveJSON(STORAGE_TX, transactions); saveJSON(STORAGE_TRASH, trash); localStorage.setItem(STORAGE_OPENING, opening_balance);
        alert('Backup imported');
        refreshAll();
      }catch(e){ alert('Import failed: '+e.message) }
    };
    reader.readAsText(f);
  });
  input.click();
});
document.getElementById('btnTrash').addEventListener('click', ()=>{
  // simple trash viewer
  const list = trash.map((t,i)=>`${i+1}. ${t.invNo} — ${t.date} — ${t.customer} — ${money(t.total)}`).join('\\n') || 'Trash empty';
  if(!trash.length) return alert('Trash empty');
  if(!confirm('Recover last trashed invoice?')) return;
  const item = trash.pop();
  invoices.push(item);
  saveJSON(STORAGE_TRASH, trash); saveJSON(STORAGE_INVOICES, invoices); refreshAll();
});

/* ---------- Export CSV (invoices) ---------- */
function invoicesToRows(list){
  return list.map(inv=>{
    return {
      id: inv.id,
      invNo: inv.invNo,
      date: inv.date,
      customer: inv.customer,
      pay: inv.pay,
      subtotal: inv.subtotal,
      tax: inv.tax,
      total: inv.total,
      products: inv.products.map(p=>`${p.desc}|${p.qty}|${p.rate}|${p.disc}|${p.amount}`).join(';')
    };
  });
}
document.getElementById('btnExportAllCSV').addEventListener('click', ()=>{
  if(!invoices.length) return alert('No invoices');
  downloadCSV(`invoices_all_${todayISO()}.csv`, invoicesToRows(invoices));
});
document.getElementById('btnExportCash').addEventListener('click', ()=>{
  const list = invoices.filter(i=>i.pay==='cash');
  if(!list.length) return alert('No cash invoices');
  downloadCSV(`invoices_cash_${todayISO()}.csv`, invoicesToRows(list));
});
document.getElementById('btnExportGpay').addEventListener('click', ()=>{
  const list = invoices.filter(i=>i.pay==='gpay');
  if(!list.length) return alert('No GPay invoices');
  downloadCSV(`invoices_gpay_${todayISO()}.csv`, invoicesToRows(list));
});

/* ---------- Search invoices ---------- */
document.getElementById('searchInvoice').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  const list = invoices.filter(i=> String(i.invNo).toLowerCase().includes(q) || (i.customer||'').toLowerCase().includes(q));
  const tbody = document.querySelector('#invoicesTable tbody'); tbody.innerHTML='';
  if(!list.length){ tbody.innerHTML = '<tr><td colspan="6" class="muted">No invoices</td></tr>'; return; }
  list.slice().reverse().forEach(inv=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${inv.invNo}</td><td>${inv.date}</td><td>${escapeHtml(inv.customer)}</td><td>${inv.pay}</td><td>${money(inv.total)}</td>
      <td>
        <button class="btn ghost btn-open" data-id="${inv.id}">Open</button>
        <button class="btn ghost btn-print" data-id="${inv.id}">Print</button>
        <button class="btn warn btn-delete" data-id="${inv.id}">Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
});

/* ---------- Persist / initial rendering ---------- */
function refreshAll(){
  // update trash count
  document.getElementById('trashCount').innerText = trash.length;
  // dashboard
  renderDashboard();
  // transactions table
  renderTxTable(transactions.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)));
  // invoices
  renderInvoices();
  refreshPrintableSelect();
  // create invoice form default date
  document.getElementById('invDate').value = document.getElementById('invDate').value || todayISO();
  // ensure at least 4 product rows
  const container = document.getElementById('products');
  if(container.children.length === 0){
    for(let i=0;i<4;i++){ container.appendChild(makeProductRow(i, {desc:'', qty:0, rate:0, disc:0})); }
  }
  recalcInvoice();
}

/* ---------- onload ---------- */
window.addEventListener('load', ()=>{
  // initialize opening input
  document.getElementById('openingInput').value = opening_balance || '';
  // make sure invoice number default
  document.getElementById('invNo').placeholder = (invoices.length + 1).toString();
  // wire printable open handler
  refreshAll();
});

/* ---------- Utility: download CSV function already above ---------- */

/* ---------- Final note: when you want server persistence ---------- */
/* If you'd like server-backed persistence (SQLite/Postgres), I can provide a small Express server that exposes REST endpoints and stores invoices in the DB. */
</script>
</body>
</html>
