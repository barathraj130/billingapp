<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Invoice — JBS KNIT WEAR</title>

<!-- html2canvas + jsPDF CDN (for Download PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body{font-family: "Helvetica Neue", Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px}
  .print-wrapper{max-width:900px;margin:12px auto}
  .controls{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px}
  .btn{background:#0b79ff;color:#fff;padding:8px 12px;border:0;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.ghost{background:#fff;color:#0b79ff;border:1px solid #dfe9ff}
  .print-container{background:#fff;padding:18px;border:1px solid #222;box-sizing:border-box}
  .inv-header{text-align:center;margin-bottom:10px}
  .inv-header h1{margin:0;font-size:28px;letter-spacing:1px}
  .inv-addr{font-size:13px;color:#222;margin-top:6px}
  .meta{display:flex;justify-content:space-between;margin:12px 0;font-size:14px}
  .meta .left,.meta .right{width:48%}
  .meta .right{text-align:right}
  table.items{width:100%;border-collapse:collapse;margin-top:8px}
  table.items th, table.items td{border:1px solid #000;padding:8px;font-size:13px}
  table.items th{background:#f6f6f6}
  .totals{display:flex;justify-content:flex-end;margin-top:12px}
  .totals .box{width:320px}
  .totals .line{display:flex;justify-content:space-between;padding:6px 0}
  .invoice-photo{max-width:100%;height:auto;border:1px solid #eee;border-radius:6px;margin-top:8px;cursor:pointer}
  .small-muted{font-size:12px;color:#666}
  .center{text-align:center}
  @media print {
    body{background:#fff}
    .controls{display:none}
    .print-container{border:none}
  }
</style>
</head>
<body>
  <div class="print-wrapper">
    <div class="controls no-print">
      <button id="downloadPdfBtn" class="btn">Download PDF</button>
      <button id="printBtn" class="btn ghost" onclick="window.print()">Print</button>
    </div>

    <div id="printArea" class="print-container">
      <div class="inv-header">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div style="text-align:left">
            <div style="font-weight:700">JAMES</div>
            <div class="small-muted">Ph : 97919 02205</div>
          </div>
          <div style="flex:1"></div>
          <div style="text-align:right"></div>
        </div>

        <h1 id="companyName">JBS KNIT WEAR</h1>
        <div class="inv-addr" id="companyAddr">3(2)/2B, Nesavalar Colony 2nd Street, P.N.Road, Tirupur - 641 602.</div>
        <div style="font-weight:700;margin-top:6px">GSTIN NUMBER: <span id="companyGST">33CKAPJ7513F1ZK</span></div>
      </div>

      <hr />

      <div class="meta">
        <div class="left">
          <div><strong>No:</strong> <span id="invoiceNo">—</span></div>
          <div style="margin-top:6px"><strong>To M/s:</strong> <span id="customerName">—</span></div>
          <div class="small-muted" style="margin-top:8px" id="customerAddr"></div>
        </div>
        <div class="right">
          <div><strong>Date:</strong> <span id="invoiceDate">—</span></div>
          <div style="margin-top:6px"><strong>Reference:</strong> <span id="invoiceRef">—</span></div>
          <div style="margin-top:6px" class="small-muted">Printed: <span id="printedAt"></span></div>
        </div>
      </div>

      <table class="items" id="itemsTable">
        <thead>
          <tr><th style="width:6%">S.No</th><th>Particulars</th><th style="width:10%">Qty</th><th style="width:12%">Rate (Rs)</th><th style="width:12%">Discount</th><th style="width:14%">Amount (Rs)</th></tr>
        </thead>
        <tbody id="itemsBody">
          <!-- rows inserted here -->
        </tbody>
      </table>

      <div class="totals" style="margin-top:18px">
        <div class="box">
          <div class="line"><div class="small-muted">Subtotal:</div><div id="subtotal">₹0.00</div></div>
          <div class="line"><div class="small-muted">Tax:</div><div id="taxTotal">₹0.00</div></div>
          <div class="line" style="font-weight:800;font-size:16px"><div>Total:</div><div id="grandTotal">₹0.00</div></div>
        </div>
      </div>

      <div style="margin-top:40px;display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div>Rupees: <span id="inWords">Rupees Only</span></div>
        </div>
        <div style="text-align:right">
          <div>For <strong id="companyShort">JBS KNIT WEAR</strong></div>
          <div style="margin-top:40px">Authorized Signatory</div>
        </div>
      </div>

      <div id="photoWrap" style="margin-top:10px"></div>
    </div>
  </div>

<script>
(async function(){
  function qs(name){ const p = new URLSearchParams(location.search); return p.get(name); }
  const id = qs('id');

  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  if (!id) {
    document.getElementById('itemsBody').innerHTML = '<tr><td colspan="6" class="small-muted center">No invoice id provided.</td></tr>';
    return;
  }

  // robust fetch: try multiple endpoints and show diagnostics
  async function fetchInvoiceById(id) {
    const tries = [
      `/api/invoices/${encodeURIComponent(id)}`,
      `/api/invoice/${encodeURIComponent(id)}`,
      `/invoices/${encodeURIComponent(id)}`,
      `/api/invoices?id=${encodeURIComponent(id)}`
    ];
    let lastError = null;
    for (const url of tries) {
      try {
        console.info('Trying invoice URL:', url);
        const r = await fetch(url, {cache: 'no-store'});
        if (r.ok) {
          const json = await r.json();
          return { url, data: json };
        } else {
          const txt = await r.text().catch(()=> '');
          lastError = { url, status: r.status, text: txt };
          console.warn('Attempt failed', lastError);
        }
      } catch (err) {
        lastError = { url, err: err.message || String(err) };
        console.error('Fetch error', lastError);
      }
    }
    return { error: lastError || {msg: 'unknown'} };
  }

  const probe = await fetchInvoiceById(id);
  if (probe.error) {
    const err = probe.error;
    console.error('Invoice load failed:', err);
    document.getElementById('itemsBody').innerHTML =
      `<tr><td colspan="6" class="small-muted center">Failed to load invoice: ${escapeHtml(err.status ? 'Invoice not found ('+err.status+')' : (err.err || err.text || JSON.stringify(err)) )}</td></tr>`;
    const meta = document.getElementById('invoiceRef');
    if (meta) meta.textContent = (err.url ? `Tried: ${err.url}` : 'No URL attempted');
    return;
  }

  const data = probe.data;
  // adapt if server wrapped invoice (common shapes)
  const inv = data.invoice || data.data || data || {};
  // If list returned (query style) and first element exists
  if (Array.isArray(inv) && inv.length) inv = inv[0];

  document.getElementById('invoiceNo').textContent = inv.invoice_no || inv.id || '—';
  document.getElementById('invoiceDate').textContent = inv.date || inv.created_at || '';
  document.getElementById('invoiceRef').textContent = inv.reference || inv.reference_no || '';
  document.getElementById('customerName').textContent = inv.customer_name || inv.customer || '—';
  document.getElementById('companyName').textContent = inv.company_name || 'JBS KNIT WEAR';
  document.getElementById('companyAddr').textContent = inv.company_address || '3(2)/2B, Nesavalar Colony 2nd Street, P.N.Road, Tirupur - 641 602.';
  document.getElementById('companyGST').textContent = inv.company_gst || '33CKAPJ7513F1ZK';
  document.getElementById('printedAt').textContent = new Date().toLocaleString();

  const items = inv.items || [];
  const tbody = document.getElementById('itemsBody');
  tbody.innerHTML = '';
  if (!items.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="small-muted center">No items</td></tr>';
  } else {
    items.forEach((it,i)=>{
      const qty = Number(it.qty || it.quantity || 0);
      const rate = Number(it.unit_price || it.rate || 0);
      const discount = it.discount || 0;
      const line = Number(it.line_total || it.amount || (qty * rate * (1 - (discount/100))) || 0).toFixed(2);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="center">${i+1}</td>
        <td>${escapeHtml(it.description || it.particulars || '')}</td>
        <td class="center">${qty}</td>
        <td class="right">${rate.toFixed(2)}</td>
        <td class="right">${discount}${discount ? '%' : ''}</td>
        <td class="right">${line}</td>`;
      tbody.appendChild(tr);
    });
  }

  const subtotal = Number(inv.subtotal || items.reduce((s,it)=> s + Number(it.line_total || it.amount || 0),0)) || 0;
  const taxTotal = Number(inv.tax || 0);
  const grand = Number(inv.total || subtotal + taxTotal) || 0;
  document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);
  document.getElementById('taxTotal').textContent = '₹' + taxTotal.toFixed(2);
  document.getElementById('grandTotal').textContent = '₹' + grand.toFixed(2);
  document.getElementById('inWords').textContent = toWordsIndian(Math.round(grand)) + ' only';

  if (inv.photo_url || inv.image) {
    const wrap = document.getElementById('photoWrap');
    const img = document.createElement('img');
    img.className = 'invoice-photo';
    img.src = inv.photo_url || inv.image;
    img.alt = 'Invoice photo';
    wrap.appendChild(img);
  }

  function toWordsIndian(num){
    if (!Number.isFinite(num)) return '';
    const digits = ['', 'one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
    const tens = ['', '', 'twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
    function inWords(n){
      if (n<20) return digits[n];
      if (n<100) return tens[Math.floor(n/10)] + (n%10 ? ' '+digits[n%10] : '');
      if (n<1000) return digits[Math.floor(n/100)] + ' hundred' + (n%100 ? ' and ' + inWords(n%100) : '');
      return '';
    }
    let n = num;
    const crore = Math.floor(n/10000000); n%=10000000;
    const lakh = Math.floor(n/100000); n%=100000;
    const thousand = Math.floor(n/1000); n%=1000;
    const hundreds = n;
    let parts = [];
    if (crore) parts.push(inWords(crore) + ' crore');
    if (lakh) parts.push(inWords(lakh) + ' lakh');
    if (thousand) parts.push(inWords(thousand) + ' thousand');
    if (hundreds) parts.push(inWords(hundreds));
    if (!parts.length) return 'Zero';
    const s = parts.join(' ');
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  /* ---------- PDF download logic ---------- */
  document.getElementById('downloadPdfBtn').addEventListener('click', async function(){
    const btn = this;
    btn.disabled = true;
    btn.textContent = 'Preparing...';
    try { await exportElementToPDF('#printArea', `invoice-${encodeURIComponent(id)}.pdf`); }
    catch (e){ alert('PDF export failed: '+(e.message||e)); console.error(e); }
    finally { btn.disabled = false; btn.textContent = 'Download PDF'; }
  });

  async function exportElementToPDF(selector, filename){
    const el = document.querySelector(selector);
    if (!el) throw new Error('Printable element not found');
    const scale = 2;
    const canvas = await html2canvas(el, { scale: scale, useCORS:true, logging:false, windowWidth:el.scrollWidth, windowHeight:el.scrollHeight });
    const imgData = canvas.toDataURL('image/jpeg', 0.98);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const pxToMm = px => px * 25.4 / 96;
    const imgWidthMm = pxToMm(canvas.width);
    const imgHeightMm = pxToMm(canvas.height);
    const ratio = pageWidth / imgWidthMm;
    let y = 0;
    pdf.addImage(imgData, 'JPEG', 0, y, pageWidth, imgHeightMm * ratio);
    let heightLeft = imgHeightMm * ratio - pageHeight;
    while (heightLeft > 0) {
      pdf.addPage();
      y = - (pageHeight) * ( ( (imgHeightMm * ratio) - heightLeft) / (imgHeightMm * ratio) );
      pdf.addImage(imgData, 'JPEG', 0, y, pageWidth, imgHeightMm * ratio);
      heightLeft -= pageHeight;
    }
    pdf.save(filename);
  }

  // clickable image to open full size
  document.addEventListener('click', function (e) {
    const t = e.target;
    if (t.classList && t.classList.contains('invoice-photo')) {
      const src = t.getAttribute('src') || t.dataset.src;
      if (src) window.open(src, '_blank');
    }
  });

})();
</script>
</body>
</html>
